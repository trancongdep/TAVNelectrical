<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Ki·ªÉm Tra Ph·ªëi H·ª£p B·∫£o V·ªá CB (Selectivity)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a73e8; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; font-style: italic; margin-bottom: 30px; }
        
        .control-panel { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
        .cb-box { flex: 1; min-width: 300px; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        
        /* M√†u s·∫Øc ph√¢n bi·ªát c·∫•p */
        .cb-box.main { border-top: 5px solid #d93025; background-color: #fff8f8; } /* ƒê·ªè - T·ªïng */
        .cb-box.branch { border-top: 5px solid #188038; background-color: #f6fcf7; } /* Xanh - Nh√°nh */
        
        h3 { margin-top: 0; display: flex; align-items: center; gap: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em; color: #444; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        select:focus, input:focus { border-color: #1a73e8; outline: none; }

        .result-section { text-align: center; padding: 20px; border-top: 2px dashed #ddd; }
        .status-badge { display: inline-block; padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 1.3em; margin-bottom: 15px; width: 80%; }
        
        .pass { background-color: #e6f4ea; color: #137333; border-left: 5px solid #137333; }
        .fail { background-color: #fce8e6; color: #c5221f; border-left: 5px solid #c5221f; }
        .warning { background-color: #fef7e0; color: #b06000; border-left: 5px solid #b06000; }

        .chart-container { position: relative; height: 400px; width: 100%; border: 1px solid #eee; background: white; margin-top: 20px; border-radius: 8px; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .legend { display: flex; justify-content: center; gap: 20px; font-size: 0.85em; margin-top: 15px; }
        .dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; vertical-align: middle; }
        
        .explanation { text-align: left; background: #e8f0fe; padding: 20px; border-radius: 8px; margin-top: 15px; font-size: 0.95em; line-height: 1.6; border-left: 4px solid #1a73e8; }

        /* Button Styles */
        .btn-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn { padding: 15px 30px; border: none; border-radius: 50px; cursor: pointer; font-size: 1.1em; font-weight: bold; transition: 0.3s; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-run { background: #1a73e8; }
        .btn-run:hover { background: #155db5; transform: translateY(-2px); }
        .btn-excel { background: #188038; }
        .btn-excel:hover { background: #10662a; transform: translateY(-2px); }

    </style>
</head>
<body>

<div class="container">
    <h1>‚ö° Tool Ki·ªÉm Tra Ph·ªëi H·ª£p B·∫£o V·ªá (Selectivity)</h1>
    <p class="subtitle">M√¥ ph·ªèng ƒë∆∞·ªùng cong ƒë·∫∑c t√≠nh TCC theo chu·∫©n IEC & Xu·∫•t b√°o c√°o</p>

    <div class="control-panel">
        <div class="cb-box main">
            <h3>üî¥ CB T·ªïng (Ngu·ªìn)</h3>
            <div class="form-group">
                <label>Lo·∫°i thi·∫øt b·ªã:</label>
                <select id="mainType" onchange="toggleDelayOption()">
                    <option value="MCCB">MCCB (Aptomat kh·ªëi)</option>
                    <option value="MCB" selected>MCB (Aptomat t√©p)</option>
                    <option value="ACB">ACB (M√°y c·∫Øt kh√¥ng kh√≠)</option>
                </select>
            </div>
            <div class="form-group">
                <label>D√≤ng ƒë·ªãnh m·ª©c (In) [A]:</label>
                <input type="number" id="mainIn" value="100" min="10">
            </div>
            <div class="form-group">
                <label>ƒê·∫∑c tuy·∫øn t·ª´ (Curve Type):</label>
                <select id="mainCurve">
                    <option value="C">Curve C (5-10 In) - Ph·ªï th√¥ng</option>
                    <option value="D">Curve D (10-20 In) - T·∫£i ƒë·ªông c∆° l·ªõn</option>
                    <option value="K">Curve K (8-12 In) - Motor</option>
                    <option value="MA">Curve MA (12 In) - B∆°m PCCC (Ch·ªâ t·ª´)</option>
                </select>
            </div>
            <div class="form-group" id="delayGroup" style="display:none;">
                <label>‚è±Ô∏è Tr·ªÖ ng·∫Øn m·∫°ch (Short Time Delay):</label>
                <select id="mainDelay">
                    <option value="0">0s (C·∫Øt nhanh)</option>
                    <option value="0.1">0.1s (100ms)</option>
                    <option value="0.2">0.2s (200ms)</option>
                    <option value="0.4">0.4s (400ms)</option>
                </select>
            </div>
        </div>

        <div class="cb-box branch">
            <h3>üü¢ CB Nh√°nh (T·∫£i)</h3>
            <div class="form-group">
                <label>Lo·∫°i thi·∫øt b·ªã:</label>
                <select id="branchType" disabled>
                    <option value="MCB" selected>MCB (Aptomat t√©p)</option>
                </select>
            </div>
            <div class="form-group">
                <label>D√≤ng ƒë·ªãnh m·ª©c (In) [A]:</label>
                <input type="number" id="branchIn" value="32" min="1">
            </div>
            <div class="form-group">
                <label>ƒê·∫∑c tuy·∫øn t·ª´ (Curve Type):</label>
                <select id="branchCurve">
                    <option value="Z">Curve Z (2-3 In) - M·∫°ch PLC/CNC</option>
                    <option value="B">Curve B (3-5 In) - ƒê√®n/·ªî c·∫Øm</option>
                    <option value="C" selected>Curve C (5-10 In) - Motor nh·ªè</option>
                    <option value="D">Curve D (10-20 In) - M√°y h√†n/Bi·∫øn √°p</option>
                </select>
            </div>
        </div>
    </div>

    <div class="result-section">
        <div class="btn-group">
            <button onclick="checkSelectivity()" class="btn btn-run">‚ñ∂ CH·∫†Y M√î PH·ªéNG</button>
            <button onclick="exportToExcel()" class="btn btn-excel">üìä XU·∫§T EXCEL</button>
        </div>
        
        <div id="resultOutput" style="margin-top: 30px;">
            </div>

        <div class="chart-container">
            <canvas id="tccCanvas"></canvas>
            <div style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 5px; border: 1px solid #ccc; font-size: 0.8em;">Log-Log Scale Simulation</div>
        </div>
        <div class="legend">
            <span><span class="dot" style="background: red;"></span>ƒê·∫∑c tuy·∫øn CB T·ªïng</span>
            <span><span class="dot" style="background: green;"></span>ƒê·∫∑c tuy·∫øn CB Nh√°nh</span>
            <span><span class="dot" style="background: orange;"></span>V√πng ch·ªìng l·∫•n (M·∫•t ch·ªçn l·ªçc)</span>
        </div>
    </div>
</div>

<script>
    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ k·∫øt qu·∫£ cho vi·ªác xu·∫•t Excel
    let currentResult = {
        status: "",
        message: "Ch∆∞a ch·∫°y m√¥ ph·ªèng",
        details: ""
    };

    function toggleDelayOption() {
        const type = document.getElementById('mainType').value;
        const delayGroup = document.getElementById('delayGroup');
        if(type === 'MCCB' || type === 'ACB') {
            delayGroup.style.display = 'block';
        } else {
            delayGroup.style.display = 'none';
            document.getElementById('mainDelay').value = "0";
        }
    }

    function checkSelectivity() {
        // 1. L·∫•y d·ªØ li·ªáu Input
        const mainIn = parseFloat(document.getElementById('mainIn').value);
        const branchIn = parseFloat(document.getElementById('branchIn').value);
        const mainType = document.getElementById('mainType').value;
        const mainCurve = document.getElementById('mainCurve').value;
        const branchCurve = document.getElementById('branchCurve').value;
        const timeDelay = parseFloat(document.getElementById('mainDelay').value || 0);

        const resultDiv = document.getElementById('resultOutput');
        
        const getImRange = (curve, In) => {
            switch(curve) {
                case 'Z': return { min: 2 * In, max: 3 * In };
                case 'B': return { min: 3 * In, max: 5 * In };
                case 'C': return { min: 5 * In, max: 10 * In };
                case 'K': return { min: 10 * In, max: 14 * In }; 
                case 'D': return { min: 10 * In, max: 20 * In };
                case 'MA': return { min: 12 * In, max: 12 * In }; 
                default: return { min: 5 * In, max: 10 * In };
            }
        };

        const mainIm = getImRange(mainCurve, mainIn);
        const branchIm = getImRange(branchCurve, branchIn);

        // 3. Logic Ki·ªÉm tra Ph·ªëi h·ª£p
        let status = "";
        let message = "";
        let details = "";
        let selectivityType = "NONE"; 

        let warningMA = "";
        if (mainCurve === 'MA') warningMA = "<br>‚ö†Ô∏è L∆∞u √Ω: CB T·ªïng lo·∫°i MA kh√¥ng b·∫£o v·ªá qu√° t·∫£i, c·∫ßn l·∫Øp th√™m R∆°-le nhi·ªát.";

        if (branchIn >= mainIn) {
            status = "fail";
            message = "‚ùå KH√îNG ƒê·∫†T";
            details = `D√≤ng CB Nh√°nh (${branchIn}A) l·ªõn h∆°n ho·∫∑c b·∫±ng CB T·ªïng (${mainIn}A). H·ªá th·ªëng v√¥ l√Ω.`;
        } else {
            const ratio = mainIn / branchIn;
            
            if (ratio < 1.6) {
                status = "fail";
                message = "‚ö†Ô∏è C·∫¢NH B√ÅO: Kho·∫£ng c√°ch d√≤ng h·∫πp";
                details = `T·ª∑ l·ªá In T·ªïng/Nh√°nh l√† ${ratio.toFixed(1)}. Khuy·∫øn ngh·ªã t·ªëi thi·ªÉu l√† 1.6 l·∫ßn.${warningMA}`;
            } else {
                if ((mainType === 'MCCB' || mainType === 'ACB') && timeDelay > 0) {
                    status = "pass";
                    message = "‚úÖ ƒê·∫†T: CH·ªåN L·ªåC TO√ÄN PH·∫¶N";
                    details = `CB T·ªïng c√≥ c√†i ƒë·∫∑t tr·ªÖ th·ªùi gian (${timeDelay}s). Khi ng·∫Øn m·∫°ch, CB Nh√°nh s·∫Ω c·∫Øt tr∆∞·ªõc.${warningMA}`;
                    selectivityType = "TOTAL";
                } else {
                    if (mainIm.min <= branchIm.max) {
                         status = "warning";
                         message = "‚ö†Ô∏è CH·ªåN L·ªåC M·ªòT PH·∫¶N";
                         details = `T·∫°i v√πng d√≤ng ng·∫Øn m·∫°ch l·ªõn (t·ª´ ${mainIm.min}A ƒë·∫øn ${branchIm.max}A), c·∫£ 2 CB c√≥ th·ªÉ nh·∫£y c√πng l√∫c. <br>Nguy√™n nh√¢n: Curve ${mainCurve} ph√≠a tr√™n Curve ${branchCurve}.${warningMA}`;
                         selectivityType = "PARTIAL";
                    } else {
                        status = "pass";
                        message = "‚úÖ ƒê·∫†T: Ch·ªçn l·ªçc Ampe";
                        details = `Ng∆∞·ª°ng c·∫Øt t·ª´ c·ªßa CB T·ªïng (${mainIm.min}A) n·∫±m xa ng∆∞·ª°ng c·ªßa CB Nh√°nh (${branchIm.max}A). An to√†n.${warningMA}`;
                        selectivityType = "TOTAL";
                    }
                }
            }
        }

        // L∆∞u k·∫øt qu·∫£ ƒë·ªÉ xu·∫•t Excel
        currentResult = {
            status: status,
            message: message,
            details: details.replace(/<br>/g, "\n").replace(/<b>/g, "").replace(/<\/b>/g, "")
        };

        // Render K·∫øt qu·∫£
        let badgeClass = status === 'pass' ? 'pass' : (status === 'fail' ? 'fail' : 'warning');
        resultDiv.innerHTML = `
            <div class="status-badge ${badgeClass}">${message}</div>
            <div class="explanation">${details}</div>
        `;

        // V·∫Ω bi·ªÉu ƒë·ªì
        drawTCC(mainIn, branchIn, mainIm.min, branchIm.max, timeDelay, selectivityType, mainCurve);
    }

    // --- H√ÄM XU·∫§T EXCEL ---
    function exportToExcel() {
        // Ki·ªÉm tra xem ƒë√£ ch·∫°y m√¥ ph·ªèng ch∆∞a
        if (currentResult.status === "") {
            alert("Vui l√≤ng nh·∫•n 'CH·∫†Y M√î PH·ªéNG' tr∆∞·ªõc khi xu·∫•t b√°o c√°o!");
            return;
        }

        // L·∫•y gi√° tr·ªã hi·ªán t·∫°i
        const mainIn = document.getElementById('mainIn').value;
        const branchIn = document.getElementById('branchIn').value;
        const mainType = document.getElementById('mainType').value;
        const mainCurve = document.getElementById('mainCurve').value;
        const branchCurve = document.getElementById('branchCurve').value;
        const timeDelay = document.getElementById('mainDelay').value;

        // T·∫°o d·ªØ li·ªáu cho file Excel
        const data = [
            ["B√ÅO C√ÅO KI·ªÇM TRA PH·ªêI H·ª¢P B·∫¢O V·ªÜ (SELECTIVITY CHECK)"],
            ["Ng√†y t·∫°o:", new Date().toLocaleString('vi-VN')],
            [],
            ["1. TH√îNG S·ªê THI·∫æT B·ªä"],
            ["H·∫°ng m·ª•c", "CB T·ªïng (Ngu·ªìn)", "CB Nh√°nh (T·∫£i)"],
            ["Lo·∫°i thi·∫øt b·ªã", mainType, "MCB"],
            ["D√≤ng ƒë·ªãnh m·ª©c (In)", `${mainIn} A`, `${branchIn} A`],
            ["ƒê·∫∑c tuy·∫øn (Curve)", `Curve ${mainCurve}`, `Curve ${branchCurve}`],
            ["Th·ªùi gian tr·ªÖ (Time Delay)", `${timeDelay} s`, "0 s (Instant)"],
            [],
            ["2. K·∫æT QU·∫¢ ƒê√ÅNH GI√Å"],
            ["Tr·∫°ng th√°i:", currentResult.message],
            ["Chi ti·∫øt k·ªπ thu·∫≠t:", currentResult.details],
            [],
            ["3. GHI CH√ö"],
            ["Tool ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n ti√™u chu·∫©n IEC 60947-2 v√† IEC 60898."],
            ["Bi·ªÉu ƒë·ªì TCC ƒë∆∞·ª£c m√¥ ph·ªèng tr·ª±c quan tr√™n ph·∫ßn m·ªÅm."]
        ];

        // T·∫°o Workbook v√† Worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);

        // ƒê·ªãnh d·∫°ng ƒë·ªô r·ªông c·ªôt (C∆° b·∫£n)
        ws['!cols'] = [{ wch: 30 }, { wch: 20 }, { wch: 20 }];

        // Th√™m sheet v√†o workbook
        XLSX.utils.book_append_sheet(wb, ws, "B√°o C√°o Selectivity");

        // Xu·∫•t file
        const fileName = `BaoCao_Selectivity_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }

    function drawTCC(mainIn, branchIn, mainImVal, branchImVal, delay, type, mainCurveType) {
        const canvas = document.getElementById('tccCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height = canvas.offsetHeight;

        ctx.clearRect(0, 0, w, h);
        const margin = 50;
        
        ctx.strokeStyle = "#eee";
        ctx.lineWidth = 1;
        for(let i=1; i<10; i++) {
            let x = margin + (i/10)*(w-margin);
            let y = margin + (i/10)*(h-margin);
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
        }

        ctx.beginPath();
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 2;
        ctx.moveTo(margin, 10); ctx.lineTo(margin, h - margin);
        ctx.moveTo(margin, h - margin); ctx.lineTo(w - 10, h - margin);
        ctx.stroke();
        
        ctx.fillStyle = "#333";
        ctx.font = "12px Arial";
        ctx.fillText("Time (s) [Log]", 10, 20);
        ctx.fillText("Current (A) [Log]", w - 100, h - 20);

        const mapX = (amps) => margin + (Math.log10(amps) * (w - margin) / 5); 
        const mapY = (time) => (h - margin) - (Math.log10(time * 100) * (h - margin) / 5); 

        function drawCurve(In, Im, color, isDelayed, delayVal, isMA) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;

            if (!isMA) {
                let startI = In * 1.13;
                ctx.moveTo(mapX(startI), mapY(1000)); 
                ctx.quadraticCurveTo(mapX(startI), mapY(10), mapX(Im), mapY(0.1)); 
            } else {
                ctx.moveTo(mapX(Im), mapY(1000));
            }

            if (isDelayed && delayVal > 0) {
                ctx.lineTo(mapX(Im), mapY(delayVal)); 
                ctx.lineTo(mapX(Im * 15), mapY(delayVal)); 
                ctx.lineTo(mapX(Im * 15), mapY(0.01)); 
            } else {
                ctx.lineTo(mapX(Im), mapY(0.01)); 
            }
            ctx.stroke();
        }

        drawCurve(branchIn, branchImVal, "#188038", false, 0, false);
        const isMA = (mainCurveType === 'MA');
        drawCurve(mainIn, mainImVal, "#d93025", true, delay, isMA);

        if (type === 'PARTIAL') {
            ctx.fillStyle = "rgba(255, 165, 0, 0.4)";
            ctx.beginPath();
            let xOverlap = mapX(mainImVal); 
            let width = mapX(branchImVal * 2) - xOverlap; 
            let yOverlap = mapY(0.1); 
            ctx.rect(xOverlap, yOverlap, width, 100); 
            ctx.fill();
            
            ctx.fillStyle = "#b06000";
            ctx.font = "bold 14px Arial";
            ctx.fillText("‚ö†Ô∏è XUNG ƒê·ªòT", xOverlap, yOverlap - 10);
        }
    }
    
    toggleDelayOption();
</script>

</body>
</html>
