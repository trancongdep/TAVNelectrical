
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sơ đồ SLD Xưởng 1 - Quản lý Trạng thái Busbar</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #eef2f5; margin: 0; padding: 20px; user-select: none; }
        
        /* BẢNG ĐIỀU KHIỂN */
        .control-panel {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid #ddd;
        }
        .btn-grid {
            padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .btn-grid:hover { background: #0056b3; }
        .legend { margin-top: 10px; font-size: 13px; line-height: 1.8; }
        .dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }

        /* KHUNG VẼ CHÍNH */
        #diagram-container {
            width: 1400px; height: 900px;
            background-color: white; border: 1px solid #ccc;
            position: relative; margin: 0 auto; overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* LƯỚI TỌA ĐỘ */
        #grid-layer {
            position: absolute; inset: 0; display: none; pointer-events: none;
            background-image: linear-gradient(#e0e0e0 1px, transparent 1px), linear-gradient(90deg, #e0e0e0 1px, transparent 1px);
            background-size: 50px 50px; z-index: 0;
        }

        /* === CÁC PHẦN TỬ HỆ THỐNG ĐIỆN === */
        
        /* 1. NGUỒN */
        .source {
            position: absolute; z-index: 10;
            background: #e3f2fd; border: 2px solid #1976d2; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #0d47a1; text-align: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        /* 2. THANH CÁI (BUSBAR) - QUAN TRỌNG */
        .busbar {
            position: absolute; z-index: 5; /* Nằm dưới CB nhưng trên dây */
            background-color: #455a64; /* MÀU GỐC: Xám đậm (Mất điện) */
            border: 1px solid #263238;
            border-radius: 4px;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.3);
            transition: background-color 0.3s ease; /* Hiệu ứng đổi màu mượt */
        }

        /* 3. DÂY DẪN */
        .line {
            position: absolute; z-index: 4;
            background-color: #b0bec5; /* Màu gốc: Xám nhạt */
            transition: background-color 0.3s ease;
        }

        /* 4. APTOMAT (CB) */
        .cb {
            position: absolute; z-index: 20;
            background: white; border: 2px solid #78909c;
            cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold; color: #333;
            transition: all 0.2s;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .cb:hover { transform: scale(1.05); box-shadow: 3px 3px 8px rgba(0,0,0,0.2); }
        
        /* Trạng thái CB */
        .cb.closed { border-color: #d32f2f; color: #d32f2f; } /* ĐÓNG */
        .cb.open { border-color: #2e7d32; color: #2e7d32; border-style: dashed; background-color: #f1f8e9; opacity: 0.9; } /* CẮT */

        /* 5. CLASS TRẠNG THÁI "CÓ ĐIỆN" (ENERGIZED) */
        /* Áp dụng cho Busbar và Line */
        .energized { 
            background-color: #ff3d00 !important; /* MÀU ĐỎ CAM RỰC RỠ */
            box-shadow: 0 0 5px rgba(255, 61, 0, 0.4); /* Phát sáng nhẹ */
        }
        
        /* Áp dụng cho thiết bị (Nguồn, CB) */
        .source.energized-device { background-color: #bbdefb; }
        .cb.energized-device { background-color: #ffccbc; border-color: #d32f2f; }

        /* Tooltip tọa độ */
        .device-wrapper:hover::after {
            content: "ID: " attr(id) " (x:" attr(data-x) ", y:" attr(data-y) ")";
            position: absolute; top: -25px; left: 0; background: #333; color: #fff;
            padding: 4px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; z-index: 100;
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <button class="btn-grid" onclick="toggleGrid()">Bật/Tắt Lưới (50px)</button>
        <div class="legend">
            <div><span class="dot" style="background:#ff3d00"></span> Có điện (Live)</div>
            <div><span class="dot" style="background:#455a64"></span> Mất điện (Dead)</div>
            <div><span class="dot" style="border:2px solid #d32f2f; background:white"></span> CB Đóng (ON)</div>
            <div><span class="dot" style="border:2px dashed #2e7d32; background:white"></span> CB Cắt (OFF)</div>
        </div>
        <div style="margin-top:10px; font-style: italic; color: #666; font-size:12px;">
            * Click vào CB để thao tác
        </div>
    </div>

    <div id="diagram-container">
        <div id="grid-layer"></div>
        </div>

<script>
    // =================================================================
    // DỮ LIỆU CẤU HÌNH HỆ THỐNG (XƯỞNG 1)
    // =================================================================
    
    const config = {
        // 1. NGUỒN (Sources)
        sources: [
            { id: 'src_main', x: 50, y: 50, w: 100, h: 60, label: 'NGUỒN\nMSB1-1' },
            { id: 'src_bkup', x: 1250, y: 600, w: 100, h: 60, label: 'NGUỒN\nDB9-2' }
        ],

        // 2. THANH CÁI (BUSBARS) - Sẽ đổi màu theo trạng thái
        busbars: [
            // Busbar Tủ Tổng DB1-1 (Nhỏ, ngắn)
            { id: 'bus_db1', x: 230, y: 130, w: 10, h: 100, label: '', parentId: 'cb_db1_in' },
            
            // Busbar Tủ Phân Phối DB1-1.2 (Thanh cái chính dài ngang)
            { id: 'bus_main_1_2', x: 100, y: 350, w: 1200, h: 15, label: '', parentId: 'cb_1_2_in' }
        ],

        // 3. THIẾT BỊ ĐÓNG CẮT (CBs)
        cbs: [
            // --- Nhánh Nguồn Chính ---
            { id: 'cb_db1_in', x: 205, y: 60, w: 60, h: 50, label: 'Tổng\nDB1-1', state: 'closed', parentId: 'src_main' },
            
            // Các CB ra từ Tủ Tổng DB1-1
            { id: 'cb_1_3', x: 300, y: 140, w: 60, h: 40, label: 'Ra CD\n1.1.3', state: 'closed', parentId: 'bus_db1' },
            { id: 'cb_1_2_feeder', x: 205, y: 250, w: 60, h: 50, label: 'Cấp\n1.1.2', state: 'closed', parentId: 'bus_db1' }, // Cấp xuống dưới

            // CB Tổng đầu vào của tủ DB1-1.2
            { id: 'cb_1_2_in', x: 205, y: 310, w: 60, h: 40, label: 'Tổng\n1.1.2', state: 'closed', parentId: 'cb_1_2_feeder' },

            // --- Các CB Nhánh trên Busbar Chính (DB1-1.2) ---
            // Paint B
            { id: 'cb_pb1', x: 150, y: 400, w: 50, h: 40, label: 'Paint B\n1.2.1', state: 'closed', parentId: 'bus_main_1_2' },
            { id: 'cb_pb2', x: 250, y: 400, w: 50, h: 40, label: 'Paint B\n1.2.2', state: 'closed', parentId: 'bus_main_1_2' },
            
            // Paint D
            { id: 'cb_pd1', x: 450, y: 400, w: 50, h: 40, label: 'Paint D\n1.2.3', state: 'closed', parentId: 'bus_main_1_2' },
            
            // Paint A
            { id: 'cb_pa1', x: 750, y: 400, w: 50, h: 40, label: 'Paint A\n1.2.8', state: 'closed', parentId: 'bus_main_1_2' },
            
            // Paint C
            { id: 'cb_pc1', x: 1050, y: 400, w: 50, h: 40, label: 'Paint C\n1.2.7', state: 'closed', parentId: 'bus_main_1_2' },

            // --- Nhánh Nguồn Phụ DB9-2 ---
            { id: 'cb_src2', x: 1140, y: 610, w: 50, h: 40, label: 'DB9-2.1', state: 'open', parentId: 'src_bkup' }
        ],

        // 4. DÂY DẪN (LINES) - Nối các điểm lại với nhau
        lines: [
            // Nối Nguồn -> CB Tổng
            { id: 'l1', x: 150, y: 80, w: 55, h: 4, parentId: 'src_main' },

            // CB Tổng -> Busbar DB1-1
            { id: 'l2', x: 233, y: 110, w: 4, h: 20, parentId: 'cb_db1_in' },

            // Busbar DB1-1 -> CB Nhánh 1.3
            { id: 'l3', x: 240, y: 160, w: 60, h: 4, parentId: 'bus_db1' },

            // Busbar DB1-1 -> CB Cấp nguồn 1.2
            // (Busbar dọc đã vẽ sẵn, chỉ cần nối từ busbar vào CB)
            { id: 'l4', x: 233, y: 230, w: 4, h: 20, parentId: 'bus_db1' },

            // CB Feeder -> CB Input 1.2 (Dây cáp trục chính 4x300)
            { id: 'l5', x: 233, y: 300, w: 4, h: 10, parentId: 'cb_1_2_feeder' },
            
            // CB Input 1.2 -> Busbar Chính 1.2
            { id: 'l6', x: 233, y: 350, w: 4, h: 0, parentId: 'cb_1_2_in' }, // Kết nối trực tiếp

            // Từ Busbar Chính -> Các CB Nhánh (Vẽ các dây thả xuống)
            { id: 'ld_1', x: 175, y: 365, w: 4, h: 35, parentId: 'bus_main_1_2' }, // Xuống Paint B1
            { id: 'ld_2', x: 275, y: 365, w: 4, h: 35, parentId: 'bus_main_1_2' }, // Xuống Paint B2
            { id: 'ld_3', x: 475, y: 365, w: 4, h: 35, parentId: 'bus_main_1_2' }, // Xuống Paint D
            { id: 'ld_4', x: 775, y: 365, w: 4, h: 35, parentId: 'bus_main_1_2' }, // Xuống Paint A
            { id: 'ld_5', x: 1075, y: 365, w: 4, h: 35, parentId: 'bus_main_1_2' }, // Xuống Paint C

            // Nguồn phụ
            { id: 'l_src2', x: 1190, y: 630, w: 60, h: 4, parentId: 'src_bkup' },
        ]
    };

    // =================================================================
    // CORE ENGINE (LOGIC XỬ LÝ)
    // =================================================================
    
    // Gộp dữ liệu
    let systemData = [
        ...config.sources.map(i => ({...i, type: 'source'})),
        ...config.busbars.map(i => ({...i, type: 'busbar'})),
        ...config.cbs.map(i => ({...i, type: 'cb'})),
        ...config.lines.map(i => ({...i, type: 'line'}))
    ];

    const container = document.getElementById('diagram-container');

    function render() {
        // Xóa phần tử cũ (Giữ lại grid)
        const oldItems = document.querySelectorAll('.device-wrapper, .line, .busbar');
        oldItems.forEach(e => e.remove());

        systemData.forEach(item => {
            const el = document.createElement('div');
            el.id = item.id;
            el.style.left = item.x + 'px';
            el.style.top = item.y + 'px';
            el.style.width = item.w + 'px';
            el.style.height = item.h + 'px';
            
            // Metadata cho tooltip
            el.setAttribute('data-x', item.x);
            el.setAttribute('data-y', item.y);

            // Gán class
            if (item.type === 'line') el.className = 'line';
            else if (item.type === 'busbar') el.className = 'busbar';
            else {
                el.className = 'device-wrapper source'; // Default
                if (item.type === 'cb') el.className = 'device-wrapper cb ' + item.state;
                if (item.type === 'source') el.className = 'device-wrapper source';
                
                el.innerHTML = `<span>${item.label.replace(/\n/g, '<br>')}</span>`;
            }

            // Sự kiện Click cho CB
            if (item.type === 'cb') {
                el.onclick = (e) => {
                    e.stopPropagation();
                    item.state = item.state === 'closed' ? 'open' : 'closed';
                    recalculatePower();
                    render();
                };
            }

            // HIỂN THỊ TRẠNG THÁI CÓ ĐIỆN (COLORING)
            if (item.isEnergized) {
                if (item.type === 'line' || item.type === 'busbar') {
                    el.classList.add('energized'); // Dây/Busbar đỏ
                } else {
                    el.classList.add('energized-device'); // Thiết bị sáng
                }
            }

            container.appendChild(el);
        });
    }

    // Thuật toán lan truyền điện (Recursive Power Propagation)
    function recalculatePower() {
        // 1. Reset toàn bộ về "Mất điện"
        systemData.forEach(d => d.isEnergized = false);

        // 2. Tìm các nguồn và bắt đầu lan truyền
        const sources = systemData.filter(d => d.type === 'source');
        sources.forEach(source => propagate(source.id));
    }

    function propagate(parentId) {
        const parent = systemData.find(d => d.id === parentId);
        if (!parent) return;

        // Parent có điện
        parent.isEnergized = true;

        // Nếu là CB đang CẮT -> Chặn dòng điện, không truyền xuống con
        if (parent.type === 'cb' && parent.state === 'open') return;

        // Tìm các con nối vào parent này
        const children = systemData.filter(d => d.parentId === parentId);
        children.forEach(child => propagate(child.id));
    }

    function toggleGrid() {
        const grid = document.getElementById('grid-layer');
        grid.style.display = grid.style.display === 'block' ? 'none' : 'block';
    }

    // Khởi chạy
    recalculatePower();
    render();

</script>
</body>
</html>
