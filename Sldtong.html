<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>S∆° ƒë·ªì Tr·∫°m Bi·∫øn √Åp & X∆∞·ªüng 1 (Full Option)</title>
    <style>
        body { font-family: 'Segoe UI', monospace; background-color: #f4f4f9; margin: 0; padding: 20px; }
        
        #drawing-board {
            position: relative;
            width: 1800px; height: 1400px; /* TƒÉng chi·ªÅu cao ƒë·ªÉ ch·ª©a tr·∫°m bi·∫øn √°p */
            background-color: white;
            border: 2px solid #333;
            margin: 0 auto;
            background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px);
            background-size: 50px 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* --- C√ÅC LO·∫†I NODE (THI·∫æT B·ªä) --- */
        .node {
            position: absolute; z-index: 10;
            cursor: pointer; text-align: center;
            transition: all 0.2s; user-select: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .node:hover { transform: scale(1.1); z-index: 100; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .label { font-size: 10px; font-weight: bold; color: #333; background: rgba(255,255,255,0.8); padding: 1px 3px; border-radius: 3px; white-space: nowrap; margin-top: 5px; }

        /* 1. Ngu·ªìn L∆∞·ªõi (GRID) */
        .grid-node {
            width: 60px; height: 40px; border: 2px solid #1565c0; background: #e3f2fd;
            border-radius: 50% 50% 0 0; /* H√¨nh b√°n nguy·ªát */
        }
        
        /* 2. Dao C√°ch Ly (DS) - Disconnector */
        .ds-node {
            width: 40px; height: 40px; border: 2px solid #fbc02d; background: #fff9c4;
            border-radius: 50%; /* H√¨nh tr√≤n */
        }
        .ds-node::after { content: "/"; font-weight: bold; font-size: 20px; color: #f9a825; }

        /* 3. M√°y C·∫Øt (CB: VCB, ACB, MCCB) */
        .cb-node {
            width: 40px; height: 40px; border: 2px solid #455a64; background: white;
            border-radius: 0; /* H√¨nh vu√¥ng */
        }
        .cb-node::after { content: "X"; font-weight: bold; font-size: 18px; color: #455a64; }

        /* 4. M√°y Bi·∫øn √Åp (TR) */
        .tr-node {
            width: 50px; height: 80px; background: transparent; border: none;
        }
        .tr-circle {
            width: 46px; height: 46px; border: 2px solid #2e7d32; background: #e8f5e9;
            border-radius: 50%; position: absolute; left: 0;
        }
        .tr-top { top: 0; z-index: 2; }
        .tr-bottom { bottom: 0; z-index: 1; margin-top: -10px; }

        /* 5. Thanh C√°i (Busbar) */
        .busbar-node {
            height: 10px; background: #424242; border: 1px solid black; border-radius: 5px;
            width: 100px; /* S·∫Ω ƒë∆∞·ª£c override trong JS */
        }

        /* 6. T·ªß DB (Distribution Board) */
        .db-node {
            width: 80px; height: 50px; border: 2px solid #333; background: white;
        }

        /* --- TR·∫†NG TH√ÅI (State Styles) --- */
        /* CB ƒê√≥ng/C·∫Øt */
        .closed { border-color: #d32f2f !important; } .closed::after { color: #d32f2f; }
        .open { border-color: #388e3c !important; border-style: dashed !important; opacity: 0.7; } .open::after { color: #388e3c; }

        /* C√≥ ƒëi·ªán (Energized) */
        .energized-device { background-color: #ffccbc !important; }
        .energized-bus { background-color: #ff3d00 !important; box-shadow: 0 0 10px #ff3d00; }
        .tr-circle.energized-device { background-color: #ffccbc !important; }

        /* D√¢y d·∫´n */
        .line { position: absolute; z-index: 1; background-color: #9e9e9e; transition: background 0.3s; }
        .energized-line { background-color: #ff3d00 !important; z-index: 5; }

        /* --- LEGEND --- */
        .legend { position: fixed; top: 20px; right: 20px; background: white; padding: 15px; border: 1px solid #999; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="legend">
        <strong>CH√ö GI·∫¢I K√ù HI·ªÜU</strong>
        <div style="margin-top:5px">‚ö° <span style="color:#ff3d00">M√†u ƒê·ªè</span>: C√≥ ƒëi·ªán (Live)</div>
        <div>‚ö™ <span style="color:#999">M√†u X√°m</span>: M·∫•t ƒëi·ªán (Dead)</div>
        <hr>
        <div>üî≤ <b>CB</b>: M√°y c·∫Øt (Click ƒë·ªÉ ƒê√≥ng/C·∫Øt)</div>
        <div>üü° <b>DS</b>: Dao c√°ch ly</div>
        <div>‚ôæÔ∏è <b>TR</b>: M√°y bi·∫øn √°p</div>
        <div>‚ûñ <b>Busbar</b>: Thanh c√°i</div>
    </div>

    <div id="drawing-board"></div>

<script>
    // =========================================================================
    // 1. C·∫§U H√åNH D·ªÆ LI·ªÜU (TOPOLOGY)
    // =========================================================================
    // T·ªça ƒë·ªô (x, y) ƒë∆∞·ª£c cƒÉn ch·ªânh ƒë·ªÉ MSB n·∫±m tr√™n, DB ph√¢n ph·ªëi n·∫±m d∆∞·ªõi
    
    const nodes = [
        // --- C·ª§M CAO TH·∫æ & TR·∫†M BI·∫æN √ÅP (UPSTREAM) ---
        { id: 'GRID', type: 'grid', x: 850, y: 20, label: 'L∆∞·ªõi 22kV' },
        
        { id: 'DS_HV', type: 'ds', parent: 'GRID', x: 850, y: 100, label: 'DS-01 (Dao CL)', state: 'closed' },
        
        { id: 'VCB', type: 'cb', parent: 'DS_HV', x: 850, y: 180, label: 'VCB (Cao Th·∫ø)', state: 'closed' },
        
        { id: 'TR1', type: 'tr', parent: 'VCB', x: 850, y: 260, label: 'MBA 2000kVA' },

        { id: 'ACB_MAIN', type: 'cb', parent: 'TR1', x: 850, y: 380, label: 'ACB T·ªïng', state: 'closed' },

        // --- BUSBAR T·ªîNG (MSB) ---
        // Thanh c√°i d√†i ngang ƒë·ªÉ ph√¢n ph·ªëi ƒëi c√°c nh√°nh
        { id: 'BUS_MSB', type: 'bus', parent: 'ACB_MAIN', x: 850, y: 450, w: 800, label: 'Busbar MSB 0.4kV' },


        // --- C√ÅC NH√ÅNH T·ª™ BUSBAR T·ªîNG ---
        
        // 1. Nh√°nh T·ªß DB1-1 (Theo b·∫£n v·∫Ω c≈©) -> ƒêi sang ph·∫£i
        { id: 'MCCB_DB1_1', type: 'cb', parent: 'BUS_MSB', x: 1300, y: 550, label: 'MCCB C·∫•p DB1-1', state: 'closed' },
        { id: 'DB1_1', type: 'db', parent: 'MCCB_DB1_1', x: 1300, y: 650, label: 'T·ªß DB1-1' },
            
            // Con c·ªßa DB1-1
            { id: 'DB1_1_3', type: 'db', parent: 'DB1_1', x: 1150, y: 750, label: 'DB1-1.3\n(X·ª≠ l√Ω CD)' },
            { id: 'DB1_1_1', type: 'db', parent: 'DB1_1', x: 1450, y: 750, label: 'DB1-1.1' },

        // 2. Nh√°nh TR·ª§C CH√çNH DB1-1.2 (Gi·ªØa)
        { id: 'MCCB_1_2', type: 'cb', parent: 'BUS_MSB', x: 850, y: 550, label: 'MCCB C·∫•p 1.2', state: 'closed' },
        { id: 'DB1_1_2', type: 'db', parent: 'MCCB_1_2', x: 850, y: 650, label: 'Ph√¢n Ph·ªëi\nDB1-1.2' },
        
        // --- C√ÅC LINE S∆†N T·ª™ DB1-1.2 (X√≤e ra h√¨nh qu·∫°t) ---
        
            // Paint B (Tr√°i)
            { id: 'CB_PB1', type: 'cb', parent: 'DB1_1_2', x: 200, y: 800, label: 'CB', state: 'closed' },
            { id: 'DB_PB1', type: 'db', parent: 'CB_PB1', x: 200, y: 900, label: 'Paint B\n1.2.1' },

            { id: 'CB_PB2', type: 'cb', parent: 'DB1_1_2', x: 350, y: 800, label: 'CB', state: 'closed' },
            { id: 'DB_PB2', type: 'db', parent: 'CB_PB2', x: 350, y: 900, label: 'Paint B\n1.2.2' },

            // Paint A & D (Gi·ªØa)
            { id: 'CB_PA', type: 'cb', parent: 'DB1_1_2', x: 500, y: 800, label: 'CB', state: 'closed' },
            { id: 'DB_PA', type: 'db', parent: 'CB_PA', x: 500, y: 900, label: 'Paint A\n1.2.8' },

            { id: 'CB_PD3', type: 'cb', parent: 'DB1_1_2', x: 650, y: 800, label: 'CB', state: 'closed' },
            { id: 'DB_PD3', type: 'db', parent: 'CB_PD3', x: 650, y: 900, label: 'Paint D\n1.2.3' },

            { id: 'CB_PD4', type: 'cb', parent: 'DB1_1_2', x: 800, y: 800, label: 'CB', state: 'closed' },
            { id: 'DB_PD4', type: 'db', parent: 'CB_PD4', x: 800, y: 900, label: 'Paint D\n1.2.4' },

            // Paint C (Ph·∫£i)
            { id: 'CB_PC6', type: 'cb', parent: 'DB1_1_2', x: 950, y: 800, label: 'CB', state: 'closed' },
            { id: 'DB_PC6', type: 'db', parent: 'CB_PC6', x: 950, y: 900, label: 'Paint C\n1.2.6' },

            { id: 'CB_PC7', type: 'cb', parent: 'DB1_1_2', x: 1100, y: 800, label: 'CB', state: 'closed' },
            { id: 'DB_PC7', type: 'db', parent: 'CB_PC7', x: 1100, y: 900, label: 'Paint C\n1.2.7' },

        // --- C·ª§M NGU·ªíN PH·ª§ (DB9-2) - B√äN TR√ÅI ---
        { id: 'GEN_2', type: 'grid', x: 100, y: 20, label: 'M√°y Ph√°t/Ngu·ªìn 2' },
        { id: 'DS_2', type: 'ds', parent: 'GEN_2', x: 100, y: 100, label: 'DS-02', state: 'open' }, // ƒêang m·ªü
        { id: 'CB_2', type: 'cb', parent: 'DS_2', x: 100, y: 180, label: 'CB Ngu·ªìn 2', state: 'closed' },
        { id: 'DB9_2', type: 'db', parent: 'CB_2', x: 100, y: 300, label: 'T·ªß DB9-2' },

    ];

    // =========================================================================
    // 2. ENGINE V·∫º (RENDERER)
    // =========================================================================
    
    // Kh·ªüi t·∫°o tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
    nodes.forEach(n => {
        n.isEnergized = false;
        if(n.type === 'grid') n.isEnergized = true; // Ngu·ªìn lu√¥n c√≥ ƒëi·ªán
    });

    const board = document.getElementById('drawing-board');

    function draw() {
        board.innerHTML = ''; // X√≥a c≈©
        
        // 1. V·∫Ω D√¢y (L·ªõp d∆∞·ªõi)
        nodes.forEach(node => {
            if (node.parent) {
                const parent = nodes.find(n => n.id === node.parent);
                if (parent) drawLine(parent, node);
            }
        });

        // 2. V·∫Ω Thi·∫øt B·ªã (L·ªõp tr√™n)
        nodes.forEach(node => {
            const el = document.createElement('div');
            el.className = 'node';
            el.id = node.id;
            
            // Set t·ªça ƒë·ªô (center)
            let w = 40, h = 40; // Default
            if (node.type === 'grid') { w=60; h=40; el.classList.add('grid-node'); }
            else if (node.type === 'ds') { el.classList.add('ds-node'); }
            else if (node.type === 'cb') { el.classList.add('cb-node'); }
            else if (node.type === 'tr') { w=50; h=80; el.classList.add('tr-node'); }
            else if (node.type === 'bus') { w=node.w || 100; h=10; el.classList.add('busbar-node'); }
            else if (node.type === 'db') { w=80; h=50; el.classList.add('db-node'); }

            el.style.left = (node.x - w/2) + 'px';
            el.style.top = (node.y - h/2) + 'px';
            el.style.width = w + 'px';
            el.style.height = h + 'px';

            // N·ªôi dung ƒë·∫∑c bi·ªát cho TR (2 v√≤ng tr√≤n)
            if (node.type === 'tr') {
                el.innerHTML = `
                    <div class="tr-circle tr-top ${node.isEnergized ? 'energized-device' : ''}"></div>
                    <div class="tr-circle tr-bottom ${node.isEnergized ? 'energized-device' : ''}"></div>
                    <div style="position:absolute; bottom:-20px" class="label">${node.label}</div>
                `;
            } else {
                // Label chung
                el.innerHTML += `<div style="position:absolute; bottom:-25px" class="label">${node.label}</div>`;
            }

            // Apply style tr·∫°ng th√°i
            if (node.type === 'cb' || node.type === 'ds') {
                el.classList.add(node.state); // open/closed class
                el.onclick = () => toggle(node.id);
            }
            
            // M√†u s·∫Øc nƒÉng l∆∞·ª£ng
            if (node.isEnergized) {
                if(node.type === 'bus') el.classList.add('energized-bus');
                else if(node.type !== 'tr') el.classList.add('energized-device');
            }

            board.appendChild(el);
        });
    }

    function drawLine(p, c) {
        // M√†u s·∫Øc d√¢y: Ph·ª• thu·ªôc v√†o Cha (C√≥ ƒëi·ªán & ƒê√≥ng m·∫°ch)
        let isLive = p.isEnergized;
        
        // N·∫øu cha l√† thi·∫øt b·ªã ƒë√≥ng c·∫Øt (CB, DS), ph·∫£i ki·ªÉm tra tr·∫°ng th√°i ƒë√≥ng
        if ((p.type === 'cb' || p.type === 'ds') && p.state !== 'closed') {
            isLive = false;
        }

        const cls = isLive ? 'energized-line' : '';
        const x1 = p.x, y1 = p.y + (p.type==='tr'?40:20); // ƒêi·ªÉm d∆∞·ªõi cha
        const x2 = c.x, y2 = c.y - (c.type==='tr'?40:20); // ƒêi·ªÉm tr√™n con

        // V·∫Ω d√¢y vu√¥ng g√≥c (Manhattan)
        const midY = y1 + (y2 - y1) / 2;
        createSeg(x1, y1, x1, midY, cls); // D·ªçc 1
        createSeg(x1, midY, x2, midY, cls); // Ngang
        createSeg(x2, midY, x2, y2, cls); // D·ªçc 2
    }

    function createSeg(x1, y1, x2, y2, cls) {
        if (x1===x2 && y1===y2) return;
        const l = document.createElement('div');
        l.className = 'line ' + cls;
        const w = Math.abs(x2-x1)||2, h = Math.abs(y2-y1)||2;
        l.style.width = w+'px'; l.style.height = h+'px';
        l.style.left = Math.min(x1,x2)+'px'; l.style.top = Math.min(y1,y2)+'px';
        board.appendChild(l);
    }

    // =========================================================================
    // 3. LOGIC LAN TRUY·ªÄN (POWER PROPAGATION)
    // =========================================================================
    function toggle(id) {
        const n = nodes.find(x => x.id === id);
        if (n) {
            n.state = n.state === 'closed' ? 'open' : 'closed';
            recalc();
            draw();
        }
    }

    function recalc() {
        nodes.forEach(n => { if(n.type !== 'grid') n.isEnergized = false; });
        nodes.filter(n => n.type === 'grid').forEach(src => propagate(src));
    }

    function propagate(p) {
        // Logic truy·ªÅn ƒëi·ªán: Cha ph·∫£i c√≥ ƒëi·ªán. N·∫øu cha l√† Switch, cha ph·∫£i Closed.
        let canPropagate = p.isEnergized;
        if ((p.type === 'cb' || p.type === 'ds') && p.state !== 'closed') canPropagate = false;

        if (canPropagate) {
            const children = nodes.filter(n => n.parent === p.id);
            children.forEach(c => {
                c.isEnergized = true;
                propagate(c);
            });
        }
    }

    // Init
    recalc();
    draw();

</script>
</body>
</html>
