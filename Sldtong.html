<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>SLD Xưởng 1 - Cập nhật Graphviz</title>
    <style>
        body { font-family: 'Segoe UI', monospace; background-color: #f4f4f4; margin: 0; padding: 20px; overflow: auto; }
        
        #drawing-board {
            position: relative;
            width: 1800px; height: 1200px; /* Tăng kích thước để chứa đủ */
            background-color: white;
            border: 1px solid #999;
            margin: 0 auto;
            background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px);
            background-size: 40px 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* TỦ ĐIỆN & NÚT */
        .node {
            position: absolute; z-index: 10;
            background: white; border: 2px solid #333;
            width: 100px; padding: 5px;
            text-align: center; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            font-size: 11px;
        }
        .node:hover { transform: scale(1.05); z-index: 100; box-shadow: 5px 5px 15px rgba(0,0,0,0.2); }
        .node-label { font-weight: bold; color: #222; margin-bottom: 2px; }
        .node-cable { font-size: 9px; color: #666; font-style: italic; }
        .status-badge { display: inline-block; margin-top: 3px; padding: 1px 5px; border-radius: 3px; font-size: 9px; font-weight: bold; }

        /* TRẠNG THÁI */
        .closed { border-color: #d32f2f; } /* Đóng - Đỏ */
        .open { border-color: #2e7d32; border-style: dashed; opacity: 0.8; } /* Mở - Xanh */
        
        .energized-node { background-color: #ffebee; } /* Có điện - Nền hồng */
        .source-node { background-color: #e3f2fd !important; border-color: #1565c0 !important; }

        /* DÂY DẪN */
        .line {
            position: absolute; z-index: 1;
            background-color: #bdbdbd; /* Màu xám chết */
            transition: background-color 0.3s;
        }
        .energized-line { background-color: #ff3d00 !important; z-index: 5; } /* Đỏ rực khi có điện */

        /* TOOLTIP & LEGEND */
        .legend { position: fixed; top: 20px; right: 20px; background: white; padding: 15px; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
    </style>
</head>
<body>

    <div class="legend">
        <strong>CHÚ THÍCH</strong><br>
        <div style="margin-top:5px"><span style="color:#ff3d00; font-size:18px">■</span> Dây có điện</div>
        <div><span style="color:#bdbdbd; font-size:18px">■</span> Dây mất điện</div>
        <div style="margin-top:5px; border:1px solid #d32f2f; color:#d32f2f; padding:2px; text-align:center">CB ĐÓNG (ON)</div>
        <div style="margin-top:5px; border:1px dashed #2e7d32; color:#2e7d32; padding:2px; text-align:center">CB CẮT (OFF)</div>
    </div>

    <div id="drawing-board"></div>

<script>
    // =========================================================================
    // 1. CẤU TRÚC DỮ LIỆU (Mapping từ mã Graphviz sang tọa độ Canvas)
    // =========================================================================
    // Logic tọa độ: 
    // - Nguồn MSB bên trái trên cao.
    // - DB1-1.2 là trục chính nằm giữa.
    // - Các nhánh con tỏa ra xung quanh.
    
    const nodes = [
        // --- CỤM NGUỒN CHÍNH (MSB1-1) ---
        { id: 'MSB1-1', type: 'source', x: 200, y: 50, label: 'Nguon MSB1-1\n(Tu Chinh)' },
        { id: 'DB1-1', parent: 'MSB1-1', x: 200, y: 150, label: 'DB1-1\n(Tu Tong)', cable: '4x300mm+N+PE' },

            // Nhánh phụ từ DB1-1
            { id: 'DB1-1.3', parent: 'DB1-1', x: 450, y: 150, label: 'DB1-1.3\n(Xu Ly CD)' },
                { id: 'DB1-1.3.1', parent: 'DB1-1.3', x: 450, y: 250, label: 'DB1-1.3.1', cable: '4x80mm+N+PE' },
            
            { id: 'DB1-1.1', parent: 'DB1-1', x: 600, y: 150, label: 'DB1-1.1' },

        // --- TRỤC PHÂN PHỐI CHÍNH (DB1-1.2) ---
        // Nằm thẳng dưới DB1-1
        { id: 'DB1-1.2', parent: 'DB1-1', x: 200, y: 300, label: 'DB1-1.2\n(Phan Phoi Chinh)', cable: '4x300mm+N+PE' },

            // === CÁC NHÁNH CON TỪ DB1-1.2 ===
            
            // 1. Nhánh Paint D & CD Area (Bên Phải)
            { id: 'DB1-1.2.3', parent: 'DB1-1.2', x: 400, y: 400, label: 'DB1-1.2.3', cable: '4x30mm+N+PE' },
                { id: 'DB1-1.2.3.1', parent: 'DB1-1.2.3', x: 400, y: 500, label: 'DB1-1.2.3.1', cable: '4x10mm+N+PE' },

            { id: 'DB1-1.2.4', parent: 'DB1-1.2', x: 550, y: 400, label: 'DB1-1.2.4', cable: '4x80mm+N+PE' },

            { id: 'DB1-1.2.5', parent: 'DB1-1.2', x: 700, y: 400, label: 'DB1-1.2.5', cable: '4x50mm+N+PE' },
                { id: 'DB1-1.2.5.1', parent: 'DB1-1.2.5', x: 700, y: 500, label: 'DB1-1.2.5.1', cable: '4x10mm+N+PE' },

            { id: 'DB1-1.2.6A', parent: 'DB1-1.2', x: 850, y: 400, label: 'DB1-1.2.6\n(Tren)', cable: '4x10mm+N+PE' },

            // 2. Nhánh Paint B (Bên Trái)
            { id: 'DB1-1.2.1', parent: 'DB1-1.2', x: 50, y: 400, label: 'DB1-1.2.1', cable: '4x70mm+N+PE' },

            { id: 'DB1-1.2.2', parent: 'DB1-1.2', x: -100, y: 400, label: 'DB1-1.2.2', cable: '4x70mm+N+PE' }, // Tọa độ âm sẽ được offset khi vẽ
                { id: 'DB1-1.2.2.1', parent: 'DB1-1.2.2', x: -150, y: 500, label: 'DB1-1.2.2.1', cable: '2x6mm+N+PE' },
                { id: 'DB1-1.2.2.2', parent: 'DB1-1.2.2', x: -50, y: 500, label: 'DB1-1.2.2.2', cable: '2x6mm+N+PE' },

            // 3. Nhánh Paint A (Giữa Trái)
            { id: 'DB1-1.2.8', parent: 'DB1-1.2', x: 200, y: 600, label: 'DB1-1.2.8', cable: '4x70mm+N+PE' }, // Xuống sâu hơn
                { id: 'DB1-1.2.8.1', parent: 'DB1-1.2.8', x: 200, y: 700, label: 'DB1-1.2.8.1', cable: '4mm' },

            // 4. Nhánh Paint C (Bên Phải Xa)
            { id: 'DB1-1.2.6B', parent: 'DB1-1.2', x: 1000, y: 400, label: 'DB1-1.2.6\n(Duoi)', cable: '4x70mm+N+PE' },
                { id: 'DB1-1.2.7.1', parent: 'DB1-1.2.6B', x: 1000, y: 500, label: 'DB1-1.2.7.1' },

            { id: 'DB1-1.2.7', parent: 'DB1-1.2', x: 1150, y: 400, label: 'DB1-1.2.7', cable: '4x70mm+N+PE' },
                { id: 'DB1-1.2.7.3', parent: 'DB1-1.2.7', x: 1100, y: 500, label: 'DB1-1.2.7.3' },
                { id: 'DB1-1.2.7.2', parent: 'DB1-1.2.7', x: 1200, y: 500, label: 'DB1-1.2.7.2', cable: '4x4mm+N+PE' },

            // 5. Tải Khác
            { id: 'DB-1.2.1_Load', parent: 'DB1-1.2', x: 50, y: 600, label: 'DB-1.2.1', cable: '4x35mm+N+PE' },
            { id: 'DB1-1.2.10', parent: 'DB1-1.2', x: 350, y: 600, label: 'DB1-1.2.10' },

        // --- CỤM NGUỒN 2 (ĐỘC LẬP - DB9-2) ---
        { id: 'DB9-2', type: 'source', x: 1400, y: 50, label: 'Nguon DB9-2' },
        { id: 'DB9-2.1', parent: 'DB9-2', x: 1400, y: 150, label: 'DB9-2.1', cable: '4x120mm+N+PE' },
    ];

    // Offset để căn giữa các node có tọa độ âm hoặc quá lệch
    const OFFSET_X = 250; 
    const OFFSET_Y = 50;

    // Khởi tạo trạng thái
    nodes.forEach(n => {
        n.state = 'closed';
        n.isEnergized = false;
        if(n.type === 'source') n.isEnergized = true;
    });

    const board = document.getElementById('drawing-board');

    // =========================================================================
    // 2. ENGINE VẼ & TÍNH TOÁN
    // =========================================================================
    
    function draw() {
        board.innerHTML = ''; // Clear canvas
        
        // Vẽ DÂY trước (Lớp dưới)
        nodes.forEach(node => {
            if (node.parent) {
                const parent = nodes.find(n => n.id === node.parent);
                if (parent) drawLine(parent, node);
            }
        });

        // Vẽ TỦ/NÚT sau (Lớp trên)
        nodes.forEach(node => {
            const el = document.createElement('div');
            el.className = 'node';
            if (node.type === 'source') el.classList.add('source-node');
            else el.classList.add(node.state); // open/closed

            // Màu sắc nếu có điện
            if (node.isEnergized) el.classList.add('energized-node');

            // Vị trí
            el.style.left = (node.x + OFFSET_X) + 'px';
            el.style.top = (node.y + OFFSET_Y) + 'px';

            // Nội dung
            let statusHtml = '';
            if (node.type !== 'source') {
                const txt = node.state === 'closed' ? 'ON' : 'OFF';
                const color = node.state === 'closed' ? '#d32f2f' : '#2e7d32';
                statusHtml = `<div class="status-badge" style="color:${color}; border:1px solid ${color}">${txt}</div>`;
            }

            el.innerHTML = `
                <div class="node-label">${node.label.replace(/\n/g, '<br>')}</div>
                <div class="node-cable">${node.cable || ''}</div>
                ${statusHtml}
            `;

            // Click Event
            if (node.type !== 'source') {
                el.onclick = () => toggle(node.id);
            }

            board.appendChild(el);
        });
    }

    function drawLine(p, c) {
        // Tọa độ thực sau offset
        const x1 = p.x + OFFSET_X + 50; // +50 vì width node = 100, lấy tâm
        const y1 = p.y + OFFSET_Y + 50; // lấy mép dưới
        const x2 = c.x + OFFSET_X + 50;
        const y2 = c.y + OFFSET_Y;      // lấy mép trên

        // Trạng thái dây: Cha có điện VÀ Cha đóng
        const isLive = p.isEnergized && (p.type === 'source' || p.state === 'closed');
        const colorClass = isLive ? 'energized-line' : '';

        // Vẽ kiểu Manhattan (Vuông góc)
        const midY = y1 + (y2 - y1) / 2;

        // 1. Dọc xuống
        createSegment(x1, y1, x1, midY, colorClass);
        // 2. Ngang qua
        createSegment(x1, midY, x2, midY, colorClass);
        // 3. Dọc tới đích
        createSegment(x2, midY, x2, y2, colorClass);
    }

    function createSegment(x1, y1, x2, y2, cls) {
        if (x1 === x2 && y1 === y2) return;
        const seg = document.createElement('div');
        seg.className = 'line ' + cls;
        
        const w = Math.abs(x2 - x1) || 2;
        const h = Math.abs(y2 - y1) || 2;
        
        seg.style.width = w + 'px';
        seg.style.height = h + 'px';
        seg.style.left = Math.min(x1, x2) + 'px';
        seg.style.top = Math.min(y1, y2) + 'px';
        
        board.appendChild(seg);
    }

    // =========================================================================
    // 3. LOGIC LAN TRUYỀN ĐIỆN
    // =========================================================================
    function toggle(id) {
        const n = nodes.find(x => x.id === id);
        if (n) {
            n.state = n.state === 'closed' ? 'open' : 'closed';
            recalc();
            draw();
        }
    }

    function recalc() {
        // Reset
        nodes.forEach(n => {
            if (n.type !== 'source') n.isEnergized = false;
        });

        // Propagate from sources
        nodes.filter(n => n.type === 'source').forEach(src => propagate(src));
    }

    function propagate(p) {
        // Điều kiện truyền: Cha có điện & (Là nguồn HOẶC Cha đang đóng)
        if (p.isEnergized && (p.type === 'source' || p.state === 'closed')) {
            const children = nodes.filter(n => n.parent === p.id);
            children.forEach(c => {
                c.isEnergized = true;
                propagate(c);
            });
        }
    }

    // Init
    recalc();
    draw();

</script>
</body>
</html>
