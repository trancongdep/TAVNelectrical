<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω L·ªánh C√¥ng T√°c (Firebase)</title>
    <style>
        body { font-family: 'Times New Roman', serif; line-height: 1.5; max-width: 210mm; margin: 0 auto; padding: 20px; color: #000; }
        h1, h2, h3 { text-align: center; margin: 5px 0; text-transform: uppercase; }
        h3 { font-size: 14pt; }
        .header-section { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        input[type="text"], input[type="number"], input[type="date"], textarea {
            width: 100%; border: 1px solid #ccc; padding: 5px; font-family: inherit;
        }
        input.inline-input { border: none; border-bottom: 1px dotted #000; width: auto; flex-grow: 1; outline: none; }
        .row { display: flex; align-items: baseline; flex-wrap: wrap; margin-bottom: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle; }
        th { background-color: #f0f0f0; font-weight: bold; }
        
        .btn-group { margin: 20px 0; text-align: center; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; margin: 5px; }
        button:hover { background-color: #0056b3; }
        .btn-print { background-color: #28a745; }
        .btn-save { background-color: #ff9800; }
        .btn-load { background-color: #17a2b8; }
        .btn-remove { background-color: #dc3545; padding: 2px 5px; font-size: 12px; }

        .signature-section { display: flex; justify-content: space-between; margin-top: 30px; text-align: center; }
        .signature-box { width: 45%; }
        .signature-space { height: 80px; }

        /* Panel qu·∫£n l√Ω d·ªØ li·ªáu */
        #data-panel {
            background: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px;
        }
        #saved-list { max-height: 200px; overflow-y: auto; margin-top: 10px; border: 1px solid #ccc; background: #fff; }
        .saved-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .saved-item:hover { background-color: #e9ecef; }

        @media print {
            .no-print { display: none !important; }
            input, textarea { border: none !important; background: transparent; resize: none; overflow: visible; padding: 0; }
            .inline-input { border-bottom: 1px dotted #000; }
            #data-panel { display: none; }
        }
    </style>
</head>
<body>

    <div id="data-panel" class="no-print">
        <h3>üóÑÔ∏è Qu·∫£n l√Ω d·ªØ li·ªáu (Firebase)</h3>
        <div>
            <button class="btn-save" id="btnSave">üíæ L∆∞u L·ªánh C√¥ng T√°c</button>
            <button class="btn-load" id="btnLoadList">üìÇ T·∫£i danh s√°ch ƒë√£ l∆∞u</button>
            <button onclick="window.location.reload()">üîÑ L√†m m·ªõi (X√≥a tr·∫Øng)</button>
        </div>
        <div id="saved-list" style="display:none;">
            </div>
        <p style="font-size: 12px; color: #666; margin-top:5px;">*L∆∞u √Ω: D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u l√™n ƒë√°m m√¢y, b·∫°n c√≥ th·ªÉ m·ªü l·∫°i t·ª´ m√°y kh√°c.</p>
    </div>

    <div id="print-area">
        <div class="header-section">
            <div style="text-align: center; width: 40%;">
                T√äN ƒê∆†N V·ªä C·∫§P L·ªÜNH<br>
                <input type="text" id="unitName" placeholder="Nh·∫≠p t√™n ƒë∆°n v·ªã..." style="text-align: center; font-weight: bold;">
            </div>
            <div style="text-align: center; width: 40%;">
                <strong>L·ªÜNH C√îNG T√ÅC</strong><br>
                S·ªë: <input type="text" id="orderNumber" style="width: 50px; text-align: center;">
            </div>
        </div>

        <h3>1. N·ªòI DUNG L·ªÜNH</h3>
        <div class="row">
            <strong>1.1. Ng∆∞·ªùi ch·ªâ huy tr·ª±c ti·∫øp (Ng∆∞·ªùi thi h√†nh l·ªánh):</strong>
            <input type="text" id="commanderName1" class="inline-input">
            <span>B·∫≠c ATƒê:</span>
            <input type="text" id="commanderRank1" class="inline-input" style="width: 50px; text-align: center;">/5
        </div>

        <div class="row" style="margin-top: 10px;">
            <strong>1.2. Nh√¢n vi√™n ƒë∆°n v·ªã c√¥ng t√°c, g·ªìm:</strong>
            <input type="number" id="member-count" class="inline-input" style="width: 50px; text-align: center;" readonly> ng∆∞·ªùi.
        </div>
        <div class="row">
            <span>Thu·ªôc (C√¥ng ty, Ph√¢n x∆∞·ªüng v.v):</span>
            <input type="text" id="unitBelong" class="inline-input">
        </div>
        
        <table id="staff-table">
            <thead>
                <tr>
                    <th rowspan="2" style="width: 5%;">TT</th>
                    <th rowspan="2" style="width: 25%;">H·ªç, t√™n</th>
                    <th rowspan="2" style="width: 10%;">B·∫≠c ATƒê</th>
                    <th colspan="2">ƒê·∫øn l√†m vi·ªác</th>
                    <th colspan="2">R√∫t kh·ªèi</th>
                    <th class="no-print" rowspan="2" style="width: 5%;">X√≥a</th>
                </tr>
                <tr>
                    <th>Th·ªùi gian</th>
                    <th>K√Ω t√™n</th>
                    <th>Th·ªùi gian</th>
                    <th>K√Ω t√™n</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="btn-group no-print" style="text-align: left;">
            <button onclick="addStaffRow()">+ Th√™m nh√¢n vi√™n</button>
        </div>

        <div class="form-group">
            <strong>1.3. ƒê·ªãa ƒëi·ªÉm (ho·∫∑c thi·∫øt b·ªã):</strong>
            <textarea id="location" rows="2" style="width: 100%; border: none; border-bottom: 1px dotted black;"></textarea>
        </div>
        <div class="form-group">
            <strong>1.4. N·ªôi dung c√¥ng vi·ªác:</strong>
            <textarea id="content" rows="3" style="width: 100%; border: none; border-bottom: 1px dotted black;"></textarea>
        </div>
        <div class="form-group">
            <strong>1.5. ƒêi·ªÅu ki·ªán an to√†n:</strong>
            <textarea id="safety" rows="3" style="width: 100%; border: none; border-bottom: 1px dotted black;"></textarea>
        </div>

        <div class="row">
            <strong>1.6. Th·ªùi gian b·∫Øt ƒë·∫ßu:</strong>
            <span>T·ª´</span> <input type="text" id="startHour" class="inline-input" style="width: 40px;"> gi·ªù
            <input type="text" id="startMin" class="inline-input" style="width: 40px;"> ph√∫t,
            ng√†y <input type="date" id="startDate" class="inline-input" style="width: 130px;">
        </div>

        <div class="signature-section">
            <div></div>
            <div class="signature-box">
                <p><strong>Ng∆∞·ªùi ra L·ªánh c√¥ng t√°c</strong></p>
                <input type="text" id="issuerName" placeholder="H·ªç t√™n ng∆∞·ªùi ra l·ªánh" style="text-align: center; border: none; margin-top: 80px;">
            </div>
        </div>

        <hr style="border-top: 2px solid black; margin: 20px 0;">

        <h3>2. TH·ª∞C HI·ªÜN L·ªÜNH</h3>
        <div class="row">
            <strong>2.1. Ng∆∞·ªùi ch·ªâ huy tr·ª±c ti·∫øp k√Ω nh·∫≠n:</strong>
            <input type="text" id="commanderSign" class="inline-input">
        </div>

        <div class="row" style="margin-top: 10px;">
            <strong>2.2. Ng∆∞·ªùi gi√°m s√°t an to√†n ƒëi·ªán:</strong>
            <input type="text" id="supervisorName" class="inline-input">
        </div>

        <p style="margin-top: 15px;"><strong>2.3. Tr√¨nh t·ª± c√¥ng vi·ªác:</strong></p>
        <table id="sequence-table">
            <thead>
                <tr>
                    <th rowspan="2" style="width: 5%;">TT</th>
                    <th rowspan="2">Tr√¨nh t·ª± c√¥ng vi·ªác</th>
                    <th rowspan="2">C√°c ƒëi·ªÅu ki·ªán an to√†n</th>
                    <th colspan="2">Th·ªùi gian</th>
                    <th class="no-print" rowspan="2" style="width: 5%;">X√≥a</th>
                </tr>
                <tr><th>B·∫Øt ƒë·∫ßu</th><th>K·∫øt th√∫c</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="btn-group no-print" style="text-align: left;">
            <button onclick="addSequenceRow()">+ Th√™m b∆∞·ªõc c√¥ng vi·ªác</button>
        </div>
        
        <h3>3. K·∫æT TH√öC C√îNG T√ÅC</h3>
         <div class="row">
             <span>K·∫øt th√∫c l√∫c</span>
             <input type="text" id="endHour" class="inline-input" style="width: 40px;"> gi·ªù
             <input type="text" id="endMin" class="inline-input" style="width: 40px;"> ph√∫t,
             ng√†y <input type="date" id="endDate" class="inline-input" style="width: 130px;">
         </div>
         <div class="row">
             <span>ƒê√£ b√°o cho √¥ng/b√†:</span> <input type="text" id="reportTo" class="inline-input">
             <span>Ch·ª©c danh:</span> <input type="text" id="reportRole" class="inline-input">
         </div>
    </div>

    <div class="btn-group no-print">
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è In L·ªánh C√¥ng T√°c</button>
    </div>

    <script type="module">
        // --- 1. C·∫§U H√åNH FIREBASE (THAY ƒê·ªîI ·ªû ƒê√ÇY) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ============================================================
        // B·∫†N H√ÉY D√ÅN CONFIG C·ª¶A B·∫†N V√ÄO B√äN D∆Ø·ªöI
        const firebaseConfig = {
          apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
          authDomain: "tavietnam-78ae8.firebaseapp.com",
          projectId: "tavietnam-78ae8",
          storageBucket: "tavietnam-78ae8.firebasestorage.app",
          messagingSenderId: "670121705534",
          appId: "1:670121705534:web:1027ad98550573ad37116f"
        };
        // ============================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = "work_orders"; // T√™n b·∫£ng trong Database

        // --- 2. H√ÄM L∆ØU D·ªÆ LI·ªÜU ---
        document.getElementById('btnSave').addEventListener('click', async () => {
            const btn = document.getElementById('btnSave');
            btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

            try {
                // L·∫•y d·ªØ li·ªáu b·∫£ng nh√¢n vi√™n
                const staffRows = [];
                document.querySelectorAll('#staff-table tbody tr').forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    if(inputs.length > 0) {
                        staffRows.push({
                            name: inputs[0].value,
                            rank: inputs[1].value,
                            timeIn: inputs[2].value,
                            sign1: inputs[3].value, // Ch·ªØ k√Ω ch·ªâ l√† text m√¥ ph·ªèng
                            timeOut: inputs[4].value,
                            sign2: inputs[5].value
                        });
                    }
                });

                // L·∫•y d·ªØ li·ªáu b·∫£ng tr√¨nh t·ª±
                const seqRows = [];
                document.querySelectorAll('#sequence-table tbody tr').forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    if(inputs.length > 0) {
                        seqRows.push({
                            step: inputs[0].value,
                            safety: inputs[1].value,
                            start: inputs[2].value,
                            end: inputs[3].value
                        });
                    }
                });

                const data = {
                    createdAt: new Date(),
                    unitName: document.getElementById('unitName').value,
                    orderNumber: document.getElementById('orderNumber').value,
                    commanderName1: document.getElementById('commanderName1').value,
                    commanderRank1: document.getElementById('commanderRank1').value,
                    unitBelong: document.getElementById('unitBelong').value,
                    staffList: staffRows,
                    location: document.getElementById('location').value,
                    content: document.getElementById('content').value,
                    safetyConditions: document.getElementById('safety').value,
                    startHour: document.getElementById('startHour').value,
                    startMin: document.getElementById('startMin').value,
                    startDate: document.getElementById('startDate').value,
                    issuerName: document.getElementById('issuerName').value,
                    commanderSign: document.getElementById('commanderSign').value,
                    supervisorName: document.getElementById('supervisorName').value,
                    workSequence: seqRows,
                    endHour: document.getElementById('endHour').value,
                    endMin: document.getElementById('endMin').value,
                    endDate: document.getElementById('endDate').value,
                    reportTo: document.getElementById('reportTo').value,
                    reportRole: document.getElementById('reportRole').value,
                };

                await addDoc(collection(db, COLLECTION_NAME), data);
                alert("‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng l√™n Firebase!");
            } catch (e) {
                console.error("L·ªói l∆∞u: ", e);
                alert("‚ùå L·ªói khi l∆∞u: " + e.message);
            } finally {
                btn.innerText = "üíæ L∆∞u L·ªánh C√¥ng T√°c"; btn.disabled = false;
            }
        });

        // --- 3. H√ÄM T·∫¢I DANH S√ÅCH ---
        document.getElementById('btnLoadList').addEventListener('click', async () => {
            const listDiv = document.getElementById('saved-list');
            listDiv.style.display = 'block';
            listDiv.innerHTML = '<p style="padding:10px;">ƒêang t·∫£i...</p>';

            try {
                // L·∫•y danh s√°ch, s·∫Øp x·∫øp theo ng√†y t·∫°o m·ªõi nh·∫•t
                const q = query(collection(db, COLLECTION_NAME), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                listDiv.innerHTML = '';
                if (querySnapshot.empty) {
                    listDiv.innerHTML = '<p style="padding:10px;">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o.</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    const dateStr = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString('vi-VN') : 'N/A';
                    const div = document.createElement('div');
                    div.className = 'saved-item';
                    div.innerHTML = `
                        <span><strong>S·ªë: ${d.orderNumber || '?'}</strong> - ${d.content ? d.content.substring(0,30)+'...' : 'Kh√¥ng n·ªôi dung'}</span>
                        <small>${dateStr}</small>
                    `;
                    div.onclick = () => loadDetail(d);
                    listDiv.appendChild(div);
                });
            } catch (e) {
                listDiv.innerHTML = '<p style="color:red; padding:10px;">L·ªói t·∫£i: ' + e.message + '</p>';
            }
        });

        // --- 4. H√ÄM HI·ªÇN TH·ªä CHI TI·∫æT ---
        function loadDetail(data) {
            if(!confirm("D·ªØ li·ªáu hi·ªán t·∫°i tr√™n m√†n h√¨nh s·∫Ω b·ªã thay th·∫ø. B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) return;

            // ƒêi·ªÅn c√°c √¥ input ƒë∆°n gi·∫£n
            document.getElementById('unitName').value = data.unitName || '';
            document.getElementById('orderNumber').value = data.orderNumber || '';
            document.getElementById('commanderName1').value = data.commanderName1 || '';
            document.getElementById('commanderRank1').value = data.commanderRank1 || '';
            document.getElementById('unitBelong').value = data.unitBelong || '';
            document.getElementById('location').value = data.location || '';
            document.getElementById('content').value = data.content || '';
            document.getElementById('safety').value = data.safetyConditions || '';
            document.getElementById('startHour').value = data.startHour || '';
            document.getElementById('startMin').value = data.startMin || '';
            document.getElementById('startDate').value = data.startDate || '';
            document.getElementById('issuerName').value = data.issuerName || '';
            document.getElementById('commanderSign').value = data.commanderSign || '';
            document.getElementById('supervisorName').value = data.supervisorName || '';
            document.getElementById('endHour').value = data.endHour || '';
            document.getElementById('endMin').value = data.endMin || '';
            document.getElementById('endDate').value = data.endDate || '';
            document.getElementById('reportTo').value = data.reportTo || '';
            document.getElementById('reportRole').value = data.reportRole || '';

            // T√°i t·∫°o b·∫£ng Nh√¢n vi√™n
            const staffBody = document.querySelector('#staff-table tbody');
            staffBody.innerHTML = ''; // X√≥a c≈©
            if(data.staffList && Array.isArray(data.staffList)){
                data.staffList.forEach(s => {
                    window.addStaffRowWithData(s);
                });
            } else {
                window.addStaffRow(); // Th√™m d√≤ng tr·ªëng n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
            }

            // T√°i t·∫°o b·∫£ng Tr√¨nh t·ª±
            const seqBody = document.querySelector('#sequence-table tbody');
            seqBody.innerHTML = ''; // X√≥a c≈©
            if(data.workSequence && Array.isArray(data.workSequence)){
                data.workSequence.forEach(s => {
                    window.addSequenceRowWithData(s);
                });
            } else {
                window.addSequenceRow();
            }

            document.getElementById('saved-list').style.display = 'none';
            alert("ƒê√£ t·∫£i d·ªØ li·ªáu xong!");
        }

    </script>

    <script>
        // C√°c h√†m giao di·ªán n·∫±m ngo√†i module ƒë·ªÉ HTML g·ªçi ƒë∆∞·ª£c
        window.addStaffRow = function() {
            window.addStaffRowWithData({});
        }

        window.addStaffRowWithData = function(data) {
            const table = document.getElementById('staff-table').getElementsByTagName('tbody')[0];
            const rowCount = table.rows.length + 1;
            const row = table.insertRow();
            
            row.innerHTML = `
                <td>${rowCount}</td>
                <td><input type="text" value="${data.name || ''}" style="width: 90%; border: none;"></td>
                <td><input type="text" value="${data.rank || ''}" style="width: 80%; border: none; text-align: center;">/5</td>
                <td><input type="text" value="${data.timeIn || ''}" placeholder="Gi·ªù v√†o" style="width: 90%; border: none;"></td>
                <td><input type="text" value="${data.sign1 || ''}" style="width: 90%; border: none;"></td>
                <td><input type="text" value="${data.timeOut || ''}" placeholder="Gi·ªù ra" style="width: 90%; border: none;"></td>
                <td><input type="text" value="${data.sign2 || ''}" style="width: 90%; border: none;"></td>
                <td class="no-print"><button class="btn-remove" onclick="removeRow(this, 'member-count')">X</button></td>
            `;
            updateCount();
        }

        window.addSequenceRow = function() {
            window.addSequenceRowWithData({});
        }

        window.addSequenceRowWithData = function(data) {
            const table = document.getElementById('sequence-table').getElementsByTagName('tbody')[0];
            const rowCount = table.rows.length + 1;
            const row = table.insertRow();
            
            row.innerHTML = `
                <td>${rowCount}</td>
                <td><textarea rows="1" style="width: 95%; border: none; resize: vertical;">${data.step || ''}</textarea></td>
                <td><textarea rows="1" style="width: 95%; border: none; resize: vertical;">${data.safety || ''}</textarea></td>
                <td><input type="text" value="${data.start || ''}" style="width: 90%; border: none;"></td>
                <td><input type="text" value="${data.end || ''}" style="width: 90%; border: none;"></td>
                <td class="no-print"><button class="btn-remove" onclick="removeRow(this)">X</button></td>
            `;
        }

        window.removeRow = function(btn, countId) {
            const row = btn.parentNode.parentNode;
            const table = row.parentNode;
            table.removeChild(row);
            
            for (let i = 0; i < table.rows.length; i++) {
                table.rows[i].cells[0].innerText = i + 1;
            }
            if(countId) updateCount();
        }

        function updateCount() {
            const table = document.getElementById('staff-table').getElementsByTagName('tbody')[0];
            document.getElementById('member-count').value = table.rows.length;
        }

        // Kh·ªüi t·∫°o d√≤ng tr·ªëng ban ƒë·∫ßu n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu
        window.addEventListener('DOMContentLoaded', () => {
             if(document.querySelector('#staff-table tbody').rows.length === 0) window.addStaffRow();
             if(document.querySelector('#sequence-table tbody').rows.length === 0) window.addSequenceRow();
        });
    </script>
</body>
</html>