<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá th·ªëng ƒêi·ªán X∆∞·ªüng 1 tr√™n B·∫£n ƒê·ªì (GIS)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }

        /* Style cho c√°c Node (T·ªß ƒëi·ªán/M√°y bi·∫øn √°p) tr√™n b·∫£n ƒë·ªì */
        .map-node {
            background: white;
            border: 2px solid #333;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            transition: all 0.3s;
        }

        /* Tr·∫°ng th√°i ƒê√ìNG (C√≥ d√≤ng ƒëi qua v·ªÅ m·∫∑t c∆° kh√≠) */
        .node-closed { border-color: #d32f2f; color: #d32f2f; }
        
        /* Tr·∫°ng th√°i M·ªû (Ng·∫Øt m·∫°ch) */
        .node-open { border-color: #2e7d32; color: #2e7d32; border-style: dashed; background: #f1f8e9; }

        /* Tr·∫°ng th√°i C√ì ƒêI·ªÜN (Energized) - N·ªÅn s√°ng l√™n */
        .node-energized { background-color: #ffccbc !important; box-shadow: 0 0 15px #ff3d00; }
        .node-dead { background-color: #eee; }

        /* B·∫£ng ch√∫ th√≠ch */
        .legend {
            position: absolute; bottom: 20px; left: 20px;
            background: white; padding: 10px; z-index: 1000;
            border: 2px solid #ccc; font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div class="legend">
        <b>ƒêI·ªÄU KHI·ªÇN L∆Ø·ªöI ƒêI·ªÜN</b><br>
        üî¥ ƒê∆∞·ªùng ƒë·ªè: C√≥ ƒëi·ªán<br>
        ‚ö´ ƒê∆∞·ªùng ƒëen: M·∫•t ƒëi·ªán<br>
        Click v√†o t·ªß ƒë·ªÉ ƒê√≥ng/C·∫Øt
    </div>

<script>
    // =============================================================
    // 1. KH·ªûI T·∫†O B·∫¢N ƒê·ªí (Leaflet)
    // =============================================================
    // T·ªça ƒë·ªô v√≠ d·ª• (S√¢n bay T√¢n S∆°n Nh·∫•t - Gi·∫£ l·∫≠p nh√† x∆∞·ªüng)
    const factoryLat = 10.814; 
    const factoryLng = 106.666;
    
    const map = L.map('map').setView([factoryLat, factoryLng], 17);

    // Th√™m l·ªõp n·ªÅn b·∫£n ƒë·ªì (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // =============================================================
    // 2. D·ªÆ LI·ªÜU H·ªÜ TH·ªêNG (C√≥ t·ªça ƒë·ªô Lat/Lng)
    // =============================================================
    // Thay v√¨ x, y (pixel), ta d√πng lat, lng (ƒë·ªãa l√Ω)
    
    const nodes = [
        // TR·∫†M BI·∫æN √ÅP (Ngu·ªìn) - G√≥c x∆∞·ªüng
        { id: 'TR1', type: 'source', lat: 10.816, lng: 106.664, label: 'TR·∫†M BA\n22kV' },

        // T·ª¶ T·ªîNG MSB
        { id: 'MSB', parent: 'TR1', lat: 10.8155, lng: 106.665, label: 'MSB-1' },

        // DB1-1 (Ph√¢n ph·ªëi khu v·ª±c 1)
        { id: 'DB1_1', parent: 'MSB', lat: 10.815, lng: 106.666, label: 'DB1-1' },

        // TR·ª§C CH√çNH DB1-1.2 (Line S∆°n)
        { id: 'DB1_1_2', parent: 'DB1_1', lat: 10.8145, lng: 106.667, label: 'Line S∆°n\nDB1-1.2' },

            // C√°c nh√°nh con r·∫£i r√°c trong x∆∞·ªüng
            { id: 'PaintA', parent: 'DB1_1_2', lat: 10.814, lng: 106.666, label: 'Paint A' },
            { id: 'PaintB', parent: 'DB1_1_2', lat: 10.814, lng: 106.668, label: 'Paint B' },
            { id: 'PaintC', parent: 'DB1_1_2', lat: 10.8135, lng: 106.667, label: 'Paint C' },
            { id: 'PaintD', parent: 'DB1_1_2', lat: 10.8135, lng: 106.665, label: 'Paint D' },

        // NGU·ªíN D·ª∞ PH√íNG (M√°y ph√°t) - G√≥c kh√°c
        { id: 'GEN', type: 'source', lat: 10.813, lng: 106.669, label: 'M√ÅY PH√ÅT\nDB9-2' },
        { id: 'ATS', parent: 'GEN', lat: 10.8135, lng: 106.6685, label: 'T·ªß ATS', state: 'open' } // ƒêang m·ªü
    ];

    // Kh·ªüi t·∫°o tr·∫°ng th√°i
    nodes.forEach(n => {
        n.state = n.state || 'closed'; // M·∫∑c ƒë·ªãnh ƒë√≥ng
        n.isEnergized = false;
        if(n.type === 'source') n.isEnergized = true;
        
        // L∆∞u tham chi·∫øu ƒë·∫øn marker/polyline tr√™n b·∫£n ƒë·ªì ƒë·ªÉ update sau
        n.mapMarker = null; 
        n.mapLine = null;
    });

    // =============================================================
    // 3. H√ÄM V·∫º TR√äN B·∫¢N ƒê·ªí (RENDER MAP)
    // =============================================================
    
    function drawMapEntities() {
        nodes.forEach(node => {
            // A. V·∫º D√ÇY (Polyline) n·ªëi v·ªõi cha
            if (node.parent) {
                const parent = nodes.find(n => n.id === node.parent);
                if (parent) {
                    // T·∫°o ƒë∆∞·ªùng d√¢y
                    const line = L.polyline(
                        [[parent.lat, parent.lng], [node.lat, node.lng]], 
                        { color: 'black', weight: 4, opacity: 0.6 }
                    ).addTo(map);
                    
                    node.mapLine = line; // L∆∞u tham chi·∫øu
                }
            }

            // B. V·∫º T·ª¶ ƒêI·ªÜN (Marker)
            // D√πng DivIcon ƒë·ªÉ t√πy bi·∫øn CSS (h√¨nh vu√¥ng thay v√¨ c√°i ghim)
            const icon = L.divIcon({
                className: 'custom-pin', // Class ·∫£o, ta s·∫Ω ch·ªânh style tr·ª±c ti·∫øp trong h√†m update
                html: `<div id="icon-${node.id}" class="map-node" style="width:60px; height:40px;">${node.label}</div>`,
                iconSize: [60, 40],
                iconAnchor: [30, 20]
            });

            const marker = L.marker([node.lat, node.lng], { icon: icon }).addTo(map);
            
            // S·ª± ki·ªán Click
            marker.on('click', () => {
                if (node.type !== 'source') { // Ngu·ªìn kh√¥ng c·∫Øt ƒë∆∞·ª£c ·ªü ƒë√¢y
                    toggleNode(node.id);
                }
            });

            node.mapMarker = marker;
        });
        
        updateVisuals(); // C·∫≠p nh·∫≠t m√†u s·∫Øc l·∫ßn ƒë·∫ßu
    }

    // =============================================================
    // 4. LOGIC X·ª¨ L√ù (GI·ªêNG H·ªÜT SLD C≈®)
    // =============================================================

    function toggleNode(id) {
        const n = nodes.find(x => x.id === id);
        if (n) {
            n.state = n.state === 'closed' ? 'open' : 'closed';
            recalcPower();
            updateVisuals();
        }
    }

    function recalcPower() {
        // Reset
        nodes.forEach(n => { if(n.type !== 'source') n.isEnergized = false; });
        // Lan truy·ªÅn
        nodes.filter(n => n.type === 'source').forEach(src => propagate(src));
    }

    function propagate(p) {
        // Logic: Cha c√≥ ƒëi·ªán & (Cha l√† ngu·ªìn HO·∫∂C Cha ƒëang ƒë√≥ng)
        if (p.isEnergized && (p.type === 'source' || p.state === 'closed')) {
            const children = nodes.filter(n => n.parent === p.id);
            children.forEach(c => {
                c.isEnergized = true;
                propagate(c);
            });
        }
    }

    // =============================================================
    // 5. C·∫¨P NH·∫¨T GIAO DI·ªÜN B·∫¢N ƒê·ªí
    // =============================================================
    function updateVisuals() {
        nodes.forEach(node => {
            // 1. C·∫≠p nh·∫≠t m√†u D√ÇY
            if (node.mapLine) {
                // D√¢y c√≥ ƒëi·ªán khi: Cha c√≥ ƒëi·ªán & Cha ƒë√≥ng
                const parent = nodes.find(n => n.id === node.parent);
                const isLineLive = parent.isEnergized && (parent.type === 'source' || parent.state === 'closed');
                
                if (isLineLive) {
                    node.mapLine.setStyle({ color: '#ff3d00', weight: 6, opacity: 1 }); // ƒê·ªè, ƒë·∫≠m
                } else {
                    node.mapLine.setStyle({ color: '#555', weight: 4, opacity: 0.5 }); // X√°m, m·ªù
                }
            }

            // 2. C·∫≠p nh·∫≠t m√†u T·ª¶ (ICON)
            // V√¨ Leaflet render HTML string, ta ph·∫£i t√¨m element DOM sau khi render
            const el = document.getElementById(`icon-${node.id}`);
            if (el) {
                // Reset class
                el.className = 'map-node';
                
                // Tr·∫°ng th√°i ƒê√≥ng/C·∫Øt
                if (node.type !== 'source') {
                    el.classList.add(node.state === 'closed' ? 'node-closed' : 'node-open');
                }

                // Tr·∫°ng th√°i C√≥ ƒëi·ªán
                if (node.isEnergized) {
                    el.classList.add('node-energized');
                } else {
                    el.classList.add('node-dead');
                }
            }
        });
    }

    // Kh·ªüi ch·∫°y
    recalcPower();
    drawMapEntities();

</script>
</body>
</html>
