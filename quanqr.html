<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TA QR Biz - Ver 2.7 (Double Limit)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
        .auth-container { max-width: 400px; margin: 50px auto; }
        .dashboard-container { max-width: 1200px; margin: 30px auto; display: none; padding: 0 15px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .vip-badge { background-color: #FFD700; color: #333; padding: 5px 10px; border-radius: 20px; font-weight: bold; }
        .qr-thumb { width: 60px; height: 60px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px; }
        
        /* Hiển thị số lượt còn lại */
        .quota-box { background: #e9ecef; padding: 10px; border-radius: 8px; font-size: 0.9rem; margin-top: 5px; }
        .quota-active { color: #198754; font-weight: bold; }
        .quota-warning { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<div id="redirect-screen" style="display:none; height:100vh; background:#fff; align-items:center; justify-content:center; flex-direction:column;">
    <div class="spinner-border text-primary mb-3"></div>
    <h4 id="redirect-msg">Đang xử lý...</h4>
</div>

<div id="auth-screen" class="container auth-container">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">TA QR Biz</h2>
        <p class="text-muted">Ver 2.7 - Quản lý giới hạn kép</p>
    </div>
    <div class="card p-4">
        <form id="authForm">
            <div class="mb-3"><label>Email</label><input type="email" class="form-control" id="email" required></div>
            <div class="mb-3"><label>Mật khẩu</label><input type="password" class="form-control" id="password" required></div>
            <div class="d-grid"><button type="submit" class="btn btn-primary">Đăng Nhập / Đăng Ký</button></div>
        </form>
    </div>
</div>

<div id="dashboard-screen" class="dashboard-container">
    <div class="card bg-white border-0 shadow-sm p-3 mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h4 class="mb-1" id="welcomeMsg">Xin chào!</h4>
                <div id="planInfo">Checking...</div>
            </div>
            <div class="text-end">
                <button class="btn btn-warning btn-sm fw-bold shadow-sm" onclick="simulatePayment()"><i class="fa-solid fa-crown"></i> Nâng cấp VIP</button>
                <button class="btn btn-outline-secondary btn-sm ms-2" onclick="logout()">Thoát</button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white"><i class="fa-solid fa-plus-circle me-2"></i>Tạo Mã Mới</div>
                <div class="card-body">
                    <div class="quota-box mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Kho lưu trữ:</span>
                            <span id="storageQuota">0/3</span>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span>Lượt tạo hôm nay:</span>
                            <span id="dailyQuota">0/3</span>
                        </div>
                    </div>

                    <form id="createQrForm">
                        <div class="mb-3"><label>Tên mã</label><input type="text" class="form-control" id="qrName" required></div>
                        <div class="mb-3"><label>Link đích</label><input type="url" class="form-control" id="qrDest" placeholder="https://" required></div>
                        <button type="submit" class="btn btn-primary w-100" id="btnCreate">Tạo ngay</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-white border-bottom"><i class="fa-solid fa-list me-2"></i>Danh sách Mã QR</div>
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light"><tr><th>QR</th><th>Chi tiết</th><th>View</th><th>Xóa</th></tr></thead>
                        <tbody id="qrTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, serverTimestamp, updateDoc, increment, setDoc, getDoc } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CẤU HÌNH ---
    const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- QUY ĐỊNH GIỚI HẠN ---
    const LIMITS = {
        STORAGE: 3, // Tối đa 3 mã tồn tại
        DAILY: 3    // Tối đa tạo 3 mã/ngày
    };

    // --- LOGIC REDIRECT (SCAN) ---
    const scanId = new URLSearchParams(window.location.search).get('id');
    if (scanId) {
        document.getElementById('auth-screen').remove();
        document.getElementById('dashboard-screen').remove();
        document.getElementById('redirect-screen').style.display = 'flex';
        
        (async () => {
            const q = query(collection(db, "qr_codes_v2"), where("shortId", "==", scanId));
            const snap = await getDocs(q);
            if (!snap.empty) {
                const qrDoc = snap.docs[0];
                updateDoc(qrDoc.ref, { views: increment(1) });
                window.location.href = qrDoc.data().destination;
            } else {
                document.getElementById('redirect-msg').innerText = "Mã QR không khả dụng.";
            }
        })();
    } else {
        // --- LOGIC APP QUẢN LÝ ---
        let currentUser, userProfile;
        let myStorageCount = 0; // Số mã đang có
        let myDailyUsage = 0;   // Số mã đã tạo hôm nay

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                currentUser = u;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('dashboard-screen').style.display = 'block';
                await loadData();
            } else {
                document.getElementById('auth-screen').style.display = 'block';
                document.getElementById('dashboard-screen').style.display = 'none';
            }
        });

        // Hàm tải tổng hợp
        async function loadData() {
            await loadUserProfile(); // Tải gói cước + Daily usage
            await loadMyQRs();       // Tải danh sách + Storage count
            updateUI();              // Vẽ lại giao diện
        }

        async function loadUserProfile() {
            const ref = doc(db, "users", currentUser.uid);
            const snap = await getDoc(ref);
            const todayStr = new Date().toISOString().split('T')[0]; // Lấy ngày YYYY-MM-DD

            if (snap.exists()) {
                userProfile = snap.data();
                
                // Kiểm tra xem dữ liệu daily có phải của hôm nay không
                if (userProfile.lastActionDate !== todayStr) {
                    // Nếu là ngày cũ -> Reset daily count về 0
                    myDailyUsage = 0;
                    // Cập nhật lại vào DB luôn cho sạch
                    await updateDoc(ref, { dailyCount: 0, lastActionDate: todayStr });
                } else {
                    myDailyUsage = userProfile.dailyCount || 0;
                }
            } else {
                // User mới
                userProfile = { isPremium: false, dailyCount: 0, lastActionDate: todayStr };
                await setDoc(ref, userProfile);
                myDailyUsage = 0;
            }
        }

        async function loadMyQRs() {
            const q = query(collection(db, "qr_codes_v2"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            myStorageCount = snap.size;
            
            const tbody = document.getElementById('qrTableBody');
            tbody.innerHTML = '';
            snap.forEach(d => {
                const data = d.data();
                tbody.innerHTML += `<tr><td><img src="${data.imageUrl}" class="qr-thumb"></td><td><strong>${data.name}</strong><br><small class="text-muted">${data.destination.substring(0,15)}...</small></td><td>${data.views||0}</td><td><button class="btn btn-sm btn-outline-danger" onclick="delQr('${d.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        function updateUI() {
            document.getElementById('welcomeMsg').innerText = `Xin chào, ${currentUser.email}`;
            const planDiv = document.getElementById('planInfo');
            const btnCreate = document.getElementById('btnCreate');
            const storageEl = document.getElementById('storageQuota');
            const dailyEl = document.getElementById('dailyQuota');

            // 1. Render Gói Cước
            if (userProfile.isPremium) {
                // Kiểm tra hết hạn VIP
                const expiry = userProfile.expiryDate ? userProfile.expiryDate.toDate() : new Date();
                if(new Date() > expiry) {
                    userProfile.isPremium = false; // Downgrade về Free
                    planDiv.innerHTML = `<span class="badge bg-danger">Hết hạn VIP</span> <small>Về gói Free</small>`;
                } else {
                    planDiv.innerHTML = `<span class="vip-badge"><i class="fa-solid fa-crown"></i> VIP MEMBER</span>`;
                    // VIP thì ẩn giới hạn hiển thị
                    storageEl.innerText = "Không giới hạn";
                    dailyEl.innerText = "Không giới hạn";
                    btnCreate.disabled = false;
                    btnCreate.innerText = "Tạo ngay";
                    return; // VIP xong việc, thoát hàm
                }
            } else {
                planDiv.innerHTML = `<span class="badge bg-secondary">Gói FREE</span>`;
            }

            // 2. Render Giới hạn cho FREE USER
            storageEl.innerHTML = `<span class="${myStorageCount >= LIMITS.STORAGE ? 'quota-warning' : 'quota-active'}">${myStorageCount}/${LIMITS.STORAGE}</span>`;
            dailyEl.innerHTML = `<span class="${myDailyUsage >= LIMITS.DAILY ? 'quota-warning' : 'quota-active'}">${myDailyUsage}/${LIMITS.DAILY}</span>`;

            // 3. Logic Khóa Nút Tạo
            if (myStorageCount >= LIMITS.STORAGE) {
                btnCreate.disabled = true;
                btnCreate.innerText = "Kho đầy (Xóa bớt để tạo)";
            } else if (myDailyUsage >= LIMITS.DAILY) {
                btnCreate.disabled = true;
                btnCreate.innerText = "Hết lượt tạo hôm nay";
            } else {
                btnCreate.disabled = false;
                btnCreate.innerText = "Tạo ngay";
            }
        }

        // --- HÀNH ĐỘNG ---
        
        // Tạo QR
        document.getElementById('createQrForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Check lại lần cuối trước khi ghi DB (phòng hờ hack UI)
            if(!userProfile.isPremium) {
                if(myStorageCount >= LIMITS.STORAGE) return Swal.fire('Lỗi', 'Kho lưu trữ đã đầy (3/3).', 'error');
                if(myDailyUsage >= LIMITS.DAILY) return Swal.fire('Lỗi', 'Hôm nay bạn đã tạo hết 3 lượt.', 'error');
            }

            const btn = document.getElementById('btnCreate');
            btn.disabled = true;

            try {
                const name = document.getElementById('qrName').value;
                const dest = document.getElementById('qrDest').value;
                const shortId = Math.random().toString(36).substring(2, 8);
                const link = `${window.location.href.split('?')[0]}?id=${shortId}`;
                const qr = new QRious({ value: link, size: 200 });
                
                // 1. Tạo QR
                await addDoc(collection(db, "qr_codes_v2"), {
                    uid: currentUser.uid, shortId, name, destination: dest,
                    imageUrl: qr.toDataURL(), views: 0, createdAt: serverTimestamp()
                });

                // 2. Tăng biến đếm Daily (Nếu là Free)
                if(!userProfile.isPremium) {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, {
                        dailyCount: increment(1),
                        lastActionDate: new Date().toISOString().split('T')[0]
                    });
                }

                document.getElementById('createQrForm').reset();
                Swal.fire('Thành công', 'Đã tạo QR mới', 'success');
                await loadData(); // Reload để cập nhật số đếm
            } catch (err) {
                Swal.fire('Lỗi', err.message, 'error');
                btn.disabled = false;
            }
        });

        // Xóa QR
        window.delQr = async (id) => {
            if(confirm("Xóa mã này?")){
                await deleteDoc(doc(db, "qr_codes_v2", id));
                await loadData(); // Xóa xong load lại để giảm Storage Count
                Swal.fire('Đã xóa', 'Bạn đã có thêm chỗ trống trong kho.', 'success');
            }
        };

        // Đăng nhập / Đăng ký
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch {
                try { await createUserWithEmailAndPassword(auth, email, pass); } 
                catch(err) { Swal.fire('Lỗi', 'Đăng nhập/Đăng ký thất bại', 'error'); }
            }
        });

        // Test Nạp VIP
        window.simulatePayment = async () => {
            if(confirm("Xác nhận nạp VIP 30 ngày?")) {
                const nextMonth = new Date(); nextMonth.setDate(nextMonth.getDate() + 30);
                await updateDoc(doc(db, "users", currentUser.uid), { isPremium: true, expiryDate: nextMonth });
                await loadData();
                Swal.fire('Đã lên VIP', 'Giờ bạn không bị giới hạn gì nữa!', 'success');
            }
        };
        window.logout = () => signOut(auth);
    }
</script>
</body>
</html>
