<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm Tra Ch·ªçn L·ªçc CB (Selectivity Check)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a73e8; margin-bottom: 30px; }
        
        .control-panel { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
        .cb-box { flex: 1; min-width: 300px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fafafa; }
        .cb-box.main { border-left: 5px solid #d93025; } /* ƒê·ªè cho CB t·ªïng */
        .cb-box.branch { border-left: 5px solid #188038; } /* Xanh cho CB nh√°nh */
        
        h3 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9em; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        
        .result-section { text-align: center; padding: 20px; border-top: 2px dashed #ddd; }
        .status-badge { display: inline-block; padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 1.2em; margin-bottom: 15px; }
        .pass { background-color: #e6f4ea; color: #137333; border: 1px solid #ceead6; }
        .fail { background-color: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
        .warning { background-color: #fef7e0; color: #ea8600; border: 1px solid #fce8b2; }

        /* V√πng v·∫Ω ƒë·ªì th·ªã TCC */
        .chart-container { position: relative; height: 350px; width: 100%; border: 1px solid #eee; background: white; margin-top: 20px; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .legend { display: flex; justify-content: center; gap: 20px; font-size: 0.85em; margin-top: 10px; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        .explanation { text-align: left; background: #e8f0fe; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.95em; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚ö° Ki·ªÉm Tra T√≠nh Ch·ªçn L·ªçc (Selectivity)</h1>
    <p style="text-align: center; color: #666; margin-bottom: 20px;">
        M√¥ ph·ªèng ph·ªëi h·ª£p gi·ªØa CB T·ªïng (Upstream) v√† CB Nh√°nh (Downstream)
    </p>

    <div class="control-panel">
        <div class="cb-box main">
            <h3>üî¥ CB T·ªïng (Upstream)</h3>
            <div class="form-group">
                <label>Lo·∫°i CB:</label>
                <select id="mainType" onchange="toggleDelayOption()">
                    <option value="MCB">MCB (Aptomat t√©p)</option>
                    <option value="MCCB">MCCB (Aptomat kh·ªëi)</option>
                </select>
            </div>
            <div class="form-group">
                <label>D√≤ng ƒë·ªãnh m·ª©c (In) [A]:</label>
                <input type="number" id="mainIn" value="100" min="10">
            </div>
            <div class="form-group">
                <label>ƒê·∫∑c tuy·∫øn t·ª´ (Curve) / Ng∆∞·ª°ng c·∫Øt nhanh:</label>
                <select id="mainCurve">
                    <option value="C">Curve C (5-10 In)</option>
                    <option value="D">Curve D (10-20 In)</option>
                    <option value="K">Curve K/MA (12 In)</option>
                </select>
            </div>
            <div class="form-group" id="delayGroup" style="display:none;">
                <label>‚è±Ô∏è Th·ªùi gian tr·ªÖ ng·∫Øn m·∫°ch (Short Time Delay):</label>
                <select id="mainDelay">
                    <option value="0">Kh√¥ng tr·ªÖ (Instant)</option>
                    <option value="0.1">0.1s (100ms)</option>
                    <option value="0.2">0.2s (200ms)</option>
                    <option value="0.4">0.4s (400ms)</option>
                </select>
            </div>
        </div>

        <div class="cb-box branch">
            <h3>üü¢ CB Nh√°nh (Downstream)</h3>
            <div class="form-group">
                <label>Lo·∫°i CB:</label>
                <select id="branchType" disabled>
                    <option value="MCB" selected>MCB (Aptomat t√©p)</option>
                </select>
            </div>
            <div class="form-group">
                <label>D√≤ng ƒë·ªãnh m·ª©c (In) [A]:</label>
                <input type="number" id="branchIn" value="40" min="1">
            </div>
            <div class="form-group">
                <label>ƒê·∫∑c tuy·∫øn t·ª´ (Curve):</label>
                <select id="branchCurve">
                    <option value="B">Curve B (3-5 In) - D√¢n d·ª•ng</option>
                    <option value="C" selected>Curve C (5-10 In) - C√¥ng nghi·ªáp</option>
                </select>
            </div>
        </div>
    </div>

    <div class="result-section">
        <button onclick="checkSelectivity()" style="padding: 12px 30px; background: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; font-weight: bold;">KI·ªÇM TRA NGAY</button>
        
        <div id="resultOutput" style="margin-top: 20px;">
            </div>

        <div class="chart-container">
            <canvas id="tccCanvas"></canvas>
            <div style="position: absolute; bottom: 10px; right: 10px; font-size: 0.8em; color: #888;">Log-Log Scale (M√¥ ph·ªèng)</div>
        </div>
        <div class="legend">
            <span><span class="dot" style="background: red;"></span>ƒê·∫∑c tuy·∫øn CB T·ªïng</span>
            <span><span class="dot" style="background: green;"></span>ƒê·∫∑c tuy·∫øn CB Nh√°nh</span>
            <span><span class="dot" style="background: orange;"></span>V√πng ch·ªìng l·∫•n (M·∫•t ch·ªçn l·ªçc)</span>
        </div>
    </div>
</div>

<script>
    function toggleDelayOption() {
        const type = document.getElementById('mainType').value;
        const delayGroup = document.getElementById('delayGroup');
        // Ch·ªâ MCCB m·ªõi th∆∞·ªùng ch·ªânh ƒë∆∞·ª£c ƒë·ªô tr·ªÖ (tr√™n c√°c model ƒëi·ªán t·ª≠ ho·∫∑c Micrologic)
        if(type === 'MCCB') {
            delayGroup.style.display = 'block';
        } else {
            delayGroup.style.display = 'none';
            document.getElementById('mainDelay').value = "0";
        }
    }

    function checkSelectivity() {
        // 1. L·∫•y d·ªØ li·ªáu
        const mainIn = parseFloat(document.getElementById('mainIn').value);
        const branchIn = parseFloat(document.getElementById('branchIn').value);
        const mainType = document.getElementById('mainType').value;
        const mainCurve = document.getElementById('mainCurve').value;
        const branchCurve = document.getElementById('branchCurve').value;
        const timeDelay = parseFloat(document.getElementById('mainDelay').value || 0);

        const resultDiv = document.getElementById('resultOutput');
        
        // T√≠nh to√°n ng∆∞·ª°ng c·∫Øt t·ª´ (Magnetic Trip threshold - Im)
        // L·∫•y gi√° tr·ªã th·∫•p nh·∫•t c·ªßa d·∫£i (worst case)
        const getIm = (curve, In) => {
            if(curve === 'B') return 3 * In;
            if(curve === 'C') return 5 * In;
            if(curve === 'D') return 10 * In;
            if(curve === 'K') return 12 * In;
            return 10 * In; 
        };

        const branchIm = getIm(branchCurve, branchIn);
        const mainIm = getIm(mainCurve, mainIn);

        // 2. Logic ki·ªÉm tra
        let status = "";
        let message = "";
        let details = "";
        let selectivityType = "NONE"; // NONE, PARTIAL, TOTAL

        // RULE 1: D√≤ng ƒë·ªãnh m·ª©c
        if (branchIn >= mainIn) {
            status = "fail";
            message = "‚ùå KH√îNG ƒê·∫†T: CB Nh√°nh l·ªõn h∆°n ho·∫∑c b·∫±ng CB T·ªïng";
            details = "D√≤ng ƒë·ªãnh m·ª©c CB nh√°nh ph·∫£i nh·ªè h∆°n CB t·ªïng ƒë·ªÉ ƒë·∫£m b·∫£o c·∫•p ph·ªëi.";
        } else {
            // RULE 2: T·ª∑ l·ªá d√≤ng ƒëi·ªán (Rule of thumb 1.6x ho·∫∑c 2x)
            const ratio = mainIn / branchIn;
            
            if (ratio < 1.6) {
                status = "fail";
                message = "‚ö†Ô∏è C·∫¢NH B√ÅO: Kho·∫£ng c√°ch d√≤ng qu√° h·∫πp";
                details = `T·ª∑ l·ªá In T·ªïng/Nh√°nh l√† ${ratio.toFixed(1)}. Khuy·∫øn ngh·ªã t·ªëi thi·ªÉu l√† 1.6 ƒë·∫øn 2 l·∫ßn.`;
            } else {
                // RULE 3: Ki·ªÉm tra v√πng c·∫Øt nhanh (Short Circuit Selectivity)
                // ƒê√¢y l√† n∆°i x·∫£y ra xung ƒë·ªôt nhi·ªÅu nh·∫•t
                if (mainType === 'MCCB' && timeDelay > 0) {
                    // N·∫øu CB t·ªïng c√≥ Time Delay -> Ch·ªçn l·ªçc to√†n ph·∫ßn (theo l√Ω thuy·∫øt gi·∫£ ƒë·ªãnh)
                    status = "pass";
                    message = "‚úÖ ƒê·∫†T: CH·ªåN L·ªåC TO√ÄN PH·∫¶N (Total Selectivity)";
                    details = "CB T·ªïng ƒë∆∞·ª£c c√†i ƒë·∫∑t tr·ªÖ th·ªùi gian. Khi s·ª± c·ªë x·∫£y ra, CB T·ªïng s·∫Ω 'ch·ªù' ƒë·ªÉ CB Nh√°nh c·∫Øt tr∆∞·ªõc. ƒê√¢y l√† gi·∫£i ph√°p t·ªëi ∆∞u nh∆∞ trong h√¨nh ·∫£nh c·ªßa b·∫°n.";
                    selectivityType = "TOTAL";
                } else {
                    // So s√°nh ng∆∞·ª°ng c·∫Øt t·ª´
                    if (mainIm > 1.5 * branchIm) {
                         status = "pass";
                         message = "‚úÖ ƒê·∫†T: Ch·ªçn l·ªçc Ampe (Amperometric Selectivity)";
                         details = `Ng∆∞·ª°ng c·∫Øt nhanh c·ªßa CB T·ªïng (${mainIm}A) cao h∆°n ƒë√°ng k·ªÉ so v·ªõi CB Nh√°nh (${branchIm}A). Ch·ªçn l·ªçc t·ªët ·ªü v√πng qu√° t·∫£i v√† ng·∫Øn m·∫°ch nh·ªè.`;
                         selectivityType = "TOTAL"; // Gi·∫£ ƒë·ªãnh ƒë∆°n gi·∫£n cho tool
                    } else {
                        status = "warning";
                        message = "‚ö†Ô∏è CH·ªåN L·ªåC M·ªòT PH·∫¶N (Partial Selectivity)";
                        details = `·ªû d√≤ng ng·∫Øn m·∫°ch l·ªõn (>${mainIm}A), c·∫£ hai CB c√≥ th·ªÉ nh·∫£y c√πng l√∫c v√¨ ƒë·∫∑c tuy·∫øn c·∫Øt nhanh ch·ªìng l·∫•n nhau. C·∫ßn tƒÉng d√≤ng CB t·ªïng ho·∫∑c d√πng lo·∫°i c√≥ Time Delay.`;
                        selectivityType = "PARTIAL";
                    }
                }
            }
        }

        // Render K·∫øt qu·∫£
        let badgeClass = status === 'pass' ? 'pass' : (status === 'fail' ? 'fail' : 'warning');
        resultDiv.innerHTML = `
            <div class="status-badge ${badgeClass}">${message}</div>
            <div class="explanation">${details}</div>
        `;

        // V·∫Ω bi·ªÉu ƒë·ªì
        drawTCC(mainIn, branchIn, mainIm, branchIm, timeDelay, selectivityType);
    }

    function drawTCC(mainIn, branchIn, mainIm, branchIm, delay, type) {
        const canvas = document.getElementById('tccCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height = canvas.offsetHeight;

        // X√≥a canvas
        ctx.clearRect(0, 0, w, h);

        // Thi·∫øt l·∫≠p h·ªá t·ªça ƒë·ªô gi·∫£ l·∫≠p (Log-Log)
        // Tr·ª•c X: D√≤ng ƒëi·ªán (Current), Tr·ª•c Y: Th·ªùi gian (Time)
        const margin = 40;
        
        // V·∫Ω tr·ª•c
        ctx.beginPath();
        ctx.strokeStyle = "#888";
        ctx.lineWidth = 1;
        ctx.moveTo(margin, 10); ctx.lineTo(margin, h - margin); // Y axis
        ctx.moveTo(margin, h - margin); ctx.lineTo(w - 10, h - margin); // X axis
        ctx.stroke();
        
        ctx.fillStyle = "#666";
        ctx.fillText("Time (s)", 10, 20);
        ctx.fillText("Current (A)", w - 60, h - 20);

        // H√†m chuy·ªÉn ƒë·ªïi gi√° tr·ªã sang t·ªça ƒë·ªô Canvas (M√¥ ph·ªèng Log)
        // Ch√∫ng ta map d·∫£i d√≤ng t·ª´ 0 -> 2000A v√†o chi·ªÅu r·ªông
        // Map th·ªùi gian t·ª´ 0.01s -> 1000s v√†o chi·ªÅu cao
        const mapX = (amps) => margin + (Math.log10(amps) * (w - margin) / 4.5); // 4.5 l√† log10 c·ªßa max Amps gi·∫£ ƒë·ªãnh
        const mapY = (time) => (h - margin) - (Math.log10(time * 100) * (h - margin) / 5); 

        // H√†m v·∫Ω ƒë∆∞·ªùng Curve L (Thermal + Magnetic)
        function drawCurve(In, Im, color, isDelayed, delayVal) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;

            // 1. Ph·∫ßn qu√° t·∫£i (Thermal - ƒë∆∞·ªùng ch√©o xu·ªëng)
            // Gi·∫£ l·∫≠p ƒë∆∞·ªùng cong: t = k / I^2
            let startI = In * 1.13;
            ctx.moveTo(mapX(startI), mapY(1000)); // B·∫Øt ƒë·∫ßu t·ª´ tr√™n cao
            
            // V·∫Ω ƒë∆∞·ªùng cong xu·ªëng ƒëi·ªÉm c·∫Øt t·ª´
            // ƒê∆°n gi·∫£n h√≥a th√†nh ƒë∆∞·ªùng th·∫≥ng ch√©o tr√™n log scale cho demo
            ctx.lineTo(mapX(Im), mapY(0.1)); 

            // 2. Ph·∫ßn c·∫Øt nhanh (Magnetic - ƒë∆∞·ªùng th·∫≥ng ƒë·ª©ng xu·ªëng)
            if (isDelayed && delayVal > 0) {
                // N·∫øu c√≥ Delay (CB T·ªïng MCCB ch·ªânh ƒë·ªãnh)
                // Gi·ªØ m·ª©c th·ªùi gian ·ªü delayVal m·ªôt ƒëo·∫°n
                let magneticTime = delayVal; 
                ctx.lineTo(mapX(Im), mapY(magneticTime)); // Xu·ªëng ƒë·∫øn m·ª©c delay
                ctx.lineTo(mapX(Im * 10), mapY(magneticTime)); // K√©o ngang (Short Time Delay)
                ctx.lineTo(mapX(Im * 10), mapY(0.01)); // C·∫Øt t·ª©c th·ªùi (Instantaneous) ·ªü d√≤ng r·∫•t l·ªõn
            } else {
                // C·∫Øt t·ª©c th·ªùi (MCB th∆∞·ªùng)
                ctx.lineTo(mapX(Im), mapY(0.01)); // R∆°i th·∫≥ng xu·ªëng ƒë√°y
            }

            ctx.stroke();
        }

        // V·∫Ω Branch Curve (Xanh)
        // Branch lu√¥n l√† MCB c·∫Øt nhanh
        drawCurve(branchIn, branchIm, "green", false, 0);

        // V·∫Ω Main Curve (ƒê·ªè)
        drawCurve(mainIn, mainIm, "red", true, delay);

        // ƒê√°nh d·∫•u v√πng xung ƒë·ªôt n·∫øu c√≥
        if (type === 'PARTIAL' || type === 'NONE') {
            ctx.fillStyle = "rgba(255, 165, 0, 0.3)";
            ctx.beginPath();
            // V√πng tam gi√°c ch·ªìng l·∫•n gi·∫£ ƒë·ªãnh
            let xOverlap = mapX(mainIm);
            let yOverlap = mapY(0.02);
            ctx.rect(xOverlap, yOverlap, 50, 100); 
            ctx.fill();
            ctx.fillStyle = "orange";
            ctx.fillText("Xung ƒë·ªôt!", xOverlap, yOverlap - 5);
        }
    }
    
    // Ch·∫°y l·∫ßn ƒë·∫ßu
    toggleDelayOption();
</script>

</body>
</html>