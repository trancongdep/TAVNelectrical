<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - TAVIETNAM (Final Gold)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CẤU HÌNH GIAO DIỆN --- */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: #f4f6f8; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: #2c3e50; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 200; }
        .header-title h2 { margin: 0; font-size: 18px; }

        /* LAYOUT */
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 340px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 100; box-shadow: 2px 0 5px rgba(0,0,0,0.05); transition: all 0.3s; }
        
        /* FORM NHẬP LIỆU */
        .form-section { border-bottom: 2px solid #f1f1f1; background: #fff; }
        .form-header { padding: 10px 15px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 13px; color: #555; user-select: none; }
        .form-header:hover { background: #e9ecef; }
        
        .form-content { padding: 15px; overflow-y: auto; max-height: 60vh; display: block; }
        .form-content.hidden { display: none; }

        .form-group { margin-bottom: 8px; }
        .form-group label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 3px; color: #666; }
        .form-group input, .form-group select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; box-sizing: border-box; }
        .form-group input:focus { border-color: #007bff; outline: none; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 5px; margin-top: 15px; }
        button { flex: 1; padding: 8px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-new { background: #3498db; color: white; } .btn-new:hover { background: #2980b9; }
        .btn-save { background: #27ae60; color: white; } .btn-save:hover { background: #219150; }
        .btn-del { background: #e74c3c; color: white; } .btn-del:hover { background: #c0392b; }
        
        .btn-extent    .btn-exte: #8e44ad; ound:: 8e44a;  colo:  whi; ; width: 1:0%;; argin-t: :5p;  paddi: : 8p;  borde:  none; ; rsor: pointer: bor; r-radius:: px; ; nt-size: 11: ; fo; -weight: bold; display: fl: ; alig; items: center; : stify-; nte: : c;n
        .5px;}
    :   .b n extent:hov: #732d91; o

        91; }

   
        .ST */
        .list-h: der   pad; ng: 10px 1: #f8f9fa; ound: #f8f9: ; fo; -weight: : ld; ; nt-size: 13px: bor er-bo #eee; p
        .ee; }
        .dev: e; ist { flex: 1; o; rflow-y: a; o
        . 0; }
        .device: tem   pad; ng: 10px 15px: bor er-bo #eee; px sol:  #eee; ; rsor: p: nter; display: fl: ; alig; items: center; : stify-content; space-bet: en; ; n
        .px; }
     :  .de i e-item:hov: #f1f8ff; o
        .ff; }
     .  .devic - tem.select: #e3f2fd; ound: #e3f2: ; b rder- #007bff; s
        .ff; }         .: dge { p; ding: 2px 6px: bor; r-radius:: px; ; nt-si: : 10p;  color: w: te; ; n-width: 3: x; tex; align: cent: ; fo;t

        old;}

        /*
        .OR */
        .mai: e; tor { f: x: 1; display: flex;: lex-di; ction: c: umn; pos; ion: rel: ive; o; r
        .en; }
        .editor: abs ; display: f: #e9ecef; ound: #e9ecef: bor er-bo #ddd; px solid #d: ;; l
        . 0; }
        .ta: btn   pad; ng: 10:  20px; ; rsor: : inte;  border: n: e; b; kground: no: ; fo; -weig: #666; ;
        .66; }
 .       t b-btn.acti:  { ba; groun: #007bff; olor: #007: f;  order #007bff; s
        .ff; }
         e itor: o; ent { fl: : 1; pos; ion: re: tive; display:: one; o; r
        .en; }
        .editor c ntent.a: ive {; i

        ck; }

        /
        #AS */
        #view: ld {; verflow: a: #ccc; k 
        #c; } 
       
            { 
  :       ; width:: 000px;; 
            ; 
            b: kgrou;
            e;
            b: kground-image: r#999 -gr, ient(#999 1 x, t; 
            ; 
            : ckgr und-; 
            ; 
     :      pos; 
        t
        
              
        /*
        .ES */
      
             {
     :      pos; ion: : solu; ; widt:  80p; 
            ; 
       :    ba; ground: whi e; bo #333; 
            ; 
    :     ; display: flex;: lex-di; ction: colu: ; alig; items: center; : stify-; ntent: cen: r; tex;
            r;
      :     ; nt-siz:  10p;  cursor: gr: ; us; -select: no;
            0;
       :     ox- had w: 2px,2,x,5px ; ba(0,0,0,0.1): bor;
        :
        .    }
    :   .a m n-node:hover: #007bff; olor: #00: ff; transfo; :
        .2); }
    .   .admin-nod . electe: nod  { bo #007bff; solid #: 7b; ; z-index:: 0   ox-s adow: , 0 ,0px,rgba; ,
        .5); }
    :   .ad i -node:: tive { c; s

        ng; }

        /* TRẠNG THÁI MÀU SẮC 
        .G) */
         e ergized-node { b: #ffccbc color: #ff; b
        .nt; }
         e ergized-line { b: #ff3d00 color: #ff; 00 !imp: t nt; z-inde;    !important;
        .am */
        .dead-line { b: #95a5a6 color: #95; a6 !imp: t; t  z-index:

        ám */

        /* L
        .BỊ */
        .type-source : bor; r-radius: 50: #1565c0; olor: #156: #e3f2fd; ound:: e3f2; ; widt:  60p;  
        .px; }
        .ty: -bus { height: ; px !import: #2c3e50; ound: : c3e5;  bord: : non;  width: 300px: bor; r
        .px; }
  .     .type-bus e ergized-node { b: #ff3d00 color: #ff; 00 !import: t   ox-s #ff3d00;  
        .00; }
        .type-f:  {  order #e74c3c; s
        .3c; }
        .t: e-t  { bor #333; x doub:  #33;  heig: : 60; ;

        px; }

   
        .RE * 
        .: re { pos; ion: a: olu; ; height: 3px; t: n f; m-origin: 0 0;: oint; -events: n: e; transition: b ckgr; n
        
        #map-canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>

<header>
    <div class="header-title">
        <h2><i class="fas fa-bolt"></i> Admin Panel</h2>
    </div>
    <div style="font-size: 12px; color: #ccc;">
        Trạng thái: <span id="status-msg" style="color:#f1c40f">Đang kết nối...</span>
    </div>
</header>

<div class="container">
    <div class="sidebar">
        <div class="form-section">
            <div class="form-header" onclick="toggleForm()">
                <span><i class="fas fa-edit"></i> Thông tin thiết bị</span>
                <i class="fas fa-chevron-up" id="toggle-icon"></i>
            </div>
            <div class="form-content" id="form-content">
                <div class="form-group">
                    <label>ID Thiết bị (Duy nhất)</label>
                    <input type="text" id="inp-id" placeholder="VD: CB-01">
                </div>
                <div class="form-group">
                    <label>Tên hiển thị</label>
                    <input type="text" id="inp-label" placeholder="VD: Máy cắt tổng">
                </div>
                
                <div class="row">
                    <div class="col form-group">
                        <label>Loại</label>
                        <select id="inp-type">
                            <optgroup label="Đóng cắt">
                                <option value="cb">CB (Máy cắt)</option>
                                <option value="fco">FCO (Cầu chì)</option>
                                <option value="ds">DS (Dao cách ly)</option>
                            </optgroup>
                            <optgroup label="Thiết bị chính">
                                <option value="source">Nguồn (Source)</option>
                                <option value="bus">Busbar (Thanh cái)</option>
                                <option value="tr">Máy biến áp</option>
                            </optgroup>
                            <optgroup label="Phụ tải">
                                <option value="load">Tải (Load)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="col form-group">
                        <label>Nguồn cấp</label>
                        <select id="inp-parent"><option value="">-- Gốc --</option></select>
                    </div>
                </div>

                <div class="row">
                    <div class="col form-group">
                        <label>SLD X</label>
                        <input type="number" id="inp-x">
                    </div>
                    <div class="col form-group">
                        <label>SLD Y</label>
                        <input type="number" id="inp-y">
                    </div>
                </div>
                
                <button type="button" class="btn-extent" onclick="zoomExtent()">
                    <i class="fas fa-compress-arrows-alt"></i> Gom về khung nhìn (Fix văng)
                </button>

                <div class="row" style="margin-top:10px;">
                    <div class="col form-group">
                        <label>Vĩ độ (Lat)</label>
                        <input type="number" id="inp-lat" step="0.000001">
                    </div>
                    <div class="col form-group">
                        <label>Kinh độ (Lng)</label>
                        <input type="number" id="inp-lng" step="0.000001">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn-new" onclick="resetForm()"><i class="fas fa-plus"></i> Mới</button>
                    <button class="btn-save" onclick="saveDevice()"><i class="fas fa-save"></i> Lưu</button>
                    <button class="btn-del" onclick="deleteDevice()"><i class="fas fa-trash"></i> Xóa</button>
                </div>
            </div>
        </div>

        <div class="list-header">Danh sách thiết bị</div>
        <div class="device-list" id="device-list-container"></div>
    </div>

    <div class="main-editor">
        <div class="editor-tabs">
            <button class="tab-btn active" onclick="switchTab('sld')"><i class="fas fa-project-diagram"></i> SLD Editor</button>
            <button class="tab-btn" onclick="switchTab('map')"><i class="fas fa-map-marked-alt"></i> Map Editor</button>
        </div>

        <div id="view-sld" class="editor-content active">
            <div id="sld-canvas"></div>
        </div>
        <div id="view-map" class="editor-content">
            <div id="map-canvas"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, remove } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
        authDomain: "tavietnam-78ae8.firebaseapp.com",
        projectId: "tavietnam-78ae8",
        storageBucket: "tavietnam-78ae8.firebasestorage.app",
        messagingSenderId: "670121705534",
        appId: "1:670121705534:web:1027ad98550573ad37116f",
        databaseURL: "https://tavietnam-78ae8-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // VARS
    let allDevices = [];
    let selectedId = null;
    let mapMarkers = {};
    let mapPolylines = [];

    // INIT MAP
    const map = L.map('map-canvas').setView([10.8231, 106.6297], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    window.refreshMap = function() { setTimeout(() => { map.invalidateSize(); }, 200); }

    // DATA SYNC
    onValue(ref(db, 'system_nodes'), (snapshot) => {
        const data = snapshot.val();
        allDevices = data ? Object.values(data) : [];
        
        // 1. TÍNH TOÁN ĐIỆN NGAY KHI CÓ DỮ LIỆU
        calculatePower();
        
        const listContainer = document.getElementById('device-list-container');
        const scrollPos = listContainer.scrollTop; 
        
        renderTable();
        listContainer.scrollTop = scrollPos;
        updateParentSelect();
        renderSLD();
        renderMap();
        
        document.getElementById('status-msg').innerText = "Đã đồng bộ";
        document.getElementById('status-msg').style.color = "#2ecc71";
    });

    // --- LOGIC POWER FLOW (QUAN TRỌNG) ---
    function calculatePower() {
        // 1. Reset
        allDevices.forEach(n => n.isEnergized = false);
        
        // 2. Nguồn luôn có điện
        const queue = allDevices.filter(n => n.type === 'source');
        queue.forEach(n => n.isEnergized = true);

        // 3. BFS (Lan truyền)
        while (queue.length > 0) {
            const current = queue.shift();
            
            // Nếu thiết bị này DẪN ĐIỆN, truyền cho con
            if (isConductive(current)) {
                const children = allDevices.filter(n => n.parent === current.id);
                children.forEach(child => {
                    if (!child.isEnergized) {
                        child.isEnergized = true;
                        queue.push(child);
                    }
                });
            }
        }
    }
    
    function isConductive(node) {
        // Nguồn, Busbar, Biến áp, Tải luôn dẫn (coi như closed internal)
        if (['source', 'bus', 'tr', 'load'].includes(node.type)) return true;
        // Các thiết bị đóng cắt phải Closed
        if (['cb', 'ds', 'fco'].includes(node.type)) return node.state === 'closed';
        return false;
    }

    // --- UI FUNCTIONS ---
    window.toggleForm = function() {
        const content = document.getElementById('form-content');
        const icon = document.getElementById('toggle-icon');
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.className = 'fas fa-chevron-up';
        } else {
            content.classList.add('hidden');
            icon.className = 'fas fa-chevron-down';
        }
    }

    function renderTable() {
        const container = document.getElementById('device-list-container');
        container.innerHTML = '';
        allDevices.forEach(d => {
            const div = document.createElement('div');
            div.className = `device-item ${d.id === selectedId ? 'selected' : ''}`;
            let color = '#7f8c8d';
            if (d.type === 'source') color = '#3498db';
            if (d.type === 'cb') color = '#2c3e50';
            if (d.type === 'bus') color = '#27ae60';
            div.innerHTML = `<div><strong>${d.id}</strong><br><span style="color:#666">${d.label}</span></div><span class="badge" style="background:${color}">${d.type.toUpperCase()}</span>`;
            div.onclick = () => selectDevice(d, false);
            div.ondblclick = () => selectDevice(d, true); 
            container.appendChild(div);
        });
    }

    function updateParentSelect() {
        const sel = document.getElementById('inp-parent');
        const currentVal = sel.value; 
        sel.innerHTML = '<option value="">-- Gốc --</option>';
        allDevices.forEach(d => {
            if (d.id !== selectedId) {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.innerText = `${d.id} (${d.label})`;
                sel.appendChild(opt);
            }
        });
        sel.value = currentVal;
    }

    window.selectDevice = function(device, forceZoom = false) {
        selectedId = device.id;
        document.getElementById('inp-id').value = device.id;
        document.getElementById('inp-id').disabled = true; 
        document.getElementById('inp-label').value = device.label;
        document.getElementById('inp-type').value = device.type;
        updateParentSelect();
        document.getElementById('inp-parent').value = device.parent || "";
        document.getElementById('inp-x').value = device.sld.x;
        document.getElementById('inp-y').value = device.sld.y;
        document.getElementById('inp-lat').value = device.geo ? device.geo.lat : 0;
        document.getElementById('inp-lng').value = device.geo ? device.geo.lng : 0;

        document.getElementById('form-content').classList.remove('hidden');
        document.getElementById('toggle-icon').className = 'fas fa-chevron-up';

        renderTable(); 
        renderSLD();
        if (mapMarkers[device.id]) {
            mapMarkers[device.id].openPopup();
            if (forceZoom && device.geo) map.flyTo([device.geo.lat, device.geo.lng], 18);
        }
    }

    window.zoomExtent = function() {
        if (allDevices.length === 0) return alert("Chưa có thiết bị nào!");
        let minX = Infinity; let minY = Infinity;
        allDevices.forEach(d => { if (d.sld.x < minX) minX = d.sld.x; if (d.sld.y < minY) minY = d.sld.y; });
        const shiftX = 50 - minX; const shiftY = 50 - minY;
        const updates = {};
        allDevices.forEach(d => {
            updates['system_nodes/' + d.id + '/sld/x'] = d.sld.x + shiftX;
            updates['system_nodes/' + d.id + '/sld/y'] = d.sld.y + shiftY;
        });
        update(ref(db), updates).then(() => {
            if (selectedId) {
                const current = allDevices.find(d => d.id === selectedId);
                if (current) {
                    document.getElementById('inp-x').value = current.sld.x + shiftX;
                    document.getElementById('inp-y').value = current.sld.y + shiftY;
                }
            }
        });
    }

    window.resetForm = function() {
        selectedId = null; 
        document.getElementById('inp-id').value = "";
        document.getElementById('inp-id').disabled = false;
        document.getElementById('inp-label').value = "";
        document.getElementById('inp-parent').value = "";
        const center = map.getCenter();
        document.getElementById('inp-lat').value = center.lat.toFixed(6);
        document.getElementById('inp-lng').value = center.lng.toFixed(6);
        document.getElementById('inp-x').value = 100;
        document.getElementById('inp-y').value = 100;
        renderTable(); renderSLD(); document.getElementById('inp-id').focus();
    }

    window.saveDevice = function() {
        const id = document.getElementById('inp-id').value.trim();
        if(!id) return alert("Vui lòng nhập ID!");
        const newData = {
            id: id,
            label: document.getElementById('inp-label').value,
            type: document.getElementById('inp-type').value,
            parent: document.getElementById('inp-parent').value || null,
            state: "closed",
            sld: {
                x: parseInt(document.getElementById('inp-x').value) || 0,
                y: parseInt(document.getElementById('inp-y').value) || 0
            },
            geo: {
                lat: parseFloat(document.getElementById('inp-lat').value) || map.getCenter().lat,
                lng: parseFloat(document.getElementById('inp-lng').value) || map.getCenter().lng
            }
        };
        set(ref(db, 'system_nodes/' + id), newData).then(() => selectDevice(newData, false)).catch(e => alert("Lỗi: " + e.message));
    }

    window.deleteDevice = function() {
        if(!selectedId) return alert("Chọn thiết bị!");
        if(confirm(`Xóa ${selectedId}?`)) { remove(ref(db, 'system_nodes/' + selectedId)); resetForm(); }
    }

    // --- SLD RENDER ---
    const sldCanvas = document.getElementById('sld-canvas');
    function renderSLD() {
        sldCanvas.innerHTML = '';
        
        // 1. VẼ DÂY
        allDevices.forEach(d => {
            if(d.parent) {
                const p = allDevices.find(x => x.id == d.parent);
                if(p) {
                    // Logic màu: Cha có điện VÀ Cha dẫn điện = Dây đỏ
                    const isLive = p.isEnergized && isConductive(p);
                    drawWire(p, d, isLive ? 'energized-line' : 'dead-line');
                }
            }
        });

        // 2. VẼ NODE
        allDevices.forEach(d => {
            const el = document.createElement('div');
            el.className = `admin-node type-${d.type} ${d.id === selectedId ? 'selected-node' : ''}`;
            el.style.left = d.sld.x + 'px';
            el.style.top = d.sld.y + 'px';
            
            let content = `<b>${d.id}</b><br>${d.label}`;
            if (d.type === 'bus') content = `<span style="color:white; font-size:9px">${d.id}</span>`;
            el.innerHTML = content;

            if(d.isEnergized) el.classList.add('energized-node'); 

            // Drag Logic
            el.onmousedown = function(e) {
                e.preventDefault(); e.stopPropagation();
                if(d.id !== selectedId) selectDevice(d, false);
                const startMX = e.clientX, startMY = e.clientY, startNX = d.sld.x, startNY = d.sld.y;
                function onMM(ev) {
                    let nx = startNX + (ev.clientX - startMX), ny = startNY + (ev.clientY - startMY);
                    nx = Math.max(0, Math.round(nx/10)*10); ny = Math.max(0, Math.round(ny/10)*10);
                    el.style.left = nx + 'px'; el.style.top = ny + 'px';
                    document.getElementById('inp-x').value = nx; document.getElementById('inp-y').value = ny;
                }
                document.addEventListener('mousemove', onMM);
                document.onmouseup = function() { document.removeEventListener('mousemove', onMM); el.onmouseup = null; saveDevice(); };
            };
            sldCanvas.appendChild(el);
        });
    }

    // --- HÀM VẼ DÂY BUSBAR ---
    function drawWire(p, c, cls) {
        // Kích thước
        let pW = (p.type==='bus') ? 300 : (p.type==='source'||p.type==='tr'?60:80); 
        let pH = (p.type==='bus') ? 12 : (p.type==='source'||p.type==='tr'?60:50);
        let cW = (c.type==='bus') ? 300 : (c.type==='source'||c.type==='tr'?60:80); 
        let cH = (c.type==='bus') ? 12 : (c.type==='source'||c.type==='tr'?60:50);

        let x1, y1, x2, y2;
        // Điểm neo Busbar: Tự động trượt theo chiều ngang để thẳng hàng
        if (p.type === 'bus') {
            let idealX = c.sld.x + cW/2;
            x1 = Math.max(p.sld.x, Math.min(p.sld.x + pW, idealX)); 
            y1 = p.sld.y + pH;
        } else { x1 = p.sld.x + pW/2; y1 = p.sld.y + pH; }

        if (c.type === 'bus') {
            let idealX = x1;
            x2 = Math.max(c.sld.x, Math.min(c.sld.x + cW, idealX)); 
            y2 = c.sld.y;
        } else { x2 = c.sld.x + cW/2; y2 = c.sld.y; }

        const midY = y1 + (y2 - y1) / 2;
        createWireSegment(x1, y1, x1, midY, cls); 
        createWireSegment(x1, midY, x2, midY, cls); 
        createWireSegment(x2, midY, x2, y2, cls);
    }
    
    function createWireSegment(x1,y1,x2,y2,cls) {
        if(Math.abs(x1-x2)<1 && Math.abs(y1-y2)<1) return;
        const d = document.createElement('div'); 
        d.className = 'wire ' + cls;
        d.style.left = Math.min(x1,x2)+'px'; d.style.top = Math.min(y1,y2)+'px';
        d.style.width = (Math.abs(x2-x1)||3)+'px'; d.style.height = (Math.abs(y2-y1)||3)+'px';
        sldCanvas.appendChild(d);
    }

    // --- MAP RENDER ---
    function renderMap() {
        for(let id in mapMarkers) map.removeLayer(mapMarkers[id]); mapPolylines.forEach(l=>map.removeLayer(l));
        mapMarkers={}; mapPolylines=[];
        
        allDevices.forEach(d => {
            if(d.parent && d.geo) {
                const p = allDevices.find(x=>x.id==d.parent);
                if(p && p.geo) {
                    const isLive = p.isEnergized && isConductive(p);
                    const color = isLive ? '#ff3d00' : '#95a5a6';
                    const w = isLive ? 4 : 2;
                    mapPolylines.push(L.polyline([[p.geo.lat,p.geo.lng],[d.geo.lat,d.geo.lng]], {color:color, weight:w}).addTo(map));
                }
            }
        });

        allDevices.forEach(d => {
            if(!d.geo) return;
            let color = d.isEnergized ? '#ff3d00' : '#666'; 
            if(d.isEnergized && d.state==='closed') color = '#d32f2f'; 
            const html = `<div style="background:${d.isEnergized?'#fff':'#eee'}; border:2px solid ${color}; padding:2px; font-weight:bold; font-size:10px; text-align:center;">${d.label}</div>`;
            const icon = L.divIcon({className:'', html:html, iconSize:[60,20]});
            const m = L.marker([d.geo.lat,d.geo.lng], {draggable:true, icon:icon}).addTo(map);
            m.on('click', ()=>selectDevice(d,false));
            m.on('dragend', ()=>{
                const pos = m.getLatLng(); if(selectedId!==d.id) selectDevice(d,false);
                document.getElementById('inp-lat').value=pos.lat.toFixed(6); document.getElementById('inp-lng').value=pos.lng.toFixed(6); saveDevice();
            });
            mapMarkers[d.id] = m;
        });
    }

    window.switchTab = function(t){
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.editor-content').forEach(c=>c.classList.remove('active'));
        if(t==='sld'){document.querySelector('button[onclick="switchTab(\'sld\')"]').classList.add('active');document.getElementById('view-sld').classList.add('active');}
        else{document.querySelector('button[onclick="switchTab(\'map\')"]').classList.add('active');document.getElementById('view-map').classList.add('active');window.refreshMap();}
    }
</script>
</body>
</html>
