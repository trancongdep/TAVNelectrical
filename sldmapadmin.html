<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Số hóa (No Storage Version)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #map-container { flex: 2; position: relative; }
        #map { width: 100%; height: 100%; }
        #sidebar {
            flex: 1; min-width: 350px; max-width: 400px;
            background: #f8f9fa; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; padding: 15px;
            overflow-y: auto;
        }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h3 { margin: 0 0 15px 0; font-size: 18px; color: #d32f2f; display: flex; align-items: center; gap: 8px; }
        h4 { margin: 10px 0 5px 0; font-size: 14px; color: #1a73e8; text-transform: uppercase; }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #555; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-top: 5px; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-success { background: #2e7d32; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        #preview-area { display: none; margin-top: 10px; border: 2px dashed #ccc; padding: 5px; text-align: center; }
        #final-image { max-width: 100%; display: block; }
        /* Modal Crop */
        #crop-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify_content: center; }
        .crop-wrapper { width: 90%; height: 80%; }
        .crop-controls { margin-top: 10px; display: flex; gap: 10px; }
        /* Debug Console */
        #debug-console { background: #222; color: #0f0; font-family: monospace; font-size: 11px; padding: 10px; border-radius: 5px; margin-top: 20px; height: 150px; overflow-y: auto; border: 1px solid #444; }
        .log-error { color: #ff5555; }
        .log-success { color: #55ff55; }
    </style>
</head>
<body>

<div id="container">
    <div id="map-container"><div id="map"></div></div>
    <div id="sidebar">
        <h3><i class="bi bi-tools"></i> Nhập Liệu (Bản Free)</h3>
        
        <div class="card">
            <h4>1. Nhập từ Street View</h4>
            <div class="form-group">
                <label>URL Google Maps:</label>
                <input type="text" id="gmap-url" placeholder="Paste link..." onchange="parseGoogleUrl()">
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex:1"><label>Góc (Heading):</label><input type="number" id="heading" step="0.1"></div>
                <div class="form-group" style="flex:1"><label>Xa (m):</label><input type="number" id="distance" value="10" min="1"></div>
            </div>
            <button class="btn btn-secondary" onclick="calculateTarget()">Tính vị trí</button>
        </div>

        <div class="card">
            <h4>2. Thông tin & Ảnh</h4>
            <form id="pole-form">
                <div class="form-group"><label>Tọa độ:</label><input type="text" id="pole-coords" readonly style="background:#e9ecef"></div>
                <div class="form-group"><label>Loại:</label><select id="pole-type"><option value="betong_li_tam">Bê tông ly tâm</option><option value="thep">Trụ thép</option></select></div>
                
                <div class="form-group">
                    <label>Ảnh (Sẽ nén nhỏ để lưu DB):</label>
                    <button type="button" class="btn btn-primary" id="btn-capture"><i class="bi bi-camera"></i> Chọn cửa sổ Maps</button>
                    <div id="preview-area"><img id="final-image"></div>
                </div>

                <div class="form-group"><label>Ghi chú:</label><textarea id="notes" rows="2"></textarea></div>
                <button type="submit" class="btn btn-success" id="btn-save">Lưu dữ liệu</button>
            </form>
        </div>
        <div id="debug-console"><div>> Sẵn sàng...</div></div>
    </div>
</div>

<div id="crop-modal">
    <div class="crop-wrapper"><img id="image-to-crop" style="max-width: 100%;"></div>
    <div class="crop-controls">
        <button class="btn btn-primary" id="btn-crop-confirm">Xác nhận</button>
        <button class="btn btn-secondary" onclick="closeCropModal()">Hủy</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script type="module">
    // Chỉ Import Firestore, KHÔNG import Storage
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, GeoPoint } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    function logToScreen(msg, type = 'info') {
        const d = document.getElementById('debug-console');
        const e = document.createElement('div');
        e.textContent = `> ${msg}`;
        if(type === 'error') e.className = 'log-error';
        if(type === 'success') e.className = 'log-success';
        d.appendChild(e);
        d.scrollTop = d.scrollHeight;
    }

    const firebaseConfig = {
        apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
        authDomain: "tavietnam-78ae8.firebaseapp.com",
        projectId: "tavietnam-78ae8",
        storageBucket: "tavietnam-78ae8.firebasestorage.app",
        messagingSenderId: "670121705534",
        appId: "1:670121705534:web:1027ad98550573ad37116f"
    };

    let app, db;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        logToScreen("Đã kết nối Firestore (Chế độ lưu ảnh trực tiếp)", "success");
    } catch (e) {
        logToScreen("Lỗi Config: " + e.message, "error");
    }

    // --- MAP LOGIC ---
    const map = L.map('map').setView([10.7769, 106.7009], 16);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png').addTo(map);

    let cameraMarker, poleMarker, connectionLine;

    window.parseGoogleUrl = function() {
        const url = document.getElementById('gmap-url').value;
        const match = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+).+?(\d+(\.\d+)?)h/);
        if (match) {
            updateCameraPosition(parseFloat(match[1]), parseFloat(match[2]));
            document.getElementById('heading').value = match[3];
            calculateTarget();
        } else { alert("Link không đúng định dạng Street View"); }
    }

    function updateCameraPosition(lat, lng) {
        if (cameraMarker) map.removeLayer(cameraMarker);
        cameraMarker = L.marker([lat, lng]).addTo(map).bindPopup("Camera").openPopup();
        map.setView([lat, lng], 18);
    }

    window.calculateTarget = function() {
        if (!cameraMarker) return logToScreen("Chưa nhập link Google Maps", "error");
        const cam = cameraMarker.getLatLng();
        const bear = parseFloat(document.getElementById('heading').value);
        const dist = parseFloat(document.getElementById('distance').value);
        
        const R = 6371e3; 
        const rad = Math.PI / 180;
        const φ1 = cam.lat * rad, λ1 = cam.lng * rad, θ = bear * rad, δ = dist / R;

        const φ2 = Math.asin(Math.sin(φ1) * Math.cos(δ) + Math.cos(φ1) * Math.sin(δ) * Math.cos(θ));
        const λ2 = λ1 + Math.atan2(Math.sin(θ) * Math.sin(δ) * Math.cos(φ1), Math.cos(δ) - Math.sin(φ1) * Math.sin(φ2));

        const tLat = φ2 / rad, tLng = λ2 / rad;

        if (poleMarker) map.removeLayer(poleMarker);
        if (connectionLine) map.removeLayer(connectionLine);

        poleMarker = L.marker([tLat, tLng], {draggable:true}).addTo(map);
        connectionLine = L.polyline([cam, [tLat, tLng]], {color:'red', dashArray:'5,5'}).addTo(map);
        
        document.getElementById('pole-coords').value = `${tLat.toFixed(6)}, ${tLng.toFixed(6)}`;
        poleMarker.on('dragend', e => {
            const p = e.target.getLatLng();
            document.getElementById('pole-coords').value = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
            connectionLine.setLatLngs([cam, p]);
        });
        logToScreen("Đã tính vị trí. Hãy kéo chấm đỏ nếu cần chỉnh.");
    }

    // --- CAPTURE & RESIZE LOGIC ---
    const btnCapture = document.getElementById('btn-capture');
    const cropModal = document.getElementById('crop-modal');
    const imageToCrop = document.getElementById('image-to-crop');
    let cropper;

    btnCapture.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"}});
            const track = stream.getVideoTracks()[0];
            const bmp = await new ImageCapture(track).grabFrame();
            track.stop();
            
            const cvs = document.createElement('canvas');
            cvs.width = bmp.width; cvs.height = bmp.height;
            cvs.getContext('2d').drawImage(bmp, 0, 0);
            
            imageToCrop.src = cvs.toDataURL('image/png');
            cropModal.style.display = 'flex';
            if(cropper) cropper.destroy();
            cropper = new Cropper(imageToCrop, { viewMode: 1, autoCropArea: 0.5 });
        } catch (e) { logToScreen("Không chụp được: " + e.message, "error"); }
    });

    document.getElementById('btn-crop-confirm').addEventListener('click', () => {
        if(!cropper) return;
        // QUAN TRỌNG: Resize nhỏ xuống 500px để file nhẹ (< 1MB)
        const canvas = cropper.getCroppedCanvas({ width: 500 });
        // Nén JPEG chất lượng 0.6
        const base64 = canvas.toDataURL('image/jpeg', 0.6);
        
        document.getElementById('final-image').src = base64;
        document.getElementById('final-image').dataset.base64 = base64;
        document.getElementById('preview-area').style.display = 'block';
        window.closeCropModal();
        logToScreen("Đã nén ảnh xong. Sẵn sàng lưu.");
    });

    window.closeCropModal = () => { cropModal.style.display = 'none'; if(cropper) cropper.destroy(); }

    // --- SAVE TO FIRESTORE DIRECTLY ---
    document.getElementById('pole-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-save');
        const coords = document.getElementById('pole-coords').value;
        
        if(!coords) return alert("Chưa có tọa độ!");
        
        btn.textContent = "Đang lưu..."; btn.disabled = true;
        logToScreen("Đang gửi dữ liệu lên Firestore...");

        try {
            const [lat, lng] = coords.split(',').map(Number);
            const base64Img = document.getElementById('final-image').dataset.base64 || null;

            // Kiểm tra dung lượng ảnh
            if(base64Img && base64Img.length > 900000) {
                throw new Error("Ảnh quá lớn (>1MB). Hãy cắt nhỏ hơn nữa!");
            }

            await addDoc(collection(db, "power_poles"), {
                location: new GeoPoint(lat, lng),
                type: document.getElementById('pole-type').value,
                notes: document.getElementById('notes').value,
                // Lưu thẳng chuỗi ảnh vào đây
                imageBase64: base64Img, 
                createdAt: new Date()
            });

            logToScreen("LƯU THÀNH CÔNG!", "success");
            alert("Đã lưu!");
            document.getElementById('notes').value = '';
            document.getElementById('preview-area').style.display = 'none';
        } catch (err) {
            logToScreen("Lỗi: " + err.message, "error");
            alert("Lỗi: " + err.message);
        } finally {
            btn.textContent = "Lưu dữ liệu"; btn.disabled = false;
        }
    });
</script>
</body>
</html>
