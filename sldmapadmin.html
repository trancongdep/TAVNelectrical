
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - TAVIETNAM v5.3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CORE CSS --- */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: #f4f6f8; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: #2c3e50; color: white; padding: 0 20px; height: 50px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        
        .grid-selector { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 4px; }
        .grid-selector label { font-size: 12px; margin-right: 5px; color: #bdc3c7; }
        .grid-selector select { background: #34495e; color: white; border: 1px solid #566573; padding: 4px; border-radius: 3px; font-weight: bold; font-size: 13px; outline: none; min-width: 150px; }
        .grid-btn { background: #27ae60; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; color: white; transition: 0.2s; }
        .grid-btn:hover { opacity: 0.9; }
        .btn-rename { background: #f39c12; }
        
        .container { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 100; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .form-content { padding: 15px; overflow-y: auto; flex: 1; }
        .form-group { margin-bottom: 8px; } 
        .form-group label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 3px; color: #666; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        
        .btn-group { display: flex; gap: 5px; margin-top: 15px; } 
        button { flex: 1; padding: 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
        .btn-new { background: #3498db; } .btn-save { background: #27ae60; } .btn-del { background: #e74c3c; }
        .btn-import { background: #8e44ad; color: white; width: 100%; margin-top:15px; padding: 10px; border-radius: 4px; border:none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; }
        .btn-extent { background: #7f8c8d; width: 100%; margin-top:5px; padding: 6px; border: none; cursor: pointer; border-radius: 3px; color: white; font-size: 11px; }

        .device-list { flex: 1; overflow-y: auto; border-top: 1px solid #eee; } 
        .device-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px; } 
        .device-item.selected { background: #e3f2fd; border-left: 4px solid #007bff; }

        /* EDITOR */
        .main-editor { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; background: #ecf0f1;}
        .editor-tabs { display: flex; background: #dfe6e9; height: 40px; border-bottom: 1px solid #ccc; flex-shrink: 0; }
        .tab-btn { padding: 0 25px; cursor: pointer; border: none; background: none; font-weight: bold; color: #636e72; height: 100%; border-right: 1px solid #ccc; }
        .tab-btn.active { background: white; color: #2980b9; border-bottom: 3px solid #2980b9; }
        .tab-content { display: none; width: 100%; height: 100%; position: relative; }
        .tab-content.active { display: block; }
        #sld-container { width: 100%; height: 100%; overflow: auto; background-image: radial-gradient(#bdc3c7 1px, transparent 1px); background-size: 20px 20px; background-color: white; }
        #sld-canvas { width: 4000px; height: 3000px; position: relative; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map-canvas { width: 100%; height: 100%; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 550px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .json-input { width: 100%; height: 200px; border: 1px solid #ddd; padding: 10px; font-family: monospace; resize: none; border-radius: 4px; box-sizing: border-box; }
        .import-options { display: flex; gap: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px; border: 1px solid #eee; }

        .street-view-btn {
            position: absolute; top: 10px; right: 60px; z-index: 1000;
            background: white; padding: 8px 12px; border: 2px solid #f1c40f;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px; color: #333; text-decoration: none;
        }
        
        /* --- SCADA SYMBOLS (ĐỒNG BỘ VỚI VIEW.HTML) --- */
        .admin-node { position: absolute; cursor: grab; user-select: none; z-index: 10; display: flex; align-items: center; justify-content: center; }
        .admin-node.selected-node { outline: 2px dashed #007bff; z-index: 20; background: rgba(0,123,255,0.1); }
        
        /* Label (Tách riêng) */
        .node-label { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); font-size: 10px; color: #333; white-space: nowrap; margin-top: 4px; text-shadow: 1px 1px 0 #fff; pointer-events: none; text-align: center; background: rgba(255,255,255,0.7); padding: 0 2px; border-radius: 2px; }

        /* 1. MÁY CẮT (CB) - Vuông */
        .type-cb { width: 24px !important; height: 24px !important; border: 2px solid #333; background: #fff; }
        .type-cb.closed { background: #d32f2f; } /* Đỏ đặc */
        .type-cb.open { background: #2ecc71; } /* Xanh đặc */
        
        /* 2. DAO CÁCH LY (DS) - Thanh gạt */
        .type-ds { width: 30px !important; height: 30px !important; border: none; background: transparent; }
        .type-ds::before { content: ''; position: absolute; top: 0; left: 50%; height: 100%; width: 2px; background: #333; transform: translateX(-50%); }
        .type-ds::after { content: ''; position: absolute; top: 50%; left: 50%; height: 16px; width: 3px; background: #333; transform-origin: top center; transition: 0.3s; }
        .type-ds.closed::after { background: #d32f2f; transform: translateX(-50%) rotate(0deg); }
        .type-ds.open::after { background: #2ecc71; transform: translateX(-50%) rotate(45deg); }

        /* 3. MÁY BIẾN ÁP (TR) - 2 Vòng tròn */
        .type-tr { width: 30px !important; height: 50px !important; border: none; background: transparent; display: flex; flex-direction: column; align-items: center; }
        .type-tr::before, .type-tr::after { content: ''; width: 24px; height: 24px; border-radius: 50%; border: 2px solid #333; background: #fff; margin: -3px 0; z-index: 1; }
        .type-tr.energized-node::before, .type-tr.energized-node::after { border-color: #d32f2f; box-shadow: 0 0 5px #d32f2f; }

        /* 4. MÁY PHÁT (GEN) - Tròn chữ G */
        .type-gen { width: 50px !important; height: 50px !important; border-radius: 50%; border: 2px solid #333; display: flex; align-items: center; justify-content: center; background: #fff; font-weight: bold; font-size: 24px; color: #333; }
        .type-gen::before { content: 'G'; }
        .type-gen.on { background: #ffccbc; border-color: #d35400; color: #d35400; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 84, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(211, 84, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 84, 0, 0); } }

        /* 5. CẦU CHÌ (FCO) */
        .type-fco { width: 14px !important; height: 30px !important; border: 2px solid #333; background: #fff; }
        .type-fco::after { content: ''; position: absolute; top: 4px; left: 50%; height: 18px; width: 2px; background: #333; transform: translateX(-50%); }
        .type-fco.open::after { height: 0; } 

        /* 6. BUSBAR */
        .type-bus { height: 8px !important; background: #2c3e50; border-radius: 2px; min-width: 100px; }
        .type-bus.energized-node { background: #d32f2f; box-shadow: 0 0 8px #d32f2f; }

        /* CÁC LOẠI KHÁC */
        .type-source { width: 50px !important; height: 50px !important; border-radius: 50%; border: 2px solid #1565c0; display:flex; align-items:center; justify-content:center; background:#e3f2fd; font-weight:bold; color:#1565c0; font-size:10px; }
        .type-pole { width: 12px !important; height: 12px !important; border-radius: 50%; background: #bdc3c7; border: 1px solid #7f8c8d; }
        .grounded { border-color: #27ae60 !important; background: #2ecc71 !important; box-shadow: 0 0 8px #2ecc71; }
        .grounded::after { content: '⏚'; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 16px; color: #27ae60; font-weight: bold; }

        /* LOTO & DÂY */
        .locked { border-color: #f39c12 !important; box-shadow: 0 0 5px #f39c12; }
        .locked::after { content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -10px; right: -10px; color: #f39c12; font-size: 12px; background: #fff; border-radius: 50%; padding: 2px; }
        
        .wire { position: absolute; z-index: 1; pointer-events: none; transition: border-color 0.2s; box-sizing: border-box; }
        .energized-line { border-color: #d32f2f !important; z-index: 5; }
        .safe-line { border-color: #2ecc71 !important; z-index: 5; }
        .dead-line { border-color: #95a5a6 !important; z-index: 1; }
        .wire-solid { border-style: solid; } .wire-dashed { border-style: dashed; }
        
        /* Map Label */
        .map-label { border: 2px solid #666; border-radius: 4px; padding: 2px 5px; text-align: center; font-weight: bold; font-size: 10px; white-space: nowrap; min-width: 40px; cursor: pointer !important; pointer-events: auto !important; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<header>
    <div class="header-title"><h2><i class="fas fa-bolt"></i> Admin Panel</h2></div>
    <div class="grid-selector">
        <label>Lưới điện:</label>
        <select id="grid-select" onchange="changeGrid()"></select>
        <button class="grid-btn btn-add" onclick="createNewGrid()" title="Tạo lưới mới"><i class="fas fa-plus"></i></button>
        <button class="grid-btn btn-rename" onclick="renameCurrentGrid()" title="Đổi tên lưới này"><i class="fas fa-edit"></i></button>
    </div>
    <div style="font-size: 12px; color: #ccc;"><span id="status-msg">Sẵn sàng</span></div>
</header>

<div class="container">
    <div class="sidebar">
        <div class="form-content">
            <div class="form-group"><label>ID Thiết bị (Tự sinh)</label><input type="text" id="inp-id" readonly style="background:#eee"></div>
            <div class="form-group"><label>Tên hiển thị</label><input type="text" id="inp-label"></div>
            <div class="form-group"><label>Công suất</label><input type="text" id="inp-capacity"></div>
            <div class="row">
                <div class="col form-group"><label>Loại</label><select id="inp-type"><optgroup label="Nguồn"><option value="source">Lưới QG</option><option value="gen">Máy phát</option></optgroup><optgroup label="Cấu trúc"><option value="pole">Cột điện</option><option value="bus">Thanh cái</option></optgroup><optgroup label="Thiết bị"><option value="cb">CB (Máy cắt)</option><option value="ds">Dao cách ly</option><option value="fco">FCO</option><option value="tr">Biến áp</option><option value="load">Tải</option></optgroup><optgroup label="Dây"><option value="wire">Đường dây</option><option value="cable">Cáp ngầm</option></optgroup></select></div>
                <div class="col form-group"><label>Nguồn cấp</label><select id="inp-parent"></select></div>
            </div>
            <div class="form-group"><label>Kiểu đấu nối</label><select id="inp-connection"><option value="solid">Nét liền</option><option value="dashed">Nét đứt</option></select></div>
            
            <div class="row" style="background:#fff; padding:5px; border:1px solid #eee; margin-bottom:10px;">
                <div class="col"><input type="checkbox" id="inp-showSLD" checked> Hiện SLD</div>
                <div class="col"><input type="checkbox" id="inp-grounded"> Tiếp địa</div>
            </div>

            <div class="row"><div class="col form-group"><label>SLD X</label><input type="number" id="inp-x"></div><div class="col form-group"><label>SLD Y</label><input type="number" id="inp-y"></div></div>
            <button type="button" class="btn-extent" onclick="zoomExtent()"><i class="fas fa-compress"></i> Gom SLD</button>
            <div class="row" style="margin-top:10px;"><div class="col form-group"><label>Lat</label><input type="number" id="inp-lat" step="0.000001"></div><div class="col form-group"><label>Lng</label><input type="number" id="inp-lng" step="0.000001"></div></div>

            <div class="btn-group">
                <button type="button" class="btn-new" onclick="resetForm()">Mới</button>
                <button type="button" class="btn-save" onclick="saveDevice()">Lưu</button>
                <button type="button" class="btn-del" onclick="deleteDevice()">Xóa</button>
            </div>

            <button class="btn-import" onclick="openImportModal()"><i class="fas fa-robot"></i> Import JSON</button>
        </div>
        <div class="device-list" id="device-list-container"></div>
    </div>

    <div class="main-editor">
        <div class="editor-tabs"><button class="tab-btn active" onclick="switchTab('sld', this)">SLD Editor</button><button class="tab-btn" onclick="switchTab('map', this)">Map Editor</button></div>
        <div id="tab-sld" class="tab-content active"><div id="sld-container"><div id="sld-canvas"></div></div></div>
        <div id="tab-map" class="tab-content"><div id="map-wrapper"><button class="street-view-btn" onclick="openSmartWindow()"><i class="fas fa-street-view"></i> Map Window</button><div id="map-canvas"></div></div></div>
    </div>
</div>

<div id="importModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><i class="fas fa-robot"></i> Import Dữ liệu</div>
        <div class="import-options"><label class="radio-label"><input type="radio" name="importMode" value="append" checked> Thêm vào lưới hiện tại</label><label class="radio-label"><input type="radio" name="importMode" value="new"> Tạo lưới điện mới</label></div>
        <textarea id="jsonInput" class="json-input" placeholder='Dán JSON từ Gemini vào đây'></textarea>
        <div style="display:flex; gap:10px; justify-content: flex-end;"><button onclick="closeImportModal()">Hủy</button><button onclick="processImport()" style="background:#27ae60; color:white">Xác nhận Import</button></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f", databaseURL: "https://tavietnam-78ae8-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let allDevices = [], selectedId = null, mapMarkers = {}, mapPolylines = [];
    let currentGridId = localStorage.getItem('currentGridId') || 'default_grid';
    let mapWindow = null; 

    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:22});
    const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:22});
    const map = L.map('map-canvas', { center: [10.8231, 106.6297], zoom: 18, layers: [streetLayer] });
    L.control.layers({"Đường phố": streetLayer, "Vệ tinh": satLayer}).addTo(map);

    // --- GRID ---
    function loadGrids() {
        onValue(ref(db, 'grids_meta'), (snap) => {
            const data = snap.val(); const sel = document.getElementById('grid-select'); sel.innerHTML = '';
            if(!data) { sel.appendChild(new Option("Lưới mặc định", 'default_grid')); set(ref(db,'grids_meta/default_grid'), {name:"Lưới mặc định"}); }
            else { for(let id in data) sel.appendChild(new Option(data[id].name, id)); }
            // Fix lỗi grid cũ
            if(data && !data[currentGridId]) currentGridId = Object.keys(data)[0];
            sel.value = currentGridId; localStorage.setItem('currentGridId', currentGridId);
            loadDevices();
        });
    }
    window.changeGrid = () => { currentGridId = document.getElementById('grid-select').value; localStorage.setItem('currentGridId', currentGridId); loadDevices(); }
    window.createNewGrid = () => { const n=prompt("Tên:"); if(n) { const id='grid_'+Date.now(); set(ref(db,'grids_meta/'+id),{name:n}); currentGridId=id; localStorage.setItem('currentGridId',id); } }
    window.renameCurrentGrid = () => { const n=prompt("Tên mới:"); if(n) update(ref(db,`grids_meta/${currentGridId}`),{name:n}); }

    function loadDevices() {
        onValue(ref(db, `grids/${currentGridId}/nodes`), (snap) => {
            allDevices = snap.val() ? Object.values(snap.val()) : [];
            calculatePower(); renderTable(); renderSLD(); renderMap(); updateParentSelect();
            document.getElementById('status-msg').innerText = `Đã tải ${allDevices.length} thiết bị`;
        });
    }

    // --- IMPORT & WINDOW ---
    window.openImportModal=()=>document.getElementById('importModal').style.display='flex';
    window.closeImportModal=()=>document.getElementById('importModal').style.display='none';
    window.processImport=()=>{ /* Logic import giữ nguyên như v5.2 */ 
        const jsonStr = document.getElementById('jsonInput').value;
        const mode = document.querySelector('input[name="importMode"]:checked').value;
        try {
            const data = JSON.parse(jsonStr); if(!Array.isArray(data)) throw new Error("Format []");
            if(mode==='new') { const n=prompt("Tên:"); if(!n)return; const id='grid_'+Date.now(); set(ref(db,'grids_meta/'+id),{name:n}); currentGridId=id; localStorage.setItem('currentGridId',id); }
            const updates={}; let sX=100,sY=100, c=map.getCenter();
            data.forEach((i,idx)=>{
                if(!i.id||!i.type) return;
                const col=idx%5, row=Math.floor(idx/5);
                const sldX=(i.sld&&i.sld.x)?i.sld.x:(sX+col*150), sldY=(i.sld&&i.sld.y)?i.sld.y:(sY+row*100);
                const lat=(i.geo&&i.geo.lat)?i.geo.lat:c.lat, lng=(i.geo&&i.geo.lng)?i.geo.lng:c.lng;
                updates[`grids/${currentGridId}/nodes/${i.id}`] = {
                    id:i.id, label:i.label||i.id, type:i.type.toLowerCase(), parent:i.parent||null, capacity:i.capacity||"",
                    connection:'solid', state:'closed', showOnSLD:(i.showOnSLD!==false), isGrounded:(i.isGrounded===true),
                    sld:{x:sldX,y:sldY}, geo:{lat:lat,lng:lng}
                };
            });
            update(ref(db), updates).then(()=>{ alert("Xong!"); closeImportModal(); if(mode==='new')loadGrids(); });
        } catch(e){ alert(e.message); }
    }
    window.openSmartWindow=()=>{ const c=map.getCenter(); const u=`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=$3{c.lat},${c.lng}`; if(mapWindow&&!mapWindow.closed){mapWindow.location.href=u;mapWindow.focus();}else{mapWindow=window.open(u,'GM','width=400,height=600');} }

    // --- CORE LOGIC ---
    function calculatePower() {
        allDevices.forEach(n => n.isEnergized = false);
        const sources = allDevices.filter(n => n.type === 'source' || (n.type === 'gen' && n.state === 'on'));
        sources.forEach(s => { s.isEnergized = true; propagate(s); });
    }
    function isConductive(n) {
        if(['source','bus','tr','load','cable','wire','pole','gen'].includes(n.type)) return true;
        if(['cb','ds','fco'].includes(n.type)) return n.state==='closed';
        return false;
    }
    function propagate(p) {
        if(p.isEnergized && isConductive(p)) {
            allDevices.filter(n => n.parent === p.id).forEach(c => { c.isEnergized = true; propagate(c); });
        }
    }

    // --- CRUD ---
    window.saveDevice=()=>{
        let id=selectedId; if(!id) id='N'+Date.now().toString().slice(-6);
        const nd={
            id:id, label:document.getElementById('inp-label').value||"NoName", type:document.getElementById('inp-type').value,
            parent:document.getElementById('inp-parent').value||null, capacity:document.getElementById('inp-capacity').value||"",
            connection:document.getElementById('inp-connection').value, state:"closed", showOnSLD:document.getElementById('inp-showSLD').checked,
            isGrounded:document.getElementById('inp-grounded').checked,
            sld:{x:parseInt(document.getElementById('inp-x').value)||100, y:parseInt(document.getElementById('inp-y').value)||100},
            geo:{lat:parseFloat(document.getElementById('inp-lat').value)||map.getCenter().lat, lng:parseFloat(document.getElementById('inp-lng').value)||map.getCenter().lng}
        };
        set(ref(db, `grids/${currentGridId}/nodes/${id}`), nd).then(()=>selectDevice(nd,false));
    }
    window.resetForm=()=>{ selectedId=null; document.getElementById('inp-id').value="(Tự sinh)"; document.getElementById('inp-label').value=""; renderTable(); renderSLD(); }
    window.selectDevice=(d,z)=>{
        selectedId=d.id; document.getElementById('inp-id').value=d.id; document.getElementById('inp-label').value=d.label;
        document.getElementById('inp-type').value=d.type; document.getElementById('inp-capacity').value=d.capacity||"";
        updateParentSelect(); document.getElementById('inp-parent').value=d.parent||"";
        document.getElementById('inp-showSLD').checked=(d.showOnSLD!==false); document.getElementById('inp-grounded').checked=(d.isGrounded===true);
        document.getElementById('inp-x').value=d.sld.x; document.getElementById('inp-y').value=d.sld.y;
        document.getElementById('inp-lat').value=d.geo?d.geo.lat:0; document.getElementById('inp-lng').value=d.geo?d.geo.lng:0;
        renderTable(); renderSLD();
        if(mapMarkers[d.id]) { mapMarkers[d.id].openPopup(); if(z && d.geo) map.flyTo([d.geo.lat, d.geo.lng], 19); }
    }
    window.deleteDevice=()=>{ if(selectedId&&confirm("Xóa?")){ remove(ref(db,`grids/${currentGridId}/nodes/${selectedId}`)); resetForm(); } }
    window.zoomExtent=()=>{ update(ref(db),{}); }

    function renderTable(){ const c=document.getElementById('device-list-container'); c.innerHTML=''; allDevices.forEach(d=>{ const div=document.createElement('div'); div.className=`device-item ${d.id===selectedId?'selected':''}`; div.innerHTML=`<b>${d.label}</b><br><small>${d.id}</small>`; div.onclick=()=>selectDevice(d,false); c.appendChild(div); }); }
    function updateParentSelect(){ const s=document.getElementById('inp-parent'); s.innerHTML='<option value="">-- Gốc --</option>'; allDevices.forEach(d=>{ if(d.id!==selectedId) s.appendChild(new Option(d.label,d.id)); }); }

    // --- RENDER SLD ---
    function getBusBounds(bus) {
        let minX=bus.sld.x, maxX=bus.sld.x+100;
        const kids = allDevices.filter(n=>n.parent===bus.id);
        if(kids.length>0) { const xs=kids.map(k=>k.sld.x); minX=Math.min(minX,...xs); maxX=Math.max(maxX,...xs); }
        return {x:minX-20, y:bus.sld.y, width:(maxX-minX)+60};
    }
    const sldCanvas = document.getElementById('sld-canvas');
    function renderSLD() {
        sldCanvas.innerHTML = '';
        allDevices.forEach(d => { if(d.parent) { const p=allDevices.find(x=>x.id==d.parent); if(p) drawWire(p, d); } });
        allDevices.forEach(d => {
            if(d.type==='pole' && d.showOnSLD===false) return;
            const el = document.createElement('div');
            el.className = `admin-node type-${d.type} ${d.id===selectedId?'selected-node':''}`;
            
            if(['cb','ds','fco'].includes(d.type)) el.classList.add(d.state==='closed'?'closed':'open');
            if(d.type==='gen') el.classList.add(d.state==='on'?'on':'off');
            if(d.state==='locked') el.classList.add('locked');
            if(d.isEnergized) el.classList.add('energized-node');
            if(d.isGrounded) el.classList.add('grounded');

            if(d.type==='bus') { const b=getBusBounds(d); el.style.left=b.x+'px'; el.style.top=b.y+'px'; el.style.width=b.width+'px'; }
            else { el.style.left=d.sld.x+'px'; el.style.top=d.sld.y+'px'; }

            if(!['bus','wire','cable'].includes(d.type)) {
                const lbl = document.createElement('div'); lbl.className='node-label';
                let t = d.label; if(d.capacity) t+=` (${d.capacity})`;
                lbl.innerText = t; el.appendChild(lbl);
            }
            if(d.type==='source') el.innerHTML="SRC";

            // Drag
            el.onmousedown = (e) => {
                e.stopPropagation(); e.preventDefault(); if(d.id!==selectedId) selectDevice(d, false);
                const sX=e.clientX, sY=e.clientY, origX=d.sld.x, origY=d.sld.y;
                const onMM = (ev) => {
                    let nx=origX+(ev.clientX-sX), ny=origY+(ev.clientY-sY);
                    nx=Math.round(nx/10)*10; ny=Math.round(ny/10)*10;
                    document.getElementById('inp-x').value=nx; document.getElementById('inp-y').value=ny;
                    if(d.type==='bus') { const b=getBusBounds({...d,sld:{x:nx,y:ny}}); el.style.left=b.x+'px'; el.style.top=b.y+'px'; }
                    else { el.style.left=nx+'px'; el.style.top=ny+'px'; }
                };
                document.addEventListener('mousemove', onMM);
                document.onmouseup = () => { document.removeEventListener('mousemove', onMM); saveDevice(); };
            };
            sldCanvas.appendChild(el);
        });
    }

    function drawWire(p, c) {
        const cls = (p.isEnergized || c.isEnergized) ? 'energized-line' : 'dead-line';
        const type = 'wire-' + (c.connection || 'solid');
        let pB={x:p.sld.x,y:p.sld.y,w:50,h:24}, cB={x:c.sld.x,y:c.sld.y,w:50,h:24};
        if(p.type==='bus'){ const b=getBusBounds(p); pB={x:b.x, y:b.y, w:b.width, h:8}; }
        else if(['cb','ds','fco'].includes(p.type)) pB.w=24; else if(['source','gen'].includes(p.type)){pB.w=60;pB.h=60;}
        if(c.type==='bus'){ const b=getBusBounds(c); cB={x:b.x, y:b.y, w:b.width, h:8}; }
        else if(['cb','ds','fco'].includes(c.type)) cB.w=24; else if(['source','gen'].includes(c.type)){cB.w=60;cB.h=60;}

        let x1=pB.x+pB.w/2, y1=pB.y+pB.h, x2=cB.x+cB.w/2, y2=cB.y;
        if(p.type==='bus') { x1=Math.max(pB.x, Math.min(pB.x+pB.w, x2)); y1=pB.y+pB.h/2; }
        if(c.type==='bus') { x2=Math.max(cB.x, Math.min(cB.x+cB.w, x1)); y2=cB.y+cB.h/2; }
        const midY=y1+(y2-y1)/2;
        createSeg(x1,y1,x1,midY,cls,type,'v'); createSeg(x1,midY,x2,midY,cls,type,'h'); createSeg(x2,midY,x2,y2,cls,type,'v');
    }
    function createSeg(x,y,w,h,c,t,d) {
        const el=document.createElement('div'); el.className=`wire ${c} ${t}`;
        el.style.left=Math.min(x,w)+'px'; el.style.top=Math.min(y,h)+'px';
        if(d==='h') { el.style.width=Math.abs(x-w)+'px'; el.style.height='0'; el.style.borderTopWidth='2px'; }
        else { el.style.width='0'; el.style.height=Math.abs(y-h)+'px'; el.style.borderLeftWidth='2px'; }
        sldCanvas.appendChild(el);
    }

    function renderMap() {
        for(let k in mapMarkers) map.removeLayer(mapMarkers[k]); mapMarkers={};
        for(let k in mapPolylines) map.removeLayer(mapPolylines[k]); mapPolylines=[];
        allDevices.forEach(d => { if(d.parent && d.geo) { const p=allDevices.find(x=>x.id==d.parent); if(p && p.geo) { const c=(p.isEnergized||d.isEnergized)?'#d32f2f':'#95a5a6'; mapPolylines.push(L.polyline([[p.geo.lat,p.geo.lng],[d.geo.lat,d.geo.lng]],{color:c,weight:2}).addTo(map)); } } });
        allDevices.forEach(d => {
            if(!d.geo) return;
            let bg='#fff', border='#666';
            if(d.isEnergized) { border='#d32f2f'; if(['source','gen'].includes(d.type)) border='#1565c0'; }
            if(d.type==='pole') { bg='#bdc3c7'; if(d.isGrounded) { bg='#d5f5e3'; border='#27ae60'; } }
            
            const html = `<div class="map-label" style="background:${bg}; border:2px solid ${border}; color:#333">${d.label}</div>`;
            const icon = L.divIcon({className:'', html:html, iconSize:[40,20]});
            const m = L.marker([d.geo.lat,d.geo.lng], {draggable:true, icon:icon}).addTo(map);
            m.on('click', ()=>selectDevice(d,false));
            m.on('dragend', ()=>{
                const pos = m.getLatLng(); if(selectedId!==d.id) selectDevice(d,false);
                document.getElementById('inp-lat').value=pos.lat.toFixed(6); document.getElementById('inp-lng').value=pos.lng.toFixed(6); saveDevice();
                if(mapWindow&&!mapWindow.closed) mapWindow.location.href=`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=$4{pos.lat},${pos.lng}`;
            });
            mapMarkers[d.id] = m;
        });
    }

    window.switchTab = (t,b) => {
        document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active');
        if(t==='map') setTimeout(()=>map.invalidateSize(), 200);
    }

    loadGrids();
</script>
</body>
</html>
