<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCADA Monitor - Operation & Fault Sim</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS CƠ BẢN --- */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; background-color: #f0f2f5; }
        #sld-panel { width: 50%; height: 100%; background: #ffffff; border-right: 1px solid #ccc; position: relative; overflow: auto; }
        #map-panel { width: 50%; height: 100%; }
        
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sld-panel, #map-panel { width: 100%; height: 100%; display: none; }
            .active-panel { display: block !important; }
            .mobile-nav { display: flex !important; }
        }
        .mobile-nav { display: none; position: absolute; bottom: 0; width: 100%; height: 50px; background: white; border-top: 1px solid #ddd; z-index: 999; }
        .nav-btn { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #666; font-size: 12px; font-weight: bold; }
        .nav-btn.active { color: #007bff; background: #eef2f5; }

        /* --- STYLES CHO MODAL (DIALOG BOX) --- */
        .modal-overlay { display: none; position: fixed; sit: n; fixe:  ; p: 0;: eft:; ; widt:  100;  height: 1: %; bac,g,o,nd: ; ba(0,0,: 0.5); z-index: 9999; : stify-; ntent: cent: ; alig; i
        .er; }
        .modal-b:  { ba; groun:  whit;  width: 400px: bor; r-radius: : x  bo -sha ow: 0 ,p, ,0px ; ba(0,0,0: .3); o; rflow: hi: en; anima ion:; l
        .3s; }
        @keyf a es s i eDown { f: m { transform: tr; slateY(: 0; )  o a ity: 0; }: o { transform; transla: Y; )  
        
        .     
         modal-head: #2c3e50; ound:: 2c3e5;  color:: hite; padding: 15: ; fo; -weight: bold; display: flex; : stify-content; space-betwe: ; alig; i
        .er; }
        .clo: -btn { ; rsor: poi: er; ; n
        
        .     
        .modal: abs ; display: flex: bor er-bo #ddd; px solid #: #f8f9fa; o
        .fa; }       : .; tab { f: x: 1; padding: 1: x; tex; align:: enter; ; rsor: point: ; f; t-wei: #666; ;
        .66; }.         m-tab.acti:  { ba; ground: white: bor er-bo #3498db; solid: #3498db; o
        
        .     
        .modal: ody ; p
        .px; }
        .tab-co: ent ; d
        .ne; }
     .  .tab c ntent.a: ive {; i

        ck; }

        /* Form Elements
        .al */
        . ontrol-group : marg; -
        .px; }
        .cont o -group : bel {; isplay: b: ck; ; nt-size: 12: ; fo; -weight: bold: mar; n-bot: #555; ;
        .55; }
        .cont, .-group input, .contr l group: elec; { width: 100;  paddi: : 8 x; bo #ccc; px solid #ccc: bor; r-radius: : x; box-siz; g
        
        .     
        : tn-o; { width: 100%; padding: 1: x; m; gin-to:  10p;  border: none: bor; r-radius: 4: ; fo; -weigh:  bold; ; rsor: poi: er; ; n
        .px; }
         btn-close-: #e74c3c; ound:: e74c3;  
        .te; }
        .btn-open-: #27ae60; ound:: 27ae6;  
        .te; }
        .btn-s: #f39c12; ound:: f39c1;  

        te; }

        /* --- STYLES CHO NOD
        .-- */
        . anel-ove: ay { pos; ion: abso; te; : p: 1; x; left: 1: x; backg,oun,: r,ba(25; 255,255: .95); padding: 10px: bor; r-radius: : x  bo -sh dow: 0,2,x,5px ; ba(0,0,: 0.1); z-inde:  10 0; bo #ddd; p
        .dd; }
        .legend: tem ; display: fl: ; alig; items: cen: r; ; rgin-top:: px; ; n
        .px; }      :  .do; { widt:  12p;  height: 12px: bor; r-radius: 50:  ma; in-rig: : 8 x; bo der: 1,x,s,lid ; b

        .); }

        .node: ox { pos; ion: : solu; ; width: 8: x; tex; align: ce: er; ; nt-size: 10: ; fo; -weigh:  bold; ; rsor: : int r; bo #555; px solid #: 5; ba; ground: wh: e;  rans; ion: al: 0.2;  padding: 4: ; us; -select: no; ; z-index: 10: bor; r-radius: : x;  ox- had w: 2px,2,x,5px ; b
        .1); }
  :      n de-box:ho: r { transfo; : scale: .05;  z-index: : 0  bo -sha ow: 0 ,p, ,5px ; b
        
        .     
        .closed: #d32f2f color: #d3; 2f !i: #d32f2f; o
        .2f;  
        .open: #27ae60 color: #27; 60 !i: #27ae60; olor: #27ae6:  borde -style: da; ed !important; b: #f9fff9; o
        
        .     
         e ergized-node { b: #ffccbc color: #ff; bc !import: t   ox- hadow: 0,  8,  , ba(2; ,
        .4); }
         e ergized-line: #ff3d00 color: #ff; 00 !imp: t nt; z-inde;  5 !import: t   ox- #ff3d00; 0
        .00; }
        .dead-line: #95a5a6 color: #95; a6 !imp: t; t

         1; }

   
        .RE * 
        .: re { pos; ion: a: o; te; height: 0;: oint; -events: n: e; transitio : bo; er-colo: 0; s
        . 5; }
        .wire-sol:  {  order; o
        .id; }
        .wire-dash:  {  order-; p

        .d; }

        .ty: -bus { height: ; px !import: #2c3e50; ound: : c3e5;  bord: : non;  width: 300px: bor; r
        .px; }
        . ype-bus: pan ; d .play: no.e; } .type-bus e ergized-node { b: #ff3d00 color: #ff; 0
        .nt; }
        .type-source { b: #e3f2fd; olor: #e3f2f: #1565c0; olor: #1565c0: bor; r-rad: s: 5; ; widt:  60p;  height: 60px; display: fl: ; alig; items: center; : stify-; n
        .er; }
        .type: abl  { bor #555; x dashed #: #eee; kgroun:  #ee;  heig: : 20p;  width: 1: px; transform; s
        .g); }
    .   .type-cable e ergized-node { b: #ffccbc color: #ff; bc !importan: #ff3d00; o
    </style>
</head>
<body>

    <div id="control-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span id="modal-title">Máy Cắt: CB-01</span>
                <span class="close-btn" onclick="-btn" onclic">&times;</span>
            </div>
            <div class="modal-tabs">
                <div class="m-tab active" onclick="tive" onclick="'op'c">Vận Hành</div>
                <div class="m-tab" onclick="-tab" onclick="'sim'h">Giả Lập Sự Cố</div>
            </div>
            <div class="modal-body">
                <div id="tab-op" class="tab-content active">
                    <p style="     <p style="font-size:13px; color:#666; mar;">Thao tác đóng cắt lưới điện theo quy trình vận hành.</p>
                    <div style="   <div style="display;">
                        <button class="btn-op btn-close-cb" onclick="e-cb" onclick="pe'closed'r">
                            <i class="fas fa-bolt"></i> ĐÓNG ĐIỆN (CLOSE)
                        </button>
                        <button class="btn-op btn-open-cb" onclick="performOperation('open')">
                            <i class="fas fa-power-off"></i> CẮT ĐIỆN (OPEN)
                        </button>
                    </div>
                </div>

                <div id="tab-sim" class="tab-content">
                    <div class="control-group">
                        <label>Chọn Relay bảo vệ tác động:</label>
                        <select id="relay-type" onchange="updateRelayParams()">
                            <option value="21">Relay 21 - Khoảng cách (Distance)</option>
                            <option value="67">Relay 67 - Quá dòng có hướng</option>
                            <option value="87">Relay 87 - So lệch dòng điện</option>
                        </select>
                    </div>

                    <div id="param-21" class="relay-params">
                        <div class="control-group">
                            <label>Tổng trở sự cố (Z - Ohm):</label>
                            <input type="number" id="val-z" placeholder="VD: 5.2">
                        </div>
                        <div class="control-group">
                            <label>Vùng bảo vệ (Zone):</label>
                            <select id="val-zone">
                                <option value="1">Zone 1 (80%)</option>
                                <option value="2">Zone 2 (120%)</option>
                            </select>
                        </div>
                    </div>

                    <div id="param-67" class="relay-params" style="display:none">
                        <div class="control-group">
                            <label>Dòng điện sự cố (I - Amps):</label>
                            <input type="number" id="val-i" placeholder="VD: 1200">
                        </div>
                        <div class="control-group">
                            <label>Góc pha (Degree):</label>
                            <input type="number" id="val-angle" placeholder="VD: 45">
                        </div>
                    </div>

                    <div id="param-87" class="relay-params" style="display:none">
                        <div class="control-group">
                            <label>Dòng so lệch (Idiff - Amps):</label>
                            <input type="number" id="val-idiff" placeholder="VD: 500">
                        </div>
                        <div class="control-group">
                            <label>Dòng hãm (Ibias - Amps):</label>
                            <input type="number" id="val-ibias" placeholder="VD: 200">
                        </div>
                    </div>

                    <button class="btn-op btn-sim" onclick="simulateFault()">
                        <i class="fas fa-exclamation-triangle"></i> TÁC ĐỘNG SỰ CỐ (TRIP)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="sld-panel" class="active-panel">
        <div class="panel-overlay">
            <strong style="color:#2c3e50">SƠ ĐỒ NGUYÊN LÝ</strong>
            <div class="legend-item"><span class="dot" style="background:#ff3d00"></span>Có điện (Live)</div>
            <div class="legend-item"><span class="dot" style="background:#95a5a6"></span>Mất điện (Dead)</div>
        </div>
        <div id="sld-canvas" style="width: 4000px; height: 3000px;"></div>
    </div>

    <div id="map-panel">
        <div class="panel-overlay" style="right: 15px; left: auto;"><strong>BẢN ĐỒ GIS</strong></div>
        <div id="map" style="width:100%; height:100%"></div>
    </div>

    <div class="mobile-nav">
        <div class="nav-btn active" onclick="switchView('sld', this)"><i class="fas fa-project-diagram"></i> SLD</div>
        <div class="nav-btn" onclick="switchView('map', this)"><i class="fas fa-map-marked-alt"></i> MAP</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // FIREBASE CONFIG
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f", databaseURL: "https://tavietnam-78ae8-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let localNodes = []; const sldCanvas = document.getElementById('sld-canvas');
        const map = L.map('map').setView([10.8231, 106.6297], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let mapMarkers = {}; let mapLines = {};
        
        let currentTargetId = null; // ID thiết bị đang thao tác

        // --- MODAL LOGIC ---
        window.openControlModal = function(id) {
            const node = localNodes.find(n => n.id === id);
            // Chỉ mở modal cho thiết bị đóng cắt
            if (!['cb', 'ds', 'fco'].includes(node.type)) return;

            currentTargetId = id;
            document.getElementById('modal-title').innerText = `${node.type.toUpperCase()}: ${node.label} (${node.id})`;
            document.getElementById('control-modal').style.display = 'flex';
            switchTabModal('op'); // Mặc định tab vận hành
        }

        window.closeModal = function() {
            document.getElementById('control-modal').style.display = 'none';
            currentTargetId = null;
        }

        window.switchTabModal = function(tab) {
            document.querySelectorAll('.m-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if(tab === 'op') {
                document.querySelectorAll('.m-tab')[0].classList.add('active');
                document.getElementById('tab-op').classList.add('active');
            } else {
                document.querySelectorAll('.m-tab')[1].classList.add('active');
                document.getElementById('tab-sim').classList.add('active');
            }
        }

        window.updateRelayParams = function() {
            const type = document.getElementById('relay-type').value;
            document.querySelectorAll('.relay-params').forEach(d => d.style.display = 'none');
            document.getElementById(`param-${type}`).style.display = 'block';
        }

        // --- ACTION HANDLERS ---
        window.performOperation = function(action) {
            if(!currentTargetId) return;
            // Cập nhật trạng thái
            update(ref(db, 'system_nodes/' + currentTargetId), { 
                state: action,
                last_operation: 'manual', // Ghi chú là thao tác tay
                fault_info: null // Xóa lỗi cũ nếu có
            });
            closeModal();
        }

        window.simulateFault = function() {
            if(!currentTargetId) return;
            const relayType = document.getElementById('relay-type').value;
            let faultData = { type: relayType, timestamp: Date.now() };

            // Lấy thông số tùy theo relay
            if(relayType === '21') {
                faultData.z = document.getElementById('val-z').value;
                faultData.zone = document.getElementById('val-zone').value;
            } else if(relayType === '67') {
                faultData.i = document.getElementById('val-i').value;
                faultData.angle = document.getElementById('val-angle').value;
            } else if(relayType === '87') {
                faultData.idiff = document.getElementById('val-idiff').value;
                faultData.ibias = document.getElementById('val-ibias').value;
            }

            // Gửi lên Firebase: State = Open (Trip) + Thông tin lỗi
            update(ref(db, 'system_nodes/' + currentTargetId), { 
                state: 'open',
                last_operation: 'fault_trip',
                fault_info: faultData
            });
            
            alert(`Đã gửi lệnh TRIP relay ${relayType} cho thiết bị ${currentTargetId}`);
            closeModal();
        }

        // --- POWER LOGIC ---
        function isConductive(node) {
            if (['source', 'bus', 'tr', 'load', 'cable', 'wire', 'underground'].includes(node.type)) return true;
            if (['cb', 'ds', 'fco'].includes(node.type)) return node.state === 'closed';
            return false;
        }

        onValue(ref(db, 'system_nodes'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localNodes = Object.values(data);
                calculatePower();
                renderSLD(); renderMap();
            }
        });

        function calculatePower() {
            localNodes.forEach(n => n.isEnergized = false);
            localNodes.filter(n => n.type === 'source').forEach(src => { src.isEnergized = true; propagate(src); });
        }
        function propagate(parent) {
            if (parent.isEnergized && isConductive(parent)) {
                localNodes.filter(n => n.parent === parent.id).forEach(child => { child.isEnergized = true; propagate(child); });
            }
        }

        // --- RENDERERS ---
        function renderSLD() {
            sldCanvas.innerHTML = '';
            // Wire
            localNodes.forEach(node => {
                if (node.parent) {
                    const parent = localNodes.find(n => n.id === node.parent);
                    if (parent && parent.sld && node.sld) {
                        const isWireLive = parent.isEnergized && isConductive(parent);
                        drawWire(parent, node, isWireLive ? 'energized-line' : 'dead-line', node.connection || 'solid');
                    }
                }
            });
            // Node
            localNodes.forEach(node => {
                if(!node.sld) return;
                const el = document.createElement('div');
                el.className = `node-box type-${node.type}`;
                el.style.left = node.sld.x + 'px'; el.style.top = node.sld.y + 'px';
                
                if (['cb', 'ds', 'fco'].includes(node.type)) el.classList.add(node.state);
                if (node.isEnergized) el.classList.add('energized-node');
                
                let content = `<span>${node.label}</span>`;
                if (['cb', 'ds', 'fco'].includes(node.type)) {
                    // Nếu bị Trip do sự cố -> Hiện chữ FAULT
                    if(node.last_operation === 'fault_trip' && node.state === 'open') {
                        content += `<br><span style="font-size:9px; color:orange; font-weight:bold;">TRIP ${node.fault_info?.type || ''}</span>`;
                    } else {
                        content += `<br><span style="font-size:9px">${node.state==='closed'?'ON':'OFF'}</span>`;
                    }
                }
                if (['bus','wire','cable','underground'].includes(node.type)) content = ''; 

                el.innerHTML = content;
                // SỰ KIỆN CLICK -> MỞ MODAL
                el.onclick = () => window.openControlModal(node.id);
                sldCanvas.appendChild(el);
            });
        }

        function drawWire(p, c, colorCls, typeCls) {
            const styleCls = 'wire-' + typeCls;
            const pW = (p.type==='bus') ? 300 : (['source','tr'].includes(p.type)?60:80); 
            const pH = (p.type==='bus') ? 10 : (['source','tr'].includes(p.type)?60:40);
            const cW = (c.type==='bus') ? 300 : (['source','tr'].includes(c.type)?60:80); 
            const cH = (c.type==='bus') ? 10 : (['source','tr'].includes(c.type)?60:40);

            let x1, y1, x2, y2;
            if (p.type === 'bus') {
                let idealX = c.sld.x + cW/2;
                x1 = Math.max(p.sld.x, Math.min(p.sld.x + pW, idealX)); y1 = p.sld.y + pH;
            } else { x1 = p.sld.x + pW/2; y1 = p.sld.y + pH; }

            if (c.type === 'bus') {
                let idealX = x1;
                x2 = Math.max(c.sld.x, Math.min(c.sld.x + cW, idealX)); y2 = c.sld.y;
            } else { x2 = c.sld.x + cW/2; y2 = c.sld.y; }

            const midY = y1 + (y2 - y1) / 2;
            createWireSegment(x1, y1, x1, midY, colorCls, styleCls); 
            createWireSegment(x1, midY, x2, midY, colorCls, styleCls); 
            createWireSegment(x2, midY, x2, y2, colorCls, styleCls);
        }
        
        function createWireSegment(x, y, w, h, colorCls, styleCls) {
            if(Math.abs(x-w)<1 && Math.abs(y-h)<1) return;
            const d = document.createElement('div');
            d.className = `wire ${colorCls} ${styleCls}`;
            d.style.left = Math.min(x, w) + 'px';
            d.style.top = Math.min(y, h) + 'px';
            d.style.width = (Math.abs(w-x)||0) + 'px';
            d.style.height = (Math.abs(h-y)||0) + 'px';
            if (Math.abs(w-x) > Math.abs(h-y)) {
                d.style.borderTopWidth = "2px"; d.style.height = "0px";
            } else {
                d.style.borderLeftWidth = "2px"; d.style.width = "0px";
                if (styleCls.includes('dashed')) d.style.borderLeftStyle = 'dashed';
                else d.style.borderLeftStyle = 'solid';
                d.style.borderTop = 'none';
            }
            sldCanvas.appendChild(d);
        }

        // MAP RENDERER
        function renderMap() {
            for(let id in mapMarkers) map.removeLayer(mapMarkers[id]); for(let id in mapLines) map.removeLayer(mapLines[id]);
            mapMarkers = {}; mapLines = {};
            localNodes.forEach(node => {
                if (node.parent && node.geo) {
                    const parent = localNodes.find(n => n.id === node.parent);
                    if (parent && parent.geo) {
                        const isWireLive = parent.isEnergized && isConductive(parent);
                        const color = isWireLive ? '#ff3d00' : '#95a5a6';
                        const w = isWireLive ? 4 : 2;
                        const dash = (node.connection === 'dashed') ? '5, 10' : null;
                        mapLines[node.id] = L.polyline([[parent.geo.lat, parent.geo.lng], [node.geo.lat, node.geo.lng]], { color: color, weight: w, dashArray: dash }).addTo(map);
                    }
                }
            });
            localNodes.forEach(node => {
                if(!node.geo) return;
                let borderColor = '#666';
                if (node.isEnergized) {
                    if (node.state === 'closed') borderColor = '#d32f2f'; else if (node.type === 'source') borderColor = '#1565c0'; else borderColor = '#27ae60';
                }
                const bg = node.isEnergized ? '#fff' : '#f0f0f0';
                const html = `<div style="background:${bg}; border:2px solid ${borderColor}; border-radius:4px; padding:2px; text-align:center; font-weight:bold; font-size:10px; min-width:40px;">${node.label}</div>`;
                const icon = L.divIcon({ className: '', html: html, iconSize: [60, 20], iconAnchor: [30, 10] });
                const marker = L.marker([node.geo.lat, node.geo.lng], { icon: icon }).addTo(map);
                marker.on('click', () => window.openControlModal(node.id));
                mapMarkers[node.id] = marker;
            });
        }

        // Mobile Switch
        window.switchView = function(mode, btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            if(mode==='sld') { document.getElementById('sld-panel').classList.add('active-panel'); document.getElementById('map-panel').classList.remove('active-panel'); }
            else { document.getElementById('sld-panel').classList.remove('active-panel'); document.getElementById('map-panel').classList.add('active-panel'); setTimeout(()=>map.invalidateSize(), 200); }
        }
    </script>
</body>
</html>
