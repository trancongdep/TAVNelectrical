<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Số hóa Lưới điện (No API Key)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #container { display: flex; height: 100vh; }
        
        /* Cột bên trái: Bản đồ quản trị (OSM Free) */
        #map-container { flex: 2; position: relative; }
        #map { width: 100%; height: 100%; }

        /* Cột bên phải: Công cụ nhập liệu */
        #sidebar {
            flex: 1;
            min-width: 350px;
            max-width: 400px;
            background: #f8f9fa;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }

        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h3 { margin: 0 0 15px 0; font-size: 18px; color: #d32f2f; display: flex; align-items: center; gap: 8px; }
        h4 { margin: 10px 0 5px 0; font-size: 14px; color: #1a73e8; text-transform: uppercase; }
        
        .form-group { margin-bottom: 10px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #555; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        textarea { resize: vertical; }

        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-top: 5px; transition: 0.2s; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-success { background: #2e7d32; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { opacity: 0.9; }

        /* Vùng hiển thị ảnh */
        #preview-area { display: none; margin-top: 10px; border: 2px dashed #ccc; padding: 5px; text-align: center; }
        #final-image { max-width: 100%; display: block; }

        /* Modal Crop */
        #crop-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify_content: center; }
        .crop-wrapper { width: 90%; height: 80%; }
        .crop-controls { margin-top: 10px; display: flex; gap: 10px; }

        /* Helper text */
        .hint { font-size: 11px; color: #666; font-style: italic; }
    </style>
</head>
<body>

<div id="container">
    <div id="map-container">
        <div id="map"></div>
    </div>

    <div id="sidebar">
        <h3><i class="bi bi-tools"></i> Công cụ Nhập liệu</h3>

        <div class="card">
            <h4>1. Nhập từ Street View</h4>
            <div class="form-group">
                <label>Dán URL Google Maps vào đây:</label>
                <input type="text" id="gmap-url" placeholder="https://www.google.com/maps/@10.7..." onchange="parseGoogleUrl()">
                <div class="hint">Copy toàn bộ link trên thanh địa chỉ khi đang xem Street View.</div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex:1">
                    <label>Góc nhìn (Heading °):</label>
                    <input type="number" id="heading" step="0.1">
                </div>
                <div class="form-group" style="flex:1">
                    <label>Ước lượng xa (m):</label>
                    <input type="number" id="distance" value="10" min="1">
                </div>
            </div>
            <button class="btn btn-secondary" onclick="calculateTarget()">
                <i class="bi bi-calculator"></i> Tính vị trí Trụ Điện
            </button>
        </div>

        <div class="card">
            <h4>2. Thông tin Trụ</h4>
            <form id="pole-form">
                <div class="form-group">
                    <label>Vị trí trụ (Lat, Lng):</label>
                    <input type="text" id="pole-coords" readonly style="background: #e9ecef; font-family: monospace;">
                </div>

                <div class="form-group">
                    <label>Loại trụ:</label>
                    <select id="pole-type">
                        <option value="betong_li_tam">Bê tông ly tâm</option>
                        <option value="betong_vuong">Bê tông vuông</option>
                        <option value="thep">Trụ thép</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Điện áp:</label>
                    <select id="voltage">
                        <option value="22kV">Trung thế 22kV</option>
                        <option value="35kV">Trung thế 35kV</option>
                        <option value="0.4kV">Hạ thế 0.4kV</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Hình ảnh (Chụp màn hình):</label>
                    <button type="button" class="btn btn-primary" id="btn-capture">
                        <i class="bi bi-camera"></i> Chọn cửa sổ Google Maps
                    </button>
                    <div id="preview-area">
                        <img id="final-image">
                    </div>
                </div>

                <div class="form-group">
                    <label>Ghi chú:</label>
                    <textarea id="notes" rows="2"></textarea>
                </div>

                <button type="submit" class="btn btn-success" id="btn-save">
                    <i class="bi bi-cloud-upload"></i> Lưu vào Firebase
                </button>
            </form>
        </div>
    </div>
</div>

<div id="crop-modal">
    <div class="crop-wrapper">
        <img id="image-to-crop" style="max-width: 100%;">
    </div>
    <div class="crop-controls">
        <button class="btn btn-primary" id="btn-crop-confirm">Cắt & Dùng ảnh này</button>
        <button class="btn btn-secondary" onclick="closeCropModal()">Hủy</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, GeoPoint } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
        authDomain: "tavietnam-78ae8.firebaseapp.com",
        projectId: "tavietnam-78ae8",
        storageBucket: "tavietnam-78ae8.firebasestorage.app",
        messagingSenderId: "670121705534",
        appId: "1:670121705534:web:1027ad98550573ad37116f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // 2. MAP SETUP (OpenStreetMap - Free)
    const map = L.map('map').setView([10.7769, 106.7009], 16);
    
    // Layer vệ tinh (Esri Free) để dễ so sánh thực địa
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    }).addTo(map);
    
    // Layer nhãn tên đường
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png').addTo(map);

    let cameraMarker, poleMarker, connectionLine;

    // 3. LOGIC TÍNH TOÁN VỊ TRÍ (Geodesic)
    window.parseGoogleUrl = function() {
        const url = document.getElementById('gmap-url').value;
        // Regex bắt pattern: @lat,lng,zoom...heading(h)
        // Ví dụ: ...@10.7713437,106.6918663,3a,75y,125.4h,90t...
        const regex = /@(-?\d+\.\d+),(-?\d+\.\d+).+?(\d+(\.\d+)?)h/;
        const match = url.match(regex);

        if (match) {
            const lat = parseFloat(match[1]);
            const lng = parseFloat(match[2]);
            const heading = parseFloat(match[3]);

            // Cập nhật lên Form
            document.getElementById('heading').value = heading;
            
            // Vẽ vị trí người đứng (Camera)
            updateCameraPosition(lat, lng);
            
            // Tự động tính luôn nếu đã có distance
            calculateTarget();
        } else {
            alert("URL không hợp lệ hoặc không chứa thông tin Heading. Hãy chắc chắn bạn copy link khi đang ở chế độ Street View.");
        }
    }

    function updateCameraPosition(lat, lng) {
        if (cameraMarker) map.removeLayer(cameraMarker);
        
        cameraMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'camera-icon',
                html: '<i class="bi bi-person-circle" style="font-size: 24px; color: yellow; text-shadow: 0 0 3px black;"></i>',
                iconSize: [24, 24]
            })
        }).addTo(map);
        
        map.setView([lat, lng], 18);
    }

    // Hàm tính điểm đích từ điểm gốc + góc + khoảng cách
    window.calculateTarget = function() {
        if (!cameraMarker) return;

        const camLat = cameraMarker.getLatLng().lat;
        const camLng = cameraMarker.getLatLng().lng;
        const bearing = parseFloat(document.getElementById('heading').value); // Độ
        const dist = parseFloat(document.getElementById('distance').value); // Mét

        if (isNaN(bearing) || isNaN(dist)) return;

        // Công thức tính (Destination point given distance and bearing)
        const R = 6371e3; // Bán kính trái đất (mét)
        const φ1 = camLat * Math.PI / 180;
        const λ1 = camLng * Math.PI / 180;
        const θ = bearing * Math.PI / 180;
        const δ = dist / R;

        const φ2 = Math.asin(Math.sin(φ1) * Math.cos(δ) + Math.cos(φ1) * Math.sin(δ) * Math.cos(θ));
        const λ2 = λ1 + Math.atan2(Math.sin(θ) * Math.sin(δ) * Math.cos(φ1), Math.cos(δ) - Math.sin(φ1) * Math.sin(φ2));

        const targetLat = φ2 * 180 / Math.PI;
        const targetLng = λ2 * 180 / Math.PI;

        // Cập nhật marker Cột điện
        if (poleMarker) map.removeLayer(poleMarker);
        if (connectionLine) map.removeLayer(connectionLine);

        poleMarker = L.marker([targetLat, targetLng], { draggable: true }).addTo(map);
        
        // Vẽ đường nối từ Camera -> Cột để dễ hình dung
        connectionLine = L.polyline([
            [camLat, camLng],
            [targetLat, targetLng]
        ], {color: 'red', dashArray: '5, 5'}).addTo(map);

        // Update input
        document.getElementById('pole-coords').value = `${targetLat.toFixed(6)}, ${targetLng.toFixed(6)}`;

        // Cho phép kéo thả marker cột điện để tinh chỉnh
        poleMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            document.getElementById('pole-coords').value = `${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}`;
            connectionLine.setLatLngs([[camLat, camLng], pos]);
        });
    }

    // 4. CHỤP MÀN HÌNH (SCREEN CAPTURE)
    const btnCapture = document.getElementById('btn-capture');
    const cropModal = document.getElementById('crop-modal');
    const imageToCrop = document.getElementById('image-to-crop');
    let cropper;

    btnCapture.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: { mediaSource: "screen" } });
            const track = stream.getVideoTracks()[0];
            const imageCapture = new ImageCapture(track);
            const bitmap = await imageCapture.grabFrame();
            track.stop();

            const canvas = document.createElement('canvas');
            canvas.width = bitmap.width;
            canvas.height = bitmap.height;
            canvas.getContext('2d').drawImage(bitmap, 0, 0);

            imageToCrop.src = canvas.toDataURL('image/png');
            cropModal.style.display = 'flex';

            if(cropper) cropper.destroy();
            cropper = new Cropper(imageToCrop, { viewMode: 1, autoCropArea: 0.5 });
        } catch (err) {
            console.error(err);
        }
    });

    document.getElementById('btn-crop-confirm').addEventListener('click', () => {
        if(!cropper) return;
        const finalImgData = cropper.getCroppedCanvas({ width: 800 }).toDataURL('image/jpeg', 0.8);
        
        const imgEl = document.getElementById('final-image');
        imgEl.src = finalImgData;
        imgEl.dataset.base64 = finalImgData;
        document.getElementById('preview-area').style.display = 'block';
        window.closeCropModal();
    });

    window.closeCropModal = function() {
        cropModal.style.display = 'none';
        if(cropper) cropper.destroy();
    }

    // 5. LƯU FIREBASE
    document.getElementById('pole-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-save');
        btn.textContent = "Đang lưu..."; btn.disabled = true;

        const coordVal = document.getElementById('pole-coords').value;
        if(!coordVal) { alert("Chưa có tọa độ cột!"); btn.textContent = "Lưu vào Firebase"; btn.disabled = false; return; }

        const [lat, lng] = coordVal.split(',').map(n => parseFloat(n));
        const base64Img = document.getElementById('final-image').dataset.base64;

        try {
            let imageUrl = null;
            if (base64Img) {
                const imgRef = ref(storage, `poles_survey/${Date.now()}.jpg`);
                await uploadString(imgRef, base64Img, 'data_url');
                imageUrl = await getDownloadURL(imgRef);
            }

            await addDoc(collection(db, "power_poles"), {
                location: new GeoPoint(lat, lng),
                type: document.getElementById('pole-type').value,
                voltage: document.getElementById('voltage').value,
                notes: document.getElementById('notes').value,
                imageUrl: imageUrl,
                createdAt: new Date()
            });

            alert("Đã lưu thành công!");
            document.getElementById('notes').value = '';
            document.getElementById('preview-area').style.display = 'none';
            // Không xóa tọa độ để tiện nhập trụ tiếp theo gần đó
        } catch (error) {
            alert("Lỗi: " + error.message);
        } finally {
            btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Lưu vào Firebase';
            btn.disabled = false;
        }
    });
</script>

</body>
</html>
