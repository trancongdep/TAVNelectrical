<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geo Camera Calculator v1.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        #map { height: 400px; width: 100%; border-radius: 0.5rem; z-index: 1; }
        .compass-arrow { transition: transform 0.2s ease-out; }
        .leaflet-control-layers { z-index: 999; }
        
        /* Crosshair Styling */
        .crosshair-container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 60px; height: 60px;
            pointer-events: none;
            z-index: 10;
        }
        .crosshair-line {
            position: absolute;
            background-color: rgba(239, 68, 68, 0.8); /* Red-500 */
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }
        .ch-h { top: 29px; left: 0; width: 60px; height: 2px; } /* Horizontal */
        .ch-v { left: 29px; top: 0; width: 2px; height: 60px; } /* Vertical */
        .ch-circle {
            position: absolute;
            top: 15px; left: 15px;
            width: 30px; height: 30px;
            border: 2px solid rgba(239, 68, 68, 0.8);
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-md mx-auto bg-white shadow-lg rounded-xl overflow-hidden">
        
        <div class="bg-indigo-700 p-4 text-white flex justify-between items-center">
            <h1 class="font-bold text-lg"><i class="fa-solid fa-crosshairs mr-2"></i>Geo Calc v1.2</h1>
            <div class="flex items-center space-x-2">
                <span id="saveStatus" class="hidden text-xs bg-green-500 px-2 py-1 rounded fade-in">Đã lưu!</span>
            </div>
        </div>

        <div class="p-4 border-b border-gray-200">
            <h2 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">1. Trạng thái thiết bị</h2>
            
            <button id="requestPermissionBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded mb-3 hidden transition">
                <i class="fa-solid fa-compass mr-2"></i>Cấp quyền La Bàn (iOS)
            </button>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 text-center p-3 rounded border border-gray-200">
                    <div class="text-xs text-gray-500 mb-1">GPS (Độ chính xác)</div>
                    <div id="gpsAccuracy" class="font-mono font-bold text-green-600 text-lg">-- m</div>
                </div>
                <div class="bg-gray-50 text-center p-3 rounded border border-gray-200 relative">
                    <div class="text-xs text-gray-500 mb-1">Góc hướng (Azimuth)</div>
                    <div id="compassHeading" class="font-mono font-bold text-blue-600 text-lg">--°</div>
                    <div class="absolute top-2 right-2">
                        <i id="compassIcon" class="fa-solid fa-location-arrow compass-arrow text-gray-300 text-xl"></i>
                    </div>
                </div>
            </div>
            <div id="gpsCoords" class="text-xs text-center mt-2 text-gray-400 font-mono">Đang chờ tín hiệu vệ tinh...</div>
        </div>

        <div class="p-4 bg-indigo-50">
            <h2 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">2. Ngắm & Chụp</h2>
            
            <div class="relative bg-black rounded-lg overflow-hidden shadow-md mb-3" style="min-height: 250px;">
                <video id="cameraFeed" autoplay playsinline class="w-full h-64 object-cover"></video>
                
                <canvas id="cameraCanvas" class="hidden"></canvas>
                
                <img id="capturedImage" class="absolute top-0 left-0 w-full h-full object-cover hidden z-20">

                <div id="crosshairOverlay" class="crosshair-container">
                    <div class="crosshair-line ch-h"></div>
                    <div class="crosshair-line ch-v"></div>
                    <div class="ch-circle"></div>
                </div>

                <div class="absolute bottom-4 left-0 right-0 flex justify-center z-30 space-x-4">
                    <button id="btnStartCamera" onclick="startCamera()" class="bg-indigo-600 text-white p-3 rounded-full shadow-lg">
                        <i class="fa-solid fa-video"></i>
                    </button>
                    <button id="btnCapture" onclick="capturePhoto()" class="bg-white text-red-600 border-4 border-gray-300 w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-100 disabled:opacity-50" disabled>
                        <i class="fa-solid fa-camera text-xl"></i>
                    </button>
                    <button id="btnRetake" onclick="retakePhoto()" class="bg-gray-600 text-white p-3 rounded-full shadow-lg hidden">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Khoảng cách đo được (mét)</label>
                <div class="flex shadow-sm">
                    <input type="number" id="distanceInput" placeholder="VD: 25.5" class="flex-1 p-3 border border-gray-300 rounded-l focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <span class="bg-gray-200 text-gray-700 font-bold p-3 rounded-r border border-l-0 border-gray-300">m</span>
                </div>
            </div>

            <button onclick="calculateTarget()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded shadow-lg transform active:scale-95 transition flex justify-center items-center">
                <i class="fa-solid fa-calculator mr-2"></i>Tính toán tọa độ
            </button>
        </div>

        <div class="p-4">
            <h2 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">3. Xác thực & Lưu trữ</h2>
            
            <div class="relative">
                <div id="map"></div>
            </div>

            <div id="actionArea" class="mt-4 hidden space-y-3">
                <div class="bg-green-50 border border-green-200 rounded p-3 text-sm text-green-800">
                    <i class="fa-solid fa-check-circle mr-1"></i> Đã tính toán xong. Kiểm tra vị trí (chấm đỏ).
                </div>
                
                <button id="btnSaveFirebase" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded shadow-lg flex justify-center items-center transition">
                    <i class="fa-brands fa-google-drive mr-2"></i> Lưu vào Firebase
                </button>
            </div>
            
            <div id="resultLog" class="mt-2 text-xs text-gray-500 font-mono bg-gray-100 p-2 rounded max-h-24 overflow-y-auto hidden"></div>
        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.saveToFirestore = async function(data) {
            const btn = document.getElementById('btnSaveFirebase');
            const originalText = btn.innerHTML;
            
            try {
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Đang lưu...';
                btn.disabled = true;

                const docRef = await addDoc(collection(db, "geo_points"), {
                    ...data,
                    timestamp: serverTimestamp(),
                    device_agent: navigator.userAgent
                });

                console.log("Document saved: ", docRef.id);
                
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Đã lưu thành công';
                btn.classList.replace('bg-red-600', 'bg-green-600');
                
                document.getElementById('saveStatus').classList.remove('hidden');
                setTimeout(() => document.getElementById('saveStatus').classList.add('hidden'), 3000);

            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Lỗi khi lưu: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>

    <script>
        // --- Global State ---
        let map;
        let currentLat = null;
        let currentLng = null;
        let currentHeading = 0;
        let userMarker = null;
        let targetMarker = null;
        let targetLine = null;
        let lastCalculatedData = null;
        
        let videoStream = null;
        let capturedImageBase64 = null; // Stores the image data

        // --- 1. Init Map ---
        function initMap() {
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            });
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 18
            });

            map = L.map('map', {
                center: [10.7769, 106.7009],
                zoom: 15,
                layers: [streetLayer]
            });

            L.control.layers({ "Bản đồ đường phố": streetLayer, "Vệ tinh (Satellite)": satelliteLayer }).addTo(map);
        }

        // --- 2. Live Camera Logic ---
        async function startCamera() {
            const video = document.getElementById('cameraFeed');
            const btnCapture = document.getElementById('btnCapture');
            const btnStart = document.getElementById('btnStartCamera');

            try {
                // Request camera (prefer environment/rear camera)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                videoStream = stream;
                video.srcObject = stream;
                
                btnStart.classList.add('hidden');
                btnCapture.disabled = false;
                
                // Hide existing captured image if any
                document.getElementById('capturedImage').classList.add('hidden');
                document.getElementById('crosshairOverlay').classList.remove('hidden'); // Show crosshair

            } catch (err) {
                console.error("Camera Error:", err);
                alert("Không thể mở camera: " + err.message + "\nHãy đảm bảo bạn dùng HTTPS và cấp quyền Camera.");
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('cameraCanvas');
            const imgDisplay = document.getElementById('capturedImage');
            
            if (!videoStream) return;

            // Draw current video frame to canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to Data URL
            capturedImageBase64 = canvas.toDataURL('image/jpeg');
            
            // Show Captured Image
            imgDisplay.src = capturedImageBase64;
            imgDisplay.classList.remove('hidden');
            
            // Stop stream to save battery
            stopCamera();
            
            // UI Update
            document.getElementById('btnCapture').classList.add('hidden');
            document.getElementById('btnRetake').classList.remove('hidden');
            document.getElementById('crosshairOverlay').classList.add('hidden'); // Hide crosshair on static image
        }

        function retakePhoto() {
            document.getElementById('btnRetake').classList.add('hidden');
            document.getElementById('btnCapture').classList.remove('hidden');
            startCamera();
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        // --- 3. GPS Logic ---
        function startGPS() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        currentLat = position.coords.latitude;
                        currentLng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        document.getElementById('gpsCoords').innerText = `${currentLat.toFixed(6)}, ${currentLng.toFixed(6)}`;
                        document.getElementById('gpsAccuracy').innerText = `±${Math.round(accuracy)}m`;

                        const userIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: "<div style='background-color:#2563EB; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.5);'></div>",
                            iconSize: [14, 14],
                            iconAnchor: [7, 7]
                        });

                        if (userMarker) {
                            userMarker.setLatLng([currentLat, currentLng]);
                        } else {
                            userMarker = L.marker([currentLat, currentLng], {icon: userIcon}).addTo(map).bindPopup("Vị trí của bạn");
                            map.setView([currentLat, currentLng], 18);
                        }
                    },
                    (error) => console.warn("GPS Error: " + error.message),
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }
        }

        // --- 4. Compass Logic ---
        function handleOrientation(event) {
            let heading = null;
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            } else if (event.alpha) {
                heading = 360 - event.alpha;
            }

            if (heading !== null) {
                currentHeading = heading;
                document.getElementById('compassHeading').innerText = Math.round(heading) + "°";
                document.getElementById('compassIcon').style.transform = `rotate(${heading}deg)`;
            }
        }

        function requestIOSPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            document.getElementById('requestPermissionBtn').classList.add('hidden');
                        } else { alert('Quyền bị từ chối'); }
                    })
                    .catch(console.error);
            }
        }

        // --- 5. Calculation Logic ---
        function calculateTarget() {
            const distance = parseFloat(document.getElementById('distanceInput').value);

            if (currentLat === null || currentLng === null) {
                alert("Đang chờ tín hiệu GPS...");
                return;
            }
            if (isNaN(distance) || distance <= 0) {
                alert("Vui lòng nhập khoảng cách chính xác.");
                return;
            }

            // Vincenty-ish formula (spherical)
            const R = 6371000; 
            const lat1 = currentLat * Math.PI / 180;
            const lng1 = currentLng * Math.PI / 180;
            const brng = currentHeading * Math.PI / 180;

            const lat2 = Math.asin( Math.sin(lat1)*Math.cos(distance/R) + 
                        Math.cos(lat1)*Math.sin(distance/R)*Math.cos(brng) );
            const lng2 = lng1 + Math.atan2(Math.sin(brng)*Math.sin(distance/R)*Math.cos(lat1), 
                        Math.cos(distance/R)-Math.sin(lat1)*Math.sin(lat2));

            const targetLat = lat2 * 180 / Math.PI;
            const targetLng = lng2 * 180 / Math.PI;

            // Update Map
            if (targetMarker) map.removeLayer(targetMarker);
            if (targetLine) map.removeLayer(targetLine);

            targetMarker = L.marker([targetLat, targetLng], {draggable: true}).addTo(map);
            
            let popupContent = `<b>Điểm mới</b><br>Cách: ${distance}m<br>Hướng: ${Math.round(currentHeading)}°`;
            if(capturedImageBase64) {
                popupContent += `<br><img src="${capturedImageBase64}" style="width:120px; border-radius:4px; margin-top:5px;">`;
            }
            targetMarker.bindPopup(popupContent).openPopup();

            targetLine = L.polyline([[currentLat, currentLng], [targetLat, targetLng]], {color: 'red', dashArray: '5, 10'}).addTo(map);

            const group = new L.featureGroup([userMarker, targetMarker]);
            map.fitBounds(group.getBounds().pad(0.2));

            // Prepare Data for Saving
            // Compress or truncate image for demo if needed. For production, upload to Firebase Storage first.
            const imageToSave = capturedImageBase64 ? (capturedImageBase64.length < 1000000 ? capturedImageBase64 : "image_too_large_skipped") : null;

            lastCalculatedData = {
                user_lat: currentLat,
                user_lng: currentLng,
                target_lat: targetLat,
                target_lng: targetLng,
                azimuth: currentHeading,
                distance: distance,
                image_base64: imageToSave 
            };

            const actionArea = document.getElementById('actionArea');
            actionArea.classList.remove('hidden');
            
            targetMarker.on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                lastCalculatedData.target_lat = position.lat;
                lastCalculatedData.target_lng = position.lng;
                targetMarker.setPopupContent(popupContent + "<br><i>(Đã điều chỉnh vị trí)</i>");
            });

            const saveBtn = document.getElementById('btnSaveFirebase');
            saveBtn.innerHTML = '<i class="fa-brands fa-google-drive mr-2"></i> Lưu vào Firebase';
            saveBtn.classList.remove('bg-green-600');
            saveBtn.classList.add('bg-red-600');
            saveBtn.disabled = false;
            
            saveBtn.onclick = function() {
                if(window.saveToFirestore) {
                    window.saveToFirestore(lastCalculatedData);
                }
            };
        }

        // --- Init ---
        window.onload = function() {
            initMap();
            startGPS();
            
            // Auto-start camera if convenient, or let user click button
            // startCamera(); // Uncomment to start immediately
            
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                document.getElementById('requestPermissionBtn').classList.remove('hidden');
                document.getElementById('requestPermissionBtn').addEventListener('click', requestIOSPermission);
            } else {
                window.addEventListener('deviceorientationabsolute', handleOrientation);
                window.addEventListener('deviceorientation', handleOrientation);
            }
        };
    </script>
</body>
</html>
