<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo Camera Calculator v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        #map { height: 400px; width: 100%; border-radius: 0.5rem; }
        .compass-arrow {
            transition: transform 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-md mx-auto bg-white shadow-lg rounded-xl overflow-hidden">
        
        <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
            <h1 class="font-bold text-lg"><i class="fa-solid fa-map-location-dot mr-2"></i>Geo Calc v1.0</h1>
            <span class="text-xs bg-blue-500 px-2 py-1 rounded">Dev Mode</span>
        </div>

        <div class="p-4 border-b border-gray-200">
            <h2 class="text-sm font-semibold text-gray-500 mb-2 uppercase">1. Cảm biến & Vị trí</h2>
            
            <button id="requestPermissionBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded mb-3 hidden">
                <i class="fa-solid fa-compass mr-2"></i>Cấp quyền La Bàn (iOS)
            </button>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 text-center p-2 rounded border">
                    <div class="text-xs text-gray-500">Độ chính xác GPS</div>
                    <div id="gpsAccuracy" class="font-mono font-bold text-green-600">-- m</div>
                </div>
                <div class="bg-gray-50 text-center p-2 rounded border relative">
                    <div class="text-xs text-gray-500">Hướng (Azimuth)</div>
                    <div id="compassHeading" class="font-mono font-bold text-blue-600">--°</div>
                    <div class="absolute top-1 right-1">
                        <i id="compassIcon" class="fa-solid fa-location-arrow compass-arrow text-gray-300"></i>
                    </div>
                </div>
            </div>
            <div id="gpsCoords" class="text-xs text-center mt-2 text-gray-400 font-mono">Đang chờ GPS...</div>
        </div>

        <div class="p-4 bg-blue-50">
            <h2 class="text-sm font-semibold text-gray-500 mb-2 uppercase">2. Nhập liệu</h2>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ảnh đối tượng</label>
                <div class="flex items-center space-x-2">
                    <label class="flex-1 cursor-pointer bg-white border border-gray-300 rounded py-2 px-3 hover:bg-gray-50 text-center">
                        <i class="fa-solid fa-camera mr-2"></i>Chụp ảnh
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="previewImage(this)">
                    </label>
                </div>
                <img id="imagePreview" class="mt-2 w-full h-32 object-cover rounded hidden border border-gray-300" />
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Khoảng cách tới đối tượng (m)</label>
                <div class="flex">
                    <input type="number" id="distanceInput" placeholder="VD: 50.5" class="flex-1 p-2 border border-gray-300 rounded-l focus:outline-none focus:border-blue-500">
                    <span class="bg-gray-200 text-gray-600 p-2 rounded-r border border-l-0 border-gray-300">mét</span>
                </div>
            </div>

            <button onclick="calculateTarget()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow-lg transform active:scale-95 transition">
                <i class="fa-solid fa-calculator mr-2"></i>Tính toán & Ghim Map
            </button>
        </div>

        <div class="p-4">
            <h2 class="text-sm font-semibold text-gray-500 mb-2 uppercase">3. Bản đồ kết quả</h2>
            <div id="map"></div>
            <div id="resultLog" class="mt-2 text-xs text-gray-600 font-mono bg-gray-100 p-2 rounded max-h-24 overflow-y-auto hidden"></div>
        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };

        // Initialize Firebase (Không kích hoạt Firestore ngay để tránh lỗi nếu chưa config rules)
        const app = initializeApp(firebaseConfig);
        console.log("Firebase initialized for project:", firebaseConfig.projectId);
    </script>

    <script>
        // --- Variables ---
        let map;
        let currentLat = null;
        let currentLng = null;
        let currentHeading = 0;
        let userMarker = null;
        let objectMarkers = [];
        
        // --- Initialization ---
        function initMap() {
            // Default center (Ho Chi Minh City based on context)
            map = L.map('map').setView([10.7769, 106.7009], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        // --- 1. Get GPS Location ---
        function startGPS() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        currentLat = position.coords.latitude;
                        currentLng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        document.getElementById('gpsCoords').innerText = `${currentLat.toFixed(6)}, ${currentLng.toFixed(6)}`;
                        document.getElementById('gpsAccuracy').innerText = `±${Math.round(accuracy)}m`;

                        // Update User Position on Map
                        const userIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: "<div style='background-color:blue; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px black;'></div>",
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        });

                        if (userMarker) {
                            userMarker.setLatLng([currentLat, currentLng]);
                        } else {
                            userMarker = L.marker([currentLat, currentLng], {icon: userIcon}).addTo(map).bindPopup("Vị trí của bạn");
                            map.setView([currentLat, currentLng], 18);
                        }
                    },
                    (error) => {
                        alert("Lỗi GPS: " + error.message);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                alert("Trình duyệt không hỗ trợ GPS.");
            }
        }

        // --- 2. Get Compass Heading ---
        function handleOrientation(event) {
            let heading = null;

            // iOS Webkit
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            } 
            // Android / Standard
            else if (event.alpha) {
                // Check if absolute values are available (Android Chrome)
                heading = 360 - event.alpha; 
            }

            if (heading !== null) {
                currentHeading = heading;
                document.getElementById('compassHeading').innerText = Math.round(heading) + "°";
                document.getElementById('compassIcon').style.transform = `rotate(${heading}deg)`;
            }
        }

        // iOS Permission Handling
        function requestIOSPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            document.getElementById('requestPermissionBtn').classList.add('hidden');
                        } else {
                            alert('Quyền truy cập la bàn bị từ chối');
                        }
                    })
                    .catch(console.error);
            } else {
                // Non-iOS 13+ devices
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        // --- 3. Camera Preview ---
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('imagePreview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 4. Main Calculation (The Math) ---
        function calculateTarget() {
            const distance = parseFloat(document.getElementById('distanceInput').value);

            // Validation
            if (currentLat === null || currentLng === null) {
                alert("Chưa có tọa độ GPS. Vui lòng chờ máy định vị.");
                return;
            }
            if (isNaN(distance) || distance <= 0) {
                alert("Vui lòng nhập khoảng cách hợp lệ.");
                return;
            }

            // --- Geodesy Formula (Destination Point) ---
            const R = 6371000; // Earth Radius in meters
            const lat1 = currentLat * Math.PI / 180;
            const lng1 = currentLng * Math.PI / 180;
            const brng = currentHeading * Math.PI / 180; // Bearing in radians

            const lat2 = Math.asin( Math.sin(lat1)*Math.cos(distance/R) + 
                        Math.cos(lat1)*Math.sin(distance/R)*Math.cos(brng) );
            
            const lng2 = lng1 + Math.atan2(Math.sin(brng)*Math.sin(distance/R)*Math.cos(lat1), 
                        Math.cos(distance/R)-Math.sin(lat1)*Math.sin(lat2));

            // Convert back to degrees
            const targetLat = lat2 * 180 / Math.PI;
            const targetLng = lng2 * 180 / Math.PI;

            // --- Display Result ---
            
            // 1. Add Marker
            const targetMarker = L.marker([targetLat, targetLng]).addTo(map);
            
            // 2. Add Popup with Image if available
            const imgSrc = document.getElementById('imagePreview').src;
            let popupContent = `<b>Đối tượng mới</b><br>Cách: ${distance}m<br>Góc: ${Math.round(currentHeading)}°`;
            if(imgSrc && !document.getElementById('imagePreview').classList.contains('hidden')) {
                popupContent += `<br><img src="${imgSrc}" style="width:100px; margin-top:5px;">`;
            }
            
            targetMarker.bindPopup(popupContent).openPopup();
            
            // 3. Draw line from user to target
            L.polyline([[currentLat, currentLng], [targetLat, targetLng]], {color: 'red', dashArray: '5, 10'}).addTo(map);
            
            // 4. Log
            const logDiv = document.getElementById('resultLog');
            logDiv.classList.remove('hidden');
            logDiv.innerHTML = `<div>New Point: ${targetLat.toFixed(6)}, ${targetLng.toFixed(6)}</div>` + logDiv.innerHTML;

            // Zoom to show both
            const group = new L.featureGroup([userMarker, targetMarker]);
            map.fitBounds(group.getBounds().pad(0.2));
        }

        // --- On Load ---
        window.onload = function() {
            initMap();
            startGPS();

            // Check if iOS to show permission button
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                document.getElementById('requestPermissionBtn').classList.remove('hidden');
                document.getElementById('requestPermissionBtn').addEventListener('click', requestIOSPermission);
            } else {
                window.addEventListener('deviceorientationabsolute', handleOrientation); // Android Chrome
                window.addEventListener('deviceorientation', handleOrientation); // Fallback
            }
        };

    </script>
</body>
</html>
