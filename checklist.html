<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Kiểm Tra An Toàn Điện Tổng Hợp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .checklist-card { margin-bottom: 20px; border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 10px; }
        .checklist-header { background-color: #0d6efd; color: white; padding: 10px 15px; border-radius: 10px 10px 0 0; font-weight: bold; }
        .criteria-text { font-size: 0.85rem; color: #6c757d; font-style: italic; }
        .btn-mic { border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .recording { animation: pulse 1.5s infinite; background-color: #dc3545 !important; border-color: #dc3545 !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .preview-img { max-width: 100px; max-height: 100px; margin-top: 10px; display: none; border: 1px solid #ddd; padding: 2px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-overlay">
        <div class="card p-4" style="width: 90%; max-width: 400px;">
            <h3 class="text-center mb-4 text-primary"><i class="fas fa-hard-hat"></i> KHẢO SÁT AN TOÀN ĐIỆN</h3>
            <div class="mb-3">
                <label class="form-label">Họ và tên người kiểm tra:</label>
                <input type="text" id="userName" class="form-control" placeholder="Nguyễn Văn A">
            </div>
            <div class="mb-3">
                <label class="form-label">Gmail xác thực:</label>
                <input type="email" id="userEmail" class="form-control" placeholder="example@gmail.com">
            </div>
            <div class="mb-3">
                <label class="form-label">Khu vực kiểm tra[cite: 17]:</label>
                <input type="text" id="checkArea" class="form-control" placeholder="Nhà xưởng 1, Trạm biến áp...">
            </div>
            <button class="btn btn-primary w-100" onclick="startChecklist()">BẮT ĐẦU KIỂM TRA</button>
        </div>
    </div>

    <div class="container py-4" id="mainContent" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="fas fa-clipboard-check"></i> CHECKLIST ĐIỆN TỔNG HỢP</h4>
            <div class="text-end" style="font-size: 0.8rem;">
                <div>KTV: <span id="displayUser" class="fw-bold"></span></div>
                <div id="currentDate"></div>
            </div>
        </div>

        <form id="checklistForm">
            <div id="checklistContainer"></div>
        </form>

        <div class="fixed-bottom bg-white p-3 shadow-lg border-top">
            <button class="btn btn-success w-100 py-2 fw-bold" onclick="exportReport()">
                <i class="fas fa-file-export"></i> XUẤT BÁO CÁO & LƯU
            </button>
        </div>
        <div style="height: 80px;"></div> </div>

    <script>
        // Dữ liệu từ file Check lich thiet bi.docx
        const checklistData = [
            {
                title: "1. TỦ ĐIỆN PHÂN PHỐI & ĐIỀU KHIỂN [cite: 18]",
                items: [
                    { id: "1.1", name: "Vỏ tủ & IP", criteria: "Kín khít, ron cao su đàn hồi. Đạt IP quy định." },
                    { id: "1.2", name: "Biển báo an toàn", criteria: "Cửa tủ: 'CẤM LẠI GẦN', Cần gạt: 'CẤM ĐÓNG ĐIỆN'." },
                    { id: "1.3", name: "Sơ đồ mạch", criteria: "Dán sơ đồ đơn tuyến cập nhật mới nhất." },
                    { id: "1.4", name: "Dây dẫn & Đấu nối", criteria: "Đi gọn, đầu cốt không biến màu, có đánh số (Ferrule)." },
                    { id: "1.5", name: "Thiết bị đóng cắt (CB)", criteria: "Không kêu rè rè, không mùi khét, cần gạt linh hoạt." },
                    { id: "1.6", name: "Nối đất (PE)", criteria: "Cửa tủ nối vỏ bằng dây bện. Thanh tiếp địa bắt chặt." },
                    { id: "1.7", name: "Nhiệt độ (Hotspot)", criteria: "∆T < 30oC. Nhiệt độ dây < 70oC." }
                ]
            },
            {
                title: "2. Ổ CẮM ĐIỆN & PHÍCH CẮM CÔNG NGHIỆP [cite: 21]",
                items: [
                    { id: "2.1", name: "Tình trạng vỏ", criteria: "Không nứt vỡ, không cháy sém (move)." },
                    { id: "2.2", name: "Tiếp địa (Chân E)", criteria: "Chân tiếp địa nguyên vẹn, đo thông mạch tốt." },
                    { id: "2.3", name: "Bảo vệ dòng rò (RCCB)", criteria: "Có ELCB/RCBO dòng rò 30mA." },
                    { id: "2.4", name: "Điện áp", criteria: "Đúng danh định (220V/380V ±5%)." },
                    { id: "2.5", name: "Chống nước", criteria: "Khu vực ẩm ướt phải có nắp che (IP44/IP65)." }
                ]
            },
            {
                title: "3. ĐỘNG CƠ ĐIỆN (MOTOR) [cite: 24]",
                items: [
                    { id: "3.1", name: "Cách điện", criteria: "R_cđ ≥ 0.5 MΩ (Megomet 500V)." },
                    { id: "3.2", name: "Hộp cực", criteria: "Kín, ốc siết cáp chặt, không hở lõi đồng." },
                    { id: "3.3", name: "Tiếp địa vỏ", criteria: "Dây PE bắt chặt, không gỉ sét." },
                    { id: "3.4", name: "Phần quay", criteria: "Cánh quạt sạch, lồng bảo vệ nguyên vẹn." },
                    { id: "3.5", name: "Rung & Ồn", criteria: "Độ rung cho phép, bi không kêu." }
                ]
            },
            {
                title: "4. MÁY BIẾN ÁP (MBA) [cite: 27]",
                items: [
                    { id: "4.1", name: "Rào chắn & Cửa", criteria: "Cửa khóa, biển báo 'CẤM VÀO! ĐIỆN ÁP CAO'." },
                    { id: "4.2", name: "Mức dầu & Rò rỉ", criteria: "Dầu đủ vạch, không rò rỉ ra nền." },
                    { id: "4.3", name: "Hạt hút ẩm", criteria: "Màu xanh/cam (Tốt). Màu hồng/trắng (Thay thế)." },
                    { id: "4.4", name: "Sứ cách điện", criteria: "Sạch sẽ, không nứt vỡ, không bám bụi." },
                    { id: "4.5", name: "Nhiệt độ", criteria: "Đồng hồ không vượt vạch đỏ (thường < 80-90oC)." }
                ]
            },
            {
                title: "5. THIẾT BỊ DI ĐỘNG (Máy khoan, mài...) [cite: 30]",
                items: [
                    { id: "5.1", name: "Dây nguồn", criteria: "Không trầy xước, hở lõi. Không đấu băng keo." },
                    { id: "5.2", name: "Phích cắm", criteria: "Có phích chuẩn. Cấm cắm dây trần." },
                    { id: "5.3", name: "Vỏ máy", criteria: "Không nứt vỡ rò điện." },
                    { id: "5.4", name: "Che chắn an toàn", criteria: "Tấm chắn lưỡi cắt còn nguyên." },
                    { id: "5.5", name: "Kiểm tra rò điện", criteria: "Đã dán tem kiểm định (Test tag) định kỳ?" }
                ]
            }
        ];

        // Khởi tạo ứng dụng
        function startChecklist() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const area = document.getElementById('checkArea').value;

            if (!name || !email || !area) {
                alert("Vui lòng nhập đầy đủ thông tin!");
                return;
            }

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('displayUser').textContent = `${name} (${email})`;
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN');

            renderChecklist();
        }

        // Render giao diện checklist
        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            
            checklistData.forEach(section => {
                const sectionHtml = `
                    <div class="card checklist-card shadow-sm">
                        <div class="checklist-header">
                            ${section.title}
                        </div>
                        <div class="card-body">
                            ${section.items.map(item => `
                                <div class="mb-4 border-bottom pb-3">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="fw-bold">Mục ${item.id}: ${item.name}</h6>
                                    </div>
                                    <div class="criteria-text mb-2"><i class="fas fa-info-circle"></i> Tiêu chuẩn: ${item.criteria}</div>
                                    
                                    <div class="btn-group w-100 mb-2" role="group">
                                        <input type="radio" class="btn-check" name="status_${item.id}" id="pass_${item.id}" value="Đạt" checked>
                                        <label class="btn btn-outline-success" for="pass_${item.id}">Đạt</label>

                                        <input type="radio" class="btn-check" name="status_${item.id}" id="fail_${item.id}" value="K.Đạt">
                                        <label class="btn btn-outline-danger" for="fail_${item.id}">K.Đạt</label>
                                    </div>

                                    <select class="form-select form-select-sm mb-2 text-danger" id="risk_${item.id}" style="display:none;">
                                        <option value="">-- Chọn mức độ rủi ro --</option>
                                        <option value="Critical">Nghiêm trọng (Cắt điện ngay)</option>
                                        <option value="Major">Nặng (Sửa 24-48h)</option>
                                        <option value="Minor">Nhẹ (Bảo trì sau)</option>
                                    </select>

                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="note_${item.id}" placeholder="Ghi chú (Nhập hoặc nói)...">
                                        <button class="btn btn-outline-secondary btn-mic" type="button" onclick="toggleVoice('note_${item.id}', this)">
                                            <i class="fas fa-microphone"></i>
                                        </button>
                                    </div>

                                    <div class="d-flex align-items-center">
                                        <label class="btn btn-sm btn-outline-primary me-2">
                                            <i class="fas fa-camera"></i> Chụp ảnh
                                            <input type="file" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'img_${item.id}')">
                                        </label>
                                        <img id="img_${item.id}" class="preview-img" />
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += sectionHtml;
            });

            // Add event listener cho radio button K.Đạt
            document.querySelectorAll('input[type=radio][value="K.Đạt"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const id = this.name.split('_')[1];
                    document.getElementById(`risk_${id}`).style.display = 'block';
                });
            });
             document.querySelectorAll('input[type=radio][value="Đạt"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const id = this.name.split('_')[1];
                    document.getElementById(`risk_${id}`).style.display = 'none';
                    document.getElementById(`risk_${id}`).value = "";
                });
            });
        }

        // Xử lý Voice-to-Text
        function toggleVoice(inputId, btnElement) {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Trình duyệt của bạn không hỗ trợ chức năng nói. Hãy dùng Google Chrome.");
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'vi-VN';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() {
                btnElement.classList.add('recording');
            };

            recognition.onend = function() {
                btnElement.classList.remove('recording');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById(inputId);
                input.value = (input.value + " " + transcript).trim();
            };

            recognition.start();
        }

        // Xử lý xem trước ảnh
        function previewImage(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Xuất báo cáo CSV
        function exportReport() {
            const userName = document.getElementById('userName').value;
            const userEmail = document.getElementById('userEmail').value;
            const area = document.getElementById('checkArea').value;
            const date = new Date().toLocaleDateString('vi-VN');

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += `BÁO CÁO KIỂM TRA AN TOÀN ĐIỆN\n`;
            csvContent += `Người kiểm tra,${userName},Email,${userEmail}\n`;
            csvContent += `Khu vực,${area},Ngày,${date}\n\n`;
            csvContent += "Mã,Hạng mục,Kết quả,Rủi ro,Ghi chú,Có ảnh minh chứng\n";

            checklistData.forEach(section => {
                section.items.forEach(item => {
                    const status = document.querySelector(`input[name="status_${item.id}"]:checked`).value;
                    const risk = document.getElementById(`risk_${item.id}`).value;
                    const note = document.getElementById(`note_${item.id}`).value.replace(/,/g, " "); // Xóa dấu phẩy để không lỗi CSV
                    const hasImg = document.getElementById(`img_${item.id}`).src ? "Có" : "Không";

                    csvContent += `'${item.id},${item.name},${status},${risk},${note},${hasImg}\n`;
                });
            });

            // Tạo link tải về
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `BaoCao_AnToanDien_${date.replace(/\//g,'-')}.csv`);
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
