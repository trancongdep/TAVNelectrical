<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TAVIETNAM Monitor v9.41 (Emergency Fix)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CORE CSS */
        body { margin: 0; padding: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { background: #2c3e50; color: white; padding: 0 15px; height: 50px; display: flex; justify-content: space-between; align-items: center; z-index: 2000; }
        .logo { font-weight: bold; font-size: 16px; color: #f1c40f; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .grid-id-display { font-size: 10px; color: #bdc3c7; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 3px; }
        
        .container { display: flex; flex: 1; overflow: hidden; position: relative; }
        .sidebar { width: 280px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 1500; }
        
        .tab-bar { display: flex; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #f8f9fa; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: #3498db; color: white; }
        
        .device-list { flex: 1; overflow-y: auto; }
        .dev-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .dev-item:hover { background: #f0f0f0; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #95a5a6; }
        
        .main-editor { flex: 1; position: relative; overflow: hidden; background: #ecf0f1; }
        #sld-container, #map-wrapper { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #sld-container { background: radial-gradient(#bdc3c7 1px, transparent 1px) 0 0 / 20px 20px white; cursor: grab; }
        #sld-canvas { position: absolute; transform-origin: 0 0; }
        
        .admin-node { position: absolute; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .node-label { position: absolute; top: 100%; white-space: nowrap; font-size: 10px; background: rgba(255,255,255,0.8); padding: 2px; }
        
        /* SYMBOLS */
        .type-cb { width: 24px; height: 24px; border: 2px solid #333; background: #fff; } 
        .type-cb.closed { background: #d32f2f; } .type-cb.open { background: #2ecc71; }
        .type-ds { width: 30px; height: 30px; } .type-ds::before { content:''; position:absolute; left:50%; height:100%; width:2px; background:#333; } .type-ds::after { content:''; position:absolute; top:50%; left:50%; height:16px; width:3px; background:#333; transform-origin: top center; transition:0.3s; } .type-ds.open::after { transform: rotate(45deg); }
        .type-bus { height: 8px; background: #2c3e50; border-radius: 2px; }
        .type-tr { width: 30px; height: 50px; border: 2px solid #333; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .type-gen { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #e67e22; display:flex; align-items:center; justify-content:center; background:#fff; font-weight:bold; }
        
        /* STATE COLORS */
        .energized-node { background-color: #ffccbc !important; border-color: #d32f2f !important; }
        .type-bus.energized-node { background-color: #d32f2f !important; } /* BUSBAR RED */
        
        .wire { position: absolute; pointer-events: none; z-index: 1; }
        .energized-line { border-color: #d32f2f !important; z-index: 5; }
        .dead-line { border-color: #95a5a6 !important; }
        
        /* CONTROLS */
        .toolbar { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 5px; z-index: 100; }
        .tool-btn { width: 40px; height: 40px; background: white; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 5px; width: 300px; text-align: center; }
        .btn-action { margin-top: 10px; padding: 10px; width: 100%; border: none; cursor: pointer; font-weight: bold; color: white; }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <i class="fas fa-bolt"></i> SCADA v9.41 
        <span id="debug-id" class="grid-id-display">Connecting...</span>
    </div>
    <div style="display:flex; gap:10px">
        <button onclick="hardReset()" style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; font-weight:bold;">♻️ TẢI LẠI LƯỚI</button>
        <span id="clock" style="font-size:12px; align-self:center;">00:00</span>
    </div>
</header>

<div class="container">
    <div class="sidebar">
        <div class="tab-bar">
            <button class="tab-btn active" onclick="showTab('sld')">Sơ đồ</button>
            <button class="tab-btn" onclick="showTab('map')">Bản đồ</button>
        </div>
        <div class="device-list" id="list-container"></div>
        <div id="status-bar" style="padding:5px; font-size:11px; background:#eee; text-align:center;">Đang tải...</div>
    </div>
    
    <div class="main-editor">
        <div id="sld-container">
            <div id="sld-canvas">
                <div id="wire-layer"></div>
                <div id="node-layer"></div>
            </div>
            <div class="toolbar">
                <button class="tool-btn" onclick="zoomFit()"><i class="fas fa-expand"></i></button>
                <button class="tool-btn" onclick="zoom(0.1)"><i class="fas fa-plus"></i></button>
                <button class="tool-btn" onclick="zoom(-0.1)"><i class="fas fa-minus"></i></button>
            </div>
        </div>
        <div id="map-wrapper" style="display:none">
            <div id="map-canvas" style="width:100%; height:100%"></div>
        </div>
    </div>
</div>

<div id="actionModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Điều khiển</h3>
        <div id="modalBody"></div>
        <button class="btn-action" style="background:#7f8c8d" onclick="document.getElementById('actionModal').style.display='none'">Đóng</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f", databaseURL: "https://tavietnam-78ae8-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // VARIABLES
    let allDevices = [];
    let currentGridId = localStorage.getItem('currentGridId') || 'default_grid';
    let currentZoom = 1;
    let selectedId = null;
    
    // MAP
    const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:22});
    const map = L.map('map-canvas', { center: [10.8, 106.6], zoom: 12, layers: [street] });

    // --- CORE FUNCTIONS ---
    
    // 1. HARD RESET
    window.hardReset = () => {
        if(confirm("Xóa bộ nhớ đệm và tải lại lưới mặc định?")) {
            localStorage.removeItem('currentGridId');
            location.reload();
        }
    }

    // 2. LOAD DATA (AUTO FIX GRID ID)
    function initData() {
        // Step 1: Check Valid Grid List
        onValue(ref(db, 'grids_meta'), (snap) => {
            const meta = snap.val();
            if (!meta) {
                console.log("No grids found.");
                return;
            }
            
            // Check if current ID is valid
            if (!meta[currentGridId]) {
                // Invalid ID -> Auto switch to first available grid
                currentGridId = Object.keys(meta)[0];
                localStorage.setItem('currentGridId', currentGridId);
                console.log("Auto-switched to valid grid:", currentGridId);
            }
            
            document.getElementById('debug-id').innerText = `ID: ${currentGridId}`;

            // Step 2: Load Nodes
            onValue(ref(db, `grids/${currentGridId}/nodes`), (dSnap) => {
                const data = dSnap.val();
                allDevices = data ? Object.values(data) : [];
                
                // Debug Info
                document.getElementById('status-bar').innerText = `Thiết bị: ${allDevices.length}`;
                
                // Render
                calculatePower();
                renderList();
                renderSLD();
                
                // Auto Fit first time
                if(allDevices.length > 0 && currentZoom === 1) zoomFit();
            });
        });
    }

    // 3. RENDER LIST
    function renderList() {
        const c = document.getElementById('list-container');
        c.innerHTML = '';
        if (allDevices.length === 0) {
            c.innerHTML = '<div style="padding:20px;text-align:center;color:red">Không có dữ liệu! Hãy bấm Tải lại lưới.</div>';
            return;
        }

        allDevices.forEach(d => {
            // Show typical devices only (hide wires)
            if (['wire','cable'].includes(d.type)) return;

            const div = document.createElement('div');
            div.className = 'dev-item';
            let color = '#95a5a6';
            if (d.isEnergized) color = '#d32f2f';
            if (d.state === 'locked') color = '#f39c12';

            div.innerHTML = `
                <div><b>${d.label || d.id}</b><br><small>${d.type}</small></div>
                <div class="status-dot" style="background:${color}"></div>
            `;
            div.onclick = () => {
                showTab('map');
                if (d.geo) map.flyTo([d.geo.lat, d.geo.lng], 18);
            };
            c.appendChild(div);
        });
    }

    // 4. RENDER SLD
    function renderSLD() {
        const nLayer = document.getElementById('node-layer');
        const wLayer = document.getElementById('wire-layer');
        nLayer.innerHTML = '';
        wLayer.innerHTML = '';

        // Draw Wires First
        allDevices.forEach(d => {
            if (d.parent) {
                const p = allDevices.find(x => x.id === d.parent);
                if (p) drawWire(p, d, wLayer);
            }
        });

        // Draw Nodes
        allDevices.forEach(d => {
            if (d.type === 'pole' && d.showOnSLD === false) return;
            
            const el = document.createElement('div');
            el.className = `admin-node type-${d.type}`;
            el.style.left = (d.sld?.x || 0) + 'px';
            el.style.top = (d.sld?.y || 0) + 'px';
            
            // Width for Busbar
            if (d.type === 'bus') el.style.width = (d.width || 300) + 'px';
            else if (d.rotation) el.style.transform = `rotate(${d.rotation}deg)`;

            // Classes for styling
            if (d.isEnergized) el.classList.add('energized-node');
            if (['cb','ds','fco'].includes(d.type)) el.classList.add(d.state); // open/closed
            if (d.state === 'locked') el.classList.add('locked');
            if (d.type === 'gen' && d.state === 'on') el.classList.add('on');

            // Label
            if (!['wire','cable','bus'].includes(d.type)) {
                const lbl = document.createElement('div');
                lbl.className = 'node-label';
                lbl.innerText = d.label;
                
                // Counter rotate label
                if(d.rotation) lbl.style.transform = `rotate(-${d.rotation}deg)`;
                
                el.appendChild(lbl);
            }

            // Click
            el.onclick = () => openControl(d);

            nLayer.appendChild(el);
        });
    }

    // 5. DRAW WIRE (Simple Orthogonal)
    function drawWire(p, c, layer) {
        let px = p.sld?.x || 0, py = p.sld?.y || 0;
        let cx = c.sld?.x || 0, cy = c.sld?.y || 0;
        
        // Simple Center Calculation
        let pw = (p.type==='bus') ? (p.width||300) : 50; 
        if(['cb','ds'].includes(p.type)) pw=24;
        
        let pCenter = { x: px + pw/2, y: py + 25 };
        let cCenter = { x: cx + 25, y: cy + 25 }; // Approx

        // Color
        let color = '#95a5a6'; // Dead
        // Logic: Hot if Parent is Hot AND Closed (or is Bus) OR Child is Source
        let isParentConducting = true;
        if (['cb','ds','fco'].includes(p.type) && p.state !== 'closed') isParentConducting = false;
        
        if (c.isEnergized || (p.isEnergized && isParentConducting)) color = '#d32f2f';

        // Draw Line (Simplified Direct Line for Stability first, then Z)
        // Using divs for lines
        const line = document.createElement('div');
        line.className = 'wire';
        line.style.borderTop = `2px solid ${color}`;
        
        // Simple bounding box logic for lines (can be improved to Z-shape later)
        // Here we just draw direct to ensure visibility first
        const len = Math.sqrt(Math.pow(cCenter.x - pCenter.x, 2) + Math.pow(cCenter.y - pCenter.y, 2));
        const angle = Math.atan2(cCenter.y - pCenter.y, cCenter.x - pCenter.x) * 180 / Math.PI;
        
        line.style.width = len + 'px';
        line.style.height = '0px';
        line.style.left = pCenter.x + 'px';
        line.style.top = pCenter.y + 'px';
        line.style.transformOrigin = '0 0';
        line.style.transform = `rotate(${angle}deg)`;
        
        layer.appendChild(line);
    }

    // 6. POWER CALCULATION (Bidirectional)
    function calculatePower() {
        // Reset
        allDevices.forEach(n => n.isEnergized = false);
        
        // Sources
        allDevices.filter(n => n.type === 'source' || (n.type === 'gen' && n.state === 'on'))
                  .forEach(n => n.isEnergized = true);
        
        // Flood Fill Loop
        let changed = true;
        let limit = 50;
        while(changed && limit > 0) {
            changed = false;
            limit--;
            allDevices.forEach(child => {
                const parent = allDevices.find(p => p.id === child.parent);
                if (!parent) return;

                // Flow Down
                if (parent.isEnergized && !child.isEnergized) {
                     if (canConduct(parent)) { child.isEnergized = true; changed = true; }
                }
                // Flow Up (Backfeed)
                if (child.isEnergized && !parent.isEnergized) {
                     if (canConduct(child) && canConduct(parent)) { parent.isEnergized = true; changed = true; }
                }
            });
        }
    }

    function canConduct(n) {
        const t = n.type;
        if (['source','bus','wire','pole','tr','load','cable'].includes(t)) return true;
        if (t === 'gen') return n.state === 'on';
        if (['cb','ds','fco'].includes(t)) return n.state === 'closed';
        return false;
    }

    // 7. CONTROLS
    window.openControl = (d) => {
        if (!['cb','ds','fco','gen'].includes(d.type)) return;
        selectedId = d.id;
        const modal = document.getElementById('actionModal');
        const body = document.getElementById('modalBody');
        const title = document.getElementById('modalTitle');
        
        title.innerText = `Điều khiển: ${d.label}`;
        body.innerHTML = '';

        if (d.type === 'gen') {
            if (d.state === 'on') body.innerHTML += `<button class="btn-action" style="background:#e74c3c" onclick="setStatus('off')">DỪNG MÁY</button>`;
            else body.innerHTML += `<button class="btn-action" style="background:#27ae60" onclick="setStatus('on')">KHỞI ĐỘNG</button>`;
        } else {
            if (d.state === 'closed') body.innerHTML += `<button class="btn-action" style="background:#e74c3c" onclick="setStatus('open')">CẮT ĐIỆN</button>`;
            else body.innerHTML += `<button class="btn-action" style="background:#27ae60" onclick="setStatus('closed')">ĐÓNG ĐIỆN</button>`;
        }
        
        if (d.state === 'locked') {
            body.innerHTML = `<p style="color:orange">Đang khóa LOTO!</p><button class="btn-action" style="background:#f39c12" onclick="loto('unlock')">MỞ KHÓA</button>`;
        } else {
            body.innerHTML += `<button class="btn-action" style="background:#f39c12" onclick="loto('lock')">KHÓA AN TOÀN (LOTO)</button>`;
        }

        modal.style.display = 'flex';
    }

    window.setStatus = (s) => {
        update(ref(db, `grids/${currentGridId}/nodes/${selectedId}`), { state: s });
        document.getElementById('actionModal').style.display = 'none';
    }

    window.loto = (action) => {
        const pin = prompt(action === 'lock' ? "Thiết lập mã PIN khóa:" : "Nhập PIN để mở khóa:");
        if (!pin) return;
        
        if (action === 'lock') {
            update(ref(db, `grids/${currentGridId}/nodes/${selectedId}`), { state: 'locked', lotoPin: pin });
        } else {
            // Need to check PIN (simplified here, in real app check against DB value)
            // For now assume correct or master key
            const node = allDevices.find(n => n.id === selectedId);
            if (node.lotoPin && node.lotoPin !== pin && pin !== "9999") {
                alert("Sai mã PIN!");
                return;
            }
            update(ref(db, `grids/${currentGridId}/nodes/${selectedId}`), { state: 'open', lotoPin: null });
        }
        document.getElementById('actionModal').style.display = 'none';
    }

    // ZOOM Helper
    window.zoom = (delta) => { 
        currentZoom += delta; 
        document.getElementById('sld-canvas').style.transform = `scale(${currentZoom})`; 
    }
    window.zoomFit = () => {
        currentZoom = 0.8; // Default fit
        document.getElementById('sld-canvas').style.transform = `scale(${currentZoom})`;
        document.getElementById('sld-container').scrollLeft = 0;
        document.getElementById('sld-container').scrollTop = 0;
    }
    window.showTab = (t) => {
        document.getElementById('sld-panel').style.display = (t==='sld' ? 'block' : 'none');
        document.getElementById('map-wrapper').style.display = (t==='map' ? 'block' : 'none');
        if(t==='map') setTimeout(()=> map.invalidateSize(), 200);
    }
    
    // Init
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    initData();
</script>
</body>
</html>
