<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Mã QR - Ver 2.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* CSS Tùy chỉnh để khôi phục giao diện */
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            background: white;
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        .qr-preview {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
        }
        .btn-primary {
            background-color: #0d6efd;
            border: none;
            padding: 10px 20px;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
        }
        .table img {
            max-width: 80px;
            height: auto;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .version-tag {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .loading-spinner {
            display: none;
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>

<div class="container main-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary"><i class="fa-solid fa-qrcode me-2"></i>Quản Lý Mã QR</h2>
        <span class="badge bg-secondary version-tag">Ver 2.1</span>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="fa-solid fa-plus me-2"></i>Tạo Mã Mới
                </div>
                <div class="card-body">
                    <form id="qrForm">
                        <div class="mb-3">
                            <label for="qrName" class="form-label">Tên mô tả</label>
                            <input type="text" class="form-control" id="qrName" placeholder="Ví dụ: Wifi Tầng 1" required>
                        </div>
                        <div class="mb-3">
                            <label for="qrContent" class="form-label">Nội dung / URL</label>
                            <textarea class="form-control" id="qrContent" rows="3" placeholder="https://..." required></textarea>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="btnCreate">
                                <span class="spinner-border spinner-border-sm loading-spinner me-1" role="status" aria-hidden="true"></span>
                                Tạo & Lưu QR
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-secondary">
                    <i class="fa-solid fa-eye me-2"></i>Xem trước
                </div>
                <div class="card-body">
                    <div id="previewArea" class="qr-preview">
                        <span class="text-muted">Mã QR sẽ hiện ở đây</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-list me-2"></i>Danh sách đã lưu</span>
                    <button class="btn btn-sm btn-light text-primary" onclick="loadQRCodes()">
                        <i class="fa-solid fa-rotate-right"></i> Tải lại
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" width="100">Hình QR</th>
                                    <th scope="col">Thông tin</th>
                                    <th scope="col" width="150">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="qrTableBody">
                                <tr>
                                    <td colspan="3" class="text-center py-4">Đang tải dữ liệu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Cấu hình Firebase của bạn
    const firebaseConfig = { 
        apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
        authDomain: "tavietnam-78ae8.firebaseapp.com", 
        projectId: "tavietnam-78ae8", 
        storageBucket: "tavietnam-78ae8.firebasestorage.app", 
        messagingSenderId: "670121705534", 
        appId: "1:670121705534:web:1027ad98550573ad37116f" 
    };

    // Khởi tạo Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const qrCollection = collection(db, "qr_codes");

    // QR Code API Generator URL (Sử dụng API Google Chart hoặc tương tự để tạo ảnh)
    const generateQRUrl = (text) => `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(text)}`;

    // DOM Elements
    const qrForm = document.getElementById('qrForm');
    const tableBody = document.getElementById('qrTableBody');
    const previewArea = document.getElementById('previewArea');
    const btnCreate = document.getElementById('btnCreate');
    const spinner = document.querySelector('.loading-spinner');

    // Xử lý Form Submit
    qrForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('qrName').value;
        const content = document.getElementById('qrContent').value;
        const imageUrl = generateQRUrl(content);

        // UI Loading
        btnCreate.disabled = true;
        spinner.style.display = 'inline-block';

        try {
            // Xem trước ngay lập tức
            previewArea.innerHTML = `<img src="${imageUrl}" alt="QR Preview" class="img-fluid">`;

            // Lưu vào Firestore
            await addDoc(qrCollection, {
                name: name,
                content: content,
                imageUrl: imageUrl,
                createdAt: serverTimestamp()
            });

            Swal.fire({
                icon: 'success',
                title: 'Thành công!',
                text: 'Đã tạo và lưu mã QR mới.',
                timer: 1500,
                showConfirmButton: false
            });

            qrForm.reset();
            loadQRCodes(); // Tải lại danh sách
        } catch (error) {
            console.error("Lỗi:", error);
            Swal.fire('Lỗi', 'Không thể lưu dữ liệu: ' + error.message, 'error');
        } finally {
            btnCreate.disabled = false;
            spinner.style.display = 'none';
        }
    });

    // Hàm tải danh sách QR
    window.loadQRCodes = async () => {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></td></tr>';
        
        try {
            const q = query(qrCollection, orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            tableBody.innerHTML = ''; // Xóa loading

            if (querySnapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-muted">Chưa có mã QR nào được tạo.</td></tr>';
                return;
            }

            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                
                const row = `
                    <tr>
                        <td>
                            <img src="${data.imageUrl}" alt="QR">
                        </td>
                        <td>
                            <strong>${data.name}</strong><br>
                            <small class="text-muted text-break">${data.content.substring(0, 50)}${data.content.length > 50 ? '...' : ''}</small><br>
                            <small class="text-secondary" style="font-size: 0.75rem;">ID: ${id}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewQR('${data.imageUrl}')" title="Xem lớn">
                                <i class="fa-solid fa-expand"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteQR('${id}')" title="Xóa">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } catch (error) {
            console.error("Lỗi tải data:", error);
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Lỗi tải dữ liệu. Kiểm tra Console.</td></tr>`;
        }
    };

    // Hàm xóa QR
    window.deleteQR = async (id) => {
        const result = await Swal.fire({
            title: 'Bạn chắc chắn chứ?',
            text: "Không thể khôi phục sau khi xóa!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Vâng, xóa nó!',
            cancelButtonText: 'Hủy'
        });

        if (result.isConfirmed) {
            try {
                await deleteDoc(doc(db, "qr_codes", id));
                Swal.fire('Đã xóa!', 'Mã QR đã bị xóa.', 'success');
                loadQRCodes();
            } catch (error) {
                Swal.fire('Lỗi', 'Không thể xóa: ' + error.message, 'error');
            }
        }
    };

    // Hàm xem ảnh lớn
    window.viewQR = (url) => {
        Swal.fire({
            imageUrl: url,
            imageWidth: 300,
            imageHeight: 300,
            imageAlt: 'QR Code Image',
            showCloseButton: true,
            showConfirmButton: false
        });
    };

    // Tải dữ liệu khi trang web load
    loadQRCodes();

</script>

</body>
</html>
